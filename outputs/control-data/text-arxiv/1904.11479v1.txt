A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH
IWAHORI LEVEL STRUCTURES
HAO LI

arXiv:1904.11479v1 [math.NT] 25 Apr 2019

A BSTRACT. In this paper Iâ€™m going to study the intersection of two Heegner-Drinfeld cycles coming from two different nonsplit tori on the Yun-Zhang moduli stack of PGL2 Drinfeld stukas with
Iwahori level structure. We will see that the intersection number is related to a certain period
integral. It is an extension of the result by Howard-Shinidman to the Iwahori case.

1. I NTRODUCTION
In their secomd volumn[7], Yun-Zhang generalized their previous work[6] to the moduli
stack of shtukas with Iwahori level structure and Heegner-Drinfeld cycles coming from a double cover with ramification points away from the level. A natural question is whether one can
do a similar thing for Heegner-Drinfeld cycles coming from two different double covers, i.e. relating the intersection number of two Heegner-Drinfeld cycles attached to two different double
covers (or rather their certain Hecke eigen-parts) with automorphic L-functions with Iwahori
levels, like what Howard and Shnidman did previously in the no level structure case[4]. This
case can be viewed as a function field analogue of the Gross-Kohnen-Zagier formula[2].
In this paper I will give the answer to this question in the case where the two double covers
are still everywhere nonramified. Let p be a prime number greater than 2, k a finite field of
characteristic p with cardinality q (i.e. Fq ). Let X be a smooth geometrically connected curve
over k of genus g with F its field of rational functions. Take two everywhere nonramified double
covers Y1 and Y2 of X, and let Y = Y1 Ã— X Y2 be the associated fourfold cover X. Then there exists
a unique third double cover over X, Y3 , below Y different from Y1 and Y2 , and they fit into the
following diagram:
Y
Ï€1

Y1

~

Ï€3

(1.1)
Ï€2


Y3
Î½1

Î½3

 ~
X

Y2
Î½2

The generic fiber of this diagram gives the field extension diagram:
K
Ï€1

K1

Ï€3

(1.2)
Ï€2


K3
~

Î½1

Î½3

 ~
F

K2
Î½2

ei =
Let A be the adelic ring of F and Ai be the adelic ring of Ki for i = 1, 2, 3. Also let T
Ã—
Ã—
Ã—
ei /Gm,X . Then one has T
ei ( F ) = K and Ti ( F ) = K /F .
ResYi /X Gm,Yi and Ti = T
i
i
Let Î£ âŠ‚ | X | be a finite set of physical points of X of total degree N, this will be the â€œlevelâ€.
Like what Yun and Zhang did in their second volumn, one needs to consider the splitting
Date: April 22, 2019.
1

2

HAO LI

behavior of points in Î£ in the double covers. In order to make the question under consideration
here meaningful, I require the following: there exist a partition of Î£:
Î£ = Î£ f t Î£âˆ
such that: Any x âˆˆ Î£ f splits in both Y1 and Y2 , and any x âˆˆ Î£âˆ is inert in both the double
covers. Let Sâˆ = âˆ xâˆˆÎ£ Speck x and G = PGL2,X . Yun-Zhang defined the moduli of shtukas
with Iwahori level structures ShtrG (Î£; Î£âˆ ). It is a smooth Deligne-Mumford stack of dimension
2r equipped with a map:
Î rG : ShtrG (Î£; Î£âˆ ) âˆ’â†’ X r Ã—k Sâˆ
0 , S0
To define the Heegner-Drinfeld cycle for Y1 , Y2 , one needs something similar to Sâˆ : S1,âˆ
2,âˆ
e âˆ . They are all zero dimensional schemes over k and fit into the following diagram:
and S

eâˆ
S

0
S1,âˆ

}

!
0
S2,âˆ
!

Sâˆ

}

e âˆ needs some explainaI refer you to section 2.6 for the precise meaning of them because S
tion. Also, one needs a choice of auxilary data: Âµ := (Âµ, Âµ f , Âµâˆ ) âˆˆ {Â±1}r Ã— {Â±1}Î£ f Ã— {Â±1}Î£âˆ .
Âµ

0 )
With its help , one can define a smooth Deligne-Mumford stack of dimesion r, Sht T (Âµâˆ Â· Î£i,âˆ
i
equipped with a map:
Âµ

0
0
) âˆ’â†’ Yir Ã—k Si,âˆ
Sht T (Âµâˆ Â· Î£i,âˆ
i

For i = 1, 2. For some technical reasons, I will consider the following intersection problem: Let
e âˆ (k ), consider the following morphism:
Î¾âˆˆS
Âµ

0
Sht T (Âµâˆ Â· Î£i,âˆ
) Ã—S0 Î¾ âˆ’â†’ ShtrG (Î£; Î£âˆ ) Ã—Sâˆ Î¾
i

i,âˆ

Âµ
Zi ( Î¾ )

Let
be the push foward of the fundamental cycle of the left hand side along this morphism.
Yun-Zhang proved the following â€œcoarse spectral decompositionâ€ of the total cohomology
of ShtrG (Î£; Î£âˆ ) ([7], Theorem 3.41) (By total cohomology I mean not the cohomology of the
generic fiber): Let V (Î¾ ) = Hcr (ShtrG (Î£; Î£âˆ ) Ã—Sâˆ Î¾, Ql ), then one has the decompostion:
V (Î¾ ) âŠ— Ql = V (Î¾ )Ï€ âŠ• (VEis (Î¾ ) âŠ— Ql )
In which Ï€ runs through all the automorphic representations of PGL2,F with Iwahori level at
Âµ
Âµ
Î£. Let Zi,Ï€ be the projection to the Ï€-th part of the cycle class of Zi .
e3 = GL2,Î½ O be the X-group scheme whose functor of
Following Howard-Shnidman, let G
âˆ—

Y3

e3 /Z ( G
e3 ).
points on an X-scheme f : U âˆ’â†’ X is given by H 0 (U, EndOU ( f âˆ— (Î½âˆ— OY3 )) and G3 = G
Then T3 is canonically sitting inside G3 . Itâ€™s generic fiber is isomorphic to the generic fiber
of PGL2,X though they are different X-schemes. The choice of auxilary data (Âµ f , Âµâˆ ) above
determines an isomorphism:
âˆ¼

G3 (A) âˆ’
â†’ G (A)
Let Ï€ be an automorphic representation of G (A) and Ï† âˆˆ Ï€. Using the above isomorphism,
Ï€3

one can view Ï† as an automorphic form on G3 (A), denoted by Ï†3 . The double cover Y âˆ’â†’ Y3
determines a quadratic character Î· of T3 (A) = A3Ã— /AÃ— . Then it is legitimate to define the
following global period integral of Ï†:
P0 (Ï†, s) =

Z
[ A]

Ï†(t0 )|t0 |s dt0

P3 (Ï†, s) =

Z
[ T3 ]

Ï†3 (t3 )Î· (t3 )dt3

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

3

In which A is the standard diagonal torus of G, [ A] = A( F )\ A(A) and [ T3 ] = T3 ( F )\ T3 (A).
Then the first main result is the following:
Theorem 1.1. Fix the choice of Âµ = (Âµ, Âµ f , Âµâˆ ) and Î¾ and N = degÎ£ as above. Let Ï€ be an automorphic represetation of G (A) with Iwahori level at Î£. Let Ï† âˆˆ Ï€ be the vector whose local components are
hyperspecial fixed away from Î£ and Iwahori fixed at Î£. Then one has:

( Z1,Ï€ (Î¾ ), Z2,Ï€ (Î¾ )) = (logq)âˆ’r (
Âµ

Âµ

P0 (Ï†, s)P3,Î· (Ï†3 )
d r
) |s=0 (q Ns
)
ds
hÏ†, Ï†i

Let Ï‡1 and Ï‡2 be quadratic characters of AÃ— determined by the double covers Y1 and Y2
respectively. Let L(Ï€ âŠ— Ï‡1 , s) and L(Ï€ âŠ— Ï‡2 , s) be the twisted L-functions. Also, one defines
L (Ï€, s) = q2gâˆ’2+ N L(Ï€, s) to be the normalized L-function. The period integral is actually
related to the product of these L-functions, as in the case worked out by Howard-Shnidman.
This leads to the following corollary.
Theorem 1.2. In the notations as above, one has:
Âµ

Âµ

( Z1,Ï€ (Î¾ ), Z1,Ï€ (Î¾ )) = 0
is equivalent to:
L (r) (Ï€, 1/2) Â· L(Ï€ âŠ— Ï‡1 , 1/2) Â· L(Ï€ âŠ— Ï‡2 , 1/2) = 0
Also, in their paper, Howard and Shnidman computed the plain pairing of the two cycles,
i.e. without projecting to the Ï€-th eigenpart ([4], Theorem C). Here one also has a slightly
different result:
Theorem 1.3. Again, with the notations above,
Âµ

Âµ

( Z1 (Î¾ ), Z2 (Î¾ )) = 0
For the precise meaning of those symbols, please go to the main body of the paper.
The method of proof basically follows the philosophy of Yun-Zhang, with some technical ingredients from Howard-Shnidman. In the second section Iâ€™m going to review the moduli stack
of shtukas with Iwahori level structure defined by Yun and Zhang, and introduce the HeegnerDrinfeld cycles to be used in this paper. The third section is devoted to the construction of the
auxilary moduli spaces, which Yun calls â€œthe Hitchin type moduli spacesâ€[5]. In the fourth
section the intersection pairing is computed by applying the Grothendieck-Lefschetz trace formula to the relative cohomology of the â€œHitchin type fiberationâ€. Then Iâ€™ll move to the analytic
side of the picture, relating the geometric side of the relative trace formula with the relative
cohomology of a certain local system for the â€œdual Hitchin type fiberationâ€. Then the main result would follow from comparing the cohomological side of the two Grothendieck-Lefschetz
formulae. Iâ€™m also going to prove the other two theorems in the last section.
The reason I still work with everywhere nonramified covers is that I will use descent along
torsors in section 3. In the more general case in which the covers are ramified at some points
away from the level, I hope the more general fppf-descent can work. Iâ€™ll probably return to this
topic later.
2. T HE SHTUKA SIDE SET UP
In this section I review Yun-Zhangâ€™s definition of moduli of shtukas with Iwahori level structure and define the Heegner-Drinfeld cycles with which Iâ€™m going to work later.
2.1. Splitting behavior of Î£ in Y3 . Recall Y1 , Y2 and Y3 are the three everywhere nonramified
double covers in the introduction. Y is the associated fourfold cover and Î£ be the set of closed
point in | X | satisfying following condition:
Î£ = Î£ f t Î£âˆ
and any x âˆˆ Î£ f splits in both Y1 and Y2 , and any x âˆˆ Î£âˆ is inert in both the double covers. One
also needs to know the splitting behavior of each x âˆˆ Î£ in Y3 . Actually , by an easy exercise of
class field theory, one has the following:

4

HAO LI

Proposition 2.1. All the points in Î£ split in Y3 .
Then we have the following complete description of the splitting behavior of x âˆˆ Î£ in all the
covers:

â€¢ Each x âˆˆ Î£ f has two physical points (just prime ideals) over it in each Yi for i = 1, 2, 3,
and four points over it in the top cover Y. Let y x , y0x be the two points over x in Y1 ,
z x , z0x be the two points over x in Y2 . Then one can denote the four preimages of x in
Y by (y x , z x ), (y0x , z x ), (y x , z0x ), (y0x , z0x ). Then let wx be the point in Y3 below (y x , z x ) and
(y0x , z0x ), w0x be the point below (y0x , z x ), (y x , z0x ).
â€¢ Each point x âˆˆ Î£âˆ has one physical point with residue extension of degree 2 in each
Yi , i = 1, 2. Each of these points over x is split in the top cover, so two physical points
above. x has two physical points above it in Y3 , and these two points are both inert in
Y.
2.2. Review of the moduli of G-torsor over a curve with Iwahori level structures. In their
second volume, Yun and Zhang defined the moduli stack of G-torsors over X with Iwahori
level structure at Î£ ([7], section 3.1). First, let Bun2 (Î£) be the functor from the category of
k-schemes to the category of groupoids whose S points are the following:
1
E â€  = (E , {E (âˆ’ )} xâˆˆÎ£ )
2
in which:

â€¢ E is a rank 2 vector bundle over the product X Ã—k S.
â€¢ For each x âˆˆ Î£, a rank 2 vector bundle E (âˆ’ 12 x ) who fits into the following chain of
coherent sheaves:
1
E âŠƒ E (âˆ’ x ) âŠƒ E (âˆ’ x ) := E âŠ— O X (âˆ’ x )
2
such that the quotient sheaf E /E (âˆ’ 21 x ) is a skycrayper sheaf supported on the subscheme
{ x } Ã— S.
Let Pic X be the Picard stack of X, i.e. the stack whose S points are line bundles over X Ã—k S.
Pic X acts Bun2 (Î£) by simultenously twisting E and all E (âˆ’ 12 x ). Then BunG (Î£) is defined to be
the quotient:
Bun2 (Î£)/Pic X
Of course, they defined these stacks for general GLn and PGLn , and their definition can be
easily extended to arbitrary parahoric level structures, but here I only work with n = 2, so I just
review this simpler case.
Actually the dimension of BunG (Î£) is well known:
Proposition 2.2. BunG (Î£) is an Artin stack of dimension 3( g âˆ’ 1) + N
One already knows that the plain BunG is of dimension is 3( g âˆ’ 1), the Iwahori level structure just â€addsâ€ N copies of P1k to it, hence the above number.
2.3. Fractional twists and Atkin-Lehner involution. To define the moduli of shtukas with
level structures, Yun-Zhang introduced fractional twists and Atkin-Lehner involution for vector bundles with Iwahori level structures ([7], Definition 3.2). Again, I only review what I need
here, for the more general cases, you can just go to read their paper.
First we define:
Sâˆ = âˆ Speck x
x âˆˆÎ£

An S point of Sâˆ is simply a set of maps: x (1) âˆ’â†’ Speck x for each x âˆˆ Î£âˆ . Let x (i+1) =
x (i) â—¦ FrS . Let d x = [k x : k], we get d x maps from S to Speck x .
As in their paper, one has the canonical point:
x(1) : Sâˆ âˆ’â†’ Speck x âˆ’â†’ X

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

5

for each x âˆˆ Î£âˆ . It is simply projection followed by injection. Let x(2) = x(1) â—¦ FrSâˆ . Let Î“x(i)
be the graph of x(i) . Then we have the following:
dx

Speck x Ã—k Sâˆ =

Ã¤ Î“ x( i )

i =1

Take an S point E â€  , of Bun2 (Î£) Ã— Sâˆ . Then S acquires a k x structure for each x âˆˆ Î£âˆ . Therefore
we have:
dx

Speck x Ã—k S =

Ã¤ S (i )

i =1

S (i )

x (i ) .

In which
is the image of
By the definition of E â€  , E /E (âˆ’ 12 x ) is supported on these d x copies of Ss, therefore splits into
( j)

( j)

a direct sum âŠ•dj=x 1 Li , where Li

is supported on the j-th copy of S, S( j) .

( j)

( j)

Let D = âˆ‘ xâˆˆÎ£âˆ âˆ‘1â‰¤ jâ‰¤dx c x x(1) , In which all c x âˆˆ 12 Z. Yun and Zhang defined the fractional
twist by D of E â€  as follows: First define:
1
1
( j) 
E (âˆ’ x ( j) ) := ker E âˆ’â†’ E /E (âˆ’ x ) âˆ’â†’ Li
2
2
Then for any D as above, first rewrite it as D = D0 âˆ’ D1 , in which D0 is an integral divisor on
( j)

( j)

X Ã—k Sâˆ and D1 = âˆ‘ xâˆˆÎ£âˆ âˆ‘1â‰¤ jâ‰¤dx ix2 x ( j) x(1) in which each i x is either 0 or 1. Define E (âˆ’ D1 )
as the kernel of the following direct sum of projections:

E âˆ’â†’ âŠ• xâˆˆÎ£âˆ ,1â‰¤ jâ‰¤dx E /E (âˆ’

( j)
ix 
)
2

Then define E ( D ) := E (âˆ’ D1 ) âŠ—OXÃ— Sâˆ OOXÃ— Sâˆ . For E (âˆ’ 12 x ), apply the same operation to the
k
k
chain:
1
E (âˆ’ x ) âŠƒ E (âˆ’ x )
2
1
One can get the corresponding E ( D )(âˆ’ 2 x ). This process defines the following map:
f ( D ) : Bun2 (Î£) Ã—k Sâˆ âˆ’â†’ Bun2 (Î£)
AL

(2.1)

quotient out the simultenous twisting by Pic X , one has the follow:
AL( D ) : BunG (Î£) Ã—k Sâˆ âˆ’â†’ BunG (Î£)
This is the Atkin-Lehner involution of BunG (Î£).
As in their paper, for the moduli of shtukas to be used later, one only cares about the case
(1)

(1)

Dâˆ = âˆ‘ xâˆˆÎ£âˆ 12 x(1) , and the Atkin-Lehner involution by âˆ’ Dâˆ . Again let E â€  be an S point of
Bun2 (Î£). Then we simply have:
1
(1)
E (âˆ’ Dâˆ ) = ker E âˆ’â†’ E (âˆ’ x (1) ))
2
i.e.The sections of E who is belong to E (âˆ’ 21 ) on the first copy of S, S(1) .
2.4. The Hecke stack. To define moduli of shtukas, one also has to review the Hecke stack for
BunG (Î£) ([7], Definition 3.3).
Let r be a nonnegative integer, and let Âµ = (Âµ1 , ..., Âµr ) âˆˆ {Â±1}r .
Âµ

Definition 2.3. Let Hk2 (Î£) be the stack over k whose S-points is the following:

â€¢ A sequence of r + 1 rank 2 vector bundles with Iwahori level structure: Eiâ€  = (Ei , {Ei (âˆ’ 21 x )} xâˆˆÎ£ ) âˆˆ
BunG (Î£)(S) in which i = 0, 1, ..., r.
â€¢ r morphisms xi : S âˆ’â†’ X for i = 1, ..., r, with the graph Î“ xi âŠ‚ X Ã—k S.

6

HAO LI

â€¢ Isomorphism of vector bundles
âˆ¼

f i : E i âˆ’1 | X Ã— k S âˆ’ Î“ x âˆ’
â†’ Ei | X Ã—k Sâˆ’Î“ x
i

i

for i = 1, ..., r, such that the induced relative position on the formal neighbourhood of
Î“ xi is Âµi , and f i respects the filtration given by Eiâˆ’1 (âˆ’ 12 x ) and Ei (âˆ’ 21 x ) for all x âˆˆ Î£.
Âµ

Âµ

Let Hk G (Î£) := Hk2 (Î£)/Pic X .
Âµ

From the definition, one has the projections from Hk2 to X r recording the points of modifications xi (people call them pattes, recently the term â€œlegsâ€ becomes popular). Also, to record
the ith bundle with Iwahori level structure Eiâ€  , one has the following projections:
Âµ

pei : Hk2 (Î£) âˆ’â†’ Bun2 (Î£)
for i = 0, ..., r. Again, quotient out the simultanous twist by Pic X , we get the following:
Âµ

pi : Hk G (Î£) âˆ’â†’ BunG (Î£)
Yun and Zhang proved the following geometric properties of the Hecke stacks ([7], Proposition
3.4).
Âµ

Proposition 2.4.
(1) For 0 â‰¤ i â‰¤ r, the projection map pei : Hk2 (Î£) âˆ’â†’ Bun2 (Î£) is smooth of
relative dimension 2r.
Âµ
Âµ
(2) For 0 â‰¤ i â‰¤ r, the morphism ( pei , Ï€ H k ) : Hk2 (Î£) âˆ’â†’ Bun2 (Î£) Ã—k X r is smooth of relative
dimension r when restricted to Bun2 (Î£) Ã—k ( X âˆ’ Î£)r .
Âµ
Âµ
(3) For 0 â‰¤ i â‰¤ r, the morphism ( pei , Ï€ H k ) : Hk2 (Î£) âˆ’â†’ Bun2 (Î£) Ã—k X r is flat of relative
dimension r.
Âµ
(4) All of the above hold for Hk G (Î£) and Bun G (Î£).
These properties are needed later.
2.5. The moduli of shtukas. Now we are ready to review the definition of the moduli of
(i )

shtukas ([7], section 3.2). First define the moduli of shtukas for GL2 . Let Dâˆ = {âˆ‘ xâˆˆÎ£âˆ ,1â‰¤ jâ‰¤dx c x x(1) :
( j)

ci âˆˆ 12 Z}. Take a Âµ âˆˆ {Â±1}r . To define the moduli of stukas attached to Dâˆ âˆˆ Dâˆ and Âµ, one
furthur requires the following condition:
r

âˆ‘ Âµi =

i =1

âˆ‘

x âˆˆÎ£âˆ ,1â‰¤ jâ‰¤d x

cix = 2degDâˆ

(2.2)

Once one sees the following definition of the moduli of shtukas, it is clear why there should be
such a relation.
Âµ

Definition 2.5. Define the stack Sht2 (Î£; Dâˆ ) as the following Cartesian diagram:
/ HkÂµ (Î£) Ã—k Sâˆ
2

Âµ

Sht2 (Î£; Dâˆ )


( pe0 ,AL(âˆ’ Dâˆ )â—¦( per Ã—idSâˆ ))

Ï‰0

Bun2 (Î£)

(2.3)

(id,Fr )


/ Bun2 (Î£) Ã— Bun2 (Î£)

Âµ

More precisely, an S point of Sht2 (Î£; Dâˆ ) consists of the following data:

â€¢ A map: S âˆ’â†’ Sâˆ , which gives x (1) : S âˆ’â†’ Speck x for each x âˆˆ Î£âˆ ;
â€¢ r morphisms xi : S âˆ’â†’ X for i = 1, ..., r, with the graph Î“ xi âŠ‚ X Ã—k S.
â€¢ A sequence of modifications, which starts at E0â€  and â€ends atâ€ Ï„ E0 ( Dâˆ ):
E0

f1

/ E1

f2

/ ......

fr

/ Er

Î¹

/ Ï„ E 0 ( Dâˆ )

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

7

each f i is a modification from Eiâˆ’1 to Ei of relative position Âµi around Î“ xi , respecting the
filtration as in the definition of the Hecke stack, and Î¹ at the end is an isomorphism. Ï„ E0
is the pull back of E0 along the map:
id X Ã— FrS

X Ã—k S âˆ’âˆ’âˆ’âˆ’â†’ X Ã—k S
Now the restriction above is clear: Modification by f i changes the degree by Âµi , therefore:
r

âˆ‘ Âµi

degÏ„ E0 ( Dâˆ ) âˆ’ degE0 =

i =1

This implies that one must have the above restriction, because otherwise the stack would be
empty.
Define the moduli of shtukas for G as the quotient by the discrete groupoid Pic X (k):
Âµ

Âµ

ShtG (Î£; Dâˆ ) = Sht2 (Î£; Dâˆ )/Pic X (k)
Then it fits into the following Cartesian diagram:
/ HkÂµ (Î£) Ã—k Sâˆ
G

Âµ

ShtG (Î£; Dâˆ )


Let

Âµ

( pe0 ,AL(âˆ’ Dâˆ )â—¦( per Ã—idSâˆ )

Ï‰0

BunG (Î£)

(2.4)

(id,Fr )

Âµ


/ BunG (Î£) Ã— BunG (Î£)
Âµ

Î G,Dâˆ = (Ï€G , Ï€G,âˆ ) : ShtG (Î£; Dâˆ ) âˆ’â†’ X r Ã—k Sâˆ

(2.5)

be the map recording the points of modification and the Sâˆ structure of S.
Âµ
Yun and Zhang proved the following properties of ShtG (Î£; Dâˆ ) ([7], Proposition 3.9):
Âµ

(1) The stack Sht G (Î£; Dâˆ ) is Deligne-Mumford of dimension 2r.

Proposition 2.6.
Âµ

Âµ

(2) Î G,Dâˆ = (Ï€G , Ï€G,âˆ ) is separated, and is smooth of relative dimension r when restricted to
( X âˆ’ Î£ ) r Ã— Sâˆ
Recall that we have fixed a rational divisor on the scheme X Ã—k Sâˆ , Dâˆ = âˆ‘ xâˆˆÎ£ 12 x(1) . Define:
Âµ
Âµ
ShtG (Î£; Î£âˆ ) := ShtG (Î£; Dâˆ )
(2.6)
For the following rs, Âµs and Dâˆ s:
r = #Î£âˆ mod2

Dâˆ âˆˆ Dâˆ , and

r

âˆ‘ Âµi = 2degDâˆ

(2.7)

i =1

They proved that for the above Dâˆ s, the Atkin-Lehner involutions:
AL(âˆ’ Dâˆ ) : BunG (Î£) Ã—k Sâˆ âˆ’â†’ BunG (Î£)

(2.8)

(1)
AL(âˆ’ Dâˆ )

f (âˆ’ Dâˆ )), and the right hand side of (2.6) is
all agree with
(of course not for AL
independent of choice of Âµ and Dâˆ as long as the above conditions are satisfied.
2.6. Hecke correspondence for moduli of shtukas. Now review the Hecke correspondences
([4], section 3.3). Letâ€™s define the partial spherical Hecke algebra as the following:
HGÎ£ = âŠ— xâˆˆ| X âˆ’Î£| Hx

(2.9)

in which Hx is the local spherical Hecke algebra with Q coefficients. It has a basis indexed by
the group of effective divisors of X âˆ’ Î£, i.e. Div+ ( X âˆ’ Î£).
Let D âˆˆ Div+ ( X âˆ’ Î£) be an effective divisor, then define the associated â€vertical Hecke
modificationâ€ stack as follows:
Âµ

Definition 2.7. Sht2 (Î£; Dâˆ ; h D ) is the functor from kâˆ’schemes to groupoids whose category of
S points is the following data:

â€¢ A map: S âˆ’â†’ Sâˆ , which gives x (1) : S âˆ’â†’ Speck x for each x âˆˆ Î£âˆ ;
â€¢ r morphisms xi : S âˆ’â†’ X for i = 1, ..., r, with the graph Î“ xi âŠ‚ X Ã—k S.

8

HAO LI

Âµ

â€¢ Two of the points of Sht2 (Î£; Dâˆ )(S), say (Eiâ€  , f i , Î¹, ...) and (Ei0â€  , f i0 , Î¹0 , ...) sharing the
above data, i.e. map to the same point in Sâˆ , points of modifications xi , together with
injections of coherent sheaves Ï†i , fitting into the following diagram:
f1

E0
Ï†0

/ E1

f2

/ ......

fr

/ ......

f r0

/ Er

Ï†1


E00

f 10


/ E0
1

/ Ï„ E 0 ( Dâˆ )

Î¹

Ï†r

f 20


/ Er0



Î¹0

(2.10)

Ï„Ï†
0

/ Ï„ E 0 ( Dâˆ )
0

such that each Ï†i preserves the Iwahori level structure (i.e. sending E (âˆ’ 21 x ) to E 0 (âˆ’ 12 x )
for all x âˆˆ Î£); the induced maps Ï†i : det(Eiâˆ’1 ) âˆ’â†’ det(Ei ) has divisor D Ã—k X âŠ‚ X Ã—k S.
As usual, define:
Âµ

Âµ

ShtG (Î£; Î£âˆ ; h D ) := Sht2 (Î£; Dâˆ ; h D )/Pic X (k)

(2.11)

and the map recording the points of modifications and Sâˆ -structure:
Âµ

Î rG (h D ) : ShtG (Î£; Î£âˆ ; h D ) âˆ’â†’ X r Ã—k Sâˆ
Âµ

By definition, it is a self-correspondence of ShtG (Î£; Î£âˆ ; h D ) over X r Ã—k Sâˆ , i.e. one has the
following diagram:
Âµ

â†
âˆ’
p

ShtG (Î£; Î£âˆ ; h D )

(2.12)
âˆ’
â†’
p

w
Âµ
ShtG (Î£; Î£âˆ )

'
Âµ
ShtG (Î£; Î£âˆ )
(
v
X r Ã— k Sâˆ

It has the following properties:
Proposition 2.8. Let D âˆˆ Div+ ( X âˆ’ Î£).
âˆ’
â†’
(1) Both â†
p and âˆ’
p are proper and representable;
âˆ’
â†’
(2) Over ( X âˆ’ Î£)r , both of â†
p and âˆ’
p are fintie eÌtale;
Âµ

(3) The fibers of Î rG (h D ) : ShtG (Î£; Î£âˆ ; h D ) âˆ’â†’ X r Ã—k Sâˆ have dimension r.
For the detail of the proof, one just reads Yun-Zhangâ€™s second volume.
These Hecke correspondences induces the following ring homomorphisms:
Proposition 2.9. One can extend the map:
Âµ
âˆ’
â†’
h D âˆ’â†’ (â†
p Ã—âˆ’
p )âˆ— ShtG (Î£; Î£âˆ ; h D )

(2.13)

HGÎ£ âˆ’â†’ c Ch2r (ShtG (Î£; Î£âˆ ) Ã— ShtG (Î£; Î£âˆ ))Q

(2.14)

to a ring homomorphism:
Âµ

Âµ

which in turn allow HGÎ£ to act on the group of compactly supported Chow cycles.
2.7. The Heegner-Drinfeld cycles. Now we define the Heegner-Drinfeld cycles for Y1 and Y2 ,
with some auxilary choice of data.
As one has seen in the last section, over a certain point x âˆˆ Î£âˆ , there is one point over it in
each Yi , i = 1, 2 respectively, which we denoted y x , z x , and there are two points over it in Y. We
choose one of these two points for each x âˆˆ Î£âˆ and denoted it by v x , and call the other point by

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

9

v0x . The corresponding points below them in Y3 are denoted by wx and w0x respectively. Then
define the following:
S0âˆ,1 = Î  xâˆˆÎ£ Speck yx
S0âˆ,2 = Î  xâˆˆÎ£ Speck zx
e âˆ = Î  xâˆˆÎ£ Speck vx
S
From the definition, one can see that there are cononical maps:
e âˆ = Î  xâˆˆÎ£ Speck vx âˆ’â†’ S0âˆ,1 = Î  xâˆˆÎ£ Speck yx ;
S
e âˆ = Î  xâˆˆÎ£ Speck vx âˆ’â†’ S0âˆ,2 = Î  xâˆˆÎ£ Speck zx
S
(1)

(1)

(1)

Similar to the case of Sâˆ , denote the following by yx , zx , vx :
S0âˆ,1 âˆ’â†’ Speck yx âˆ’â†’ Y1
S0âˆ,2 âˆ’â†’ Speck zx âˆ’â†’ Y2
e âˆ âˆ’â†’ Speck vx âˆ’â†’ Y
S
in which the first arrows are the projection and the second arrows are the natural injections.
( i âˆ’1)

(i )

( i âˆ’1)

(i )

Similar to x(i) , define yx = yx
â—¦ FrS0 , zx = zx
âˆ,1
has the following decomposition:

( i âˆ’1)

(i )

â—¦ FrS0 , vx = vx
âˆ,2

â—¦ FrSe âˆ . Then one

e âˆ = Ã¤2dx Î“ (i)
Speck vx Ã—k S
i =1 v
x

t
x
Speck yx Ã—k S0âˆ,1 = Ã¤2d
i =1 Î“ y( i )

*
x
Speck zx Ã—k S0âˆ,2 = Ã¤2d
i =1 Î“ z( i )

x

x

*
t
Speck x Ã—k Sâˆ = Ã¤id=x 1 Î“x(i)
For Î“

(i )

yx

and Î“

we also use Î“

(i ) ,

Î“

(i )

(i )

zx

(i )

vx

(yx ,zx )

e âˆ sitting above them. For this reason,
is the unique piece in Speck vx Ã—k S

to denote Î“

However, for each Î“

(i )

yx

(or Î“

(i ) .

vx

(i ) ),

zx

Î“

(i )

vx

e âˆ . Just as
does not exhaust its preimage in Y Ã—k S

Speck vx Ã—k Y, Speck v0x Ã—k Y also decomposes into 2d x pieces, and for Î“

(i )

yx

and Î“

( d x +i )

zx

(( d x + i )

is understood to be mod2d x ), there is a unique piece of Speck v0x Ã—k Y sitting over them, let it be
Î“(y(i) ,z(dx +i) ) . Then one has:
2d x

Speck v0x Ã—k Y =

Ã¤ Î“(y(i) ,z(dx +i) )

i =1

e âˆ , one gets y(i) : S âˆ’â†’ Speck yx âˆ’â†’ Y1 and z(i) : S âˆ’â†’
For a k-scheme S with S âˆ’â†’ S
Speck yx âˆ’â†’ Y2 . One has a diagrams for S similar to the one above:
x
Speck vx Ã—k S = Ã¤2d
i =1 Î“(y(i) ,z(i) )
x

t
x
Speck yx Ã—k S = Ã¤2d
i =1 Î“ y (i )
x


Speck wx Ã—k S
*

t
Speck x Ã—k S = Ã¤id=x 1 Î“ x(i)

x

*
x
Speck zx Ã—k S = Ã¤2d
i =1 Î“ z (i )
x

10

HAO LI

and
x
Speck v0x Ã—k S = Ã¤2d
i =1 Î“(y(i) ,z(d x +i) )
x

t

Speck yx Ã—k S =

2d
Ã¤i=x1

Î“

x

*
x
Speck zx Ã—k S = Ã¤2d
i =1 Î“ z (i )



Speck w0x Ã—k S

(i )

yx

x

*

t
Speck x Ã—k S = Ã¤id=x 1 Î“ x(i)
(i )

(i )

(i )

(i )

For simplicity, I will just use y x , z x and (y x , z x ) to denote Î“
(i )

ple, I will write L(y x ) for L(Î“
Î“

(i ) .

(i )

yx

(i ) , Î“ (i )
zx

yx

and Î“

(i ) (i )

(y x ,z x )

. For exam-

) to mean twisting the line bundle L on X Ã—k S by the divisor

yx

Now letâ€™s review the definition of Ti -shtukas, I will only do this for i = 1 and i = 2 is all the
same.
First Let
Bun Ti = PicYi /Pic X

(2.15)

and
Âµ

Âµ

Hk T = Hk1,Y /Pic X
i

(2.16)

i

for Âµ âˆˆ {Â±1}r be as usual. Of course, one knows the following properties of them ([6], Remark
5.2, section 5.4.4):
Proposition 2.10.

(1) Bun Ti is a Deligne-Mumford stack of dimension g âˆ’ 1.
Âµ

(2) For 0 â‰¤ i â‰¤ r, the projection map pi : Hk T1 âˆ’â†’ Bun T1 is smooth of relative dimension r.
Âµ

Âµ

(3) For 0 â‰¤ i â‰¤ r, the morphism ( pi , Ï€ Hk ) : Hk T1 âˆ’â†’ Bun T1 Ã—k Y1r is an isomorphism.
e âˆ be a divisor in Y Ã—k S
e âˆ of the following form:
Let D
eâˆ =
D

âˆ‘

(i )

x âˆˆÎ£âˆ ,1â‰¤i â‰¤2d x

(i )

(i )

c x (y x , z x )

(2.17)

Project to Y1 Ã—k S0âˆ,1 , one gets:
D1,âˆ =

âˆ‘

(i ) (i )

x âˆˆÎ£âˆ ,1â‰¤i â‰¤2d x

c x yx

Then one has the Atkin-Lehner involution:
f (D
f ( D1,âˆ ) : PicY Ã—k S
e âˆ ) := AL
e âˆ âˆ’â†’ PicY
AL
1
1
e âˆ ) := AL( D1,âˆ ) := Bun T Ã—k S
e âˆ âˆ’â†’ Bun T
AL( D
1
1

L 7âˆ’â†’ L(

âˆ‘âˆ cx

x âˆˆÎ£

(i ) (i )
yx )

e âˆ satisfy the equation:
Let Âµ âˆˆ {Â±1}r and D
r

âˆ‘ Âµi =

i =1

âˆ‘

x âˆˆÎ£âˆ ,1â‰¤i â‰¤2d x

(i )

cx

(2.18)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

11

Of course, this is due to the same degree reason as in the previous subsection. Define
Âµ
Sht T ( D1,âˆ )0 to be following fiber product:
i

/ HkÂµ (Î£) Ã—k S
eâˆ
T

Âµ

Sht T ( D1,âˆ )0
i

(2.19)

i

e 1,âˆ )â—¦( per Ã—idS )
( pe0 ,AL(âˆ’ D
âˆ

Ï‰0


Bun Ti


/ Bun T Ã— Bun T
i
i

(id,Fr )

Âµ

Given Sht T ( D1,âˆ ), the moduli of shtukas defined using S0âˆ,1 , the above one is nothing but
i

Âµ

Sht T ( D1,âˆ ) Ã—S0
i

(2.20)

eâˆ
S

1,âˆ

e âˆ:
As in Yun-Zhang, one only works with the following divisor in Y Ã—k S
eâˆ =
Âµâˆ Â· Î£

âˆ‘âˆ Âµx (yx

(1)

x âˆˆÎ£

(1)

, zx )

(2.21)

Then projects to Y1 Ã—k S0âˆ , we get
0
Âµâˆ Â· Î£1âˆ
=

âˆ‘âˆ Âµx yx

(1)

(2.22)

x âˆˆÎ£

Fix r = #Î£âˆ mod 2, then for this special choice of divisor, we have the following:
Âµ

Âµ

i

i

0
0
Sht T (Âµâˆ Â· Î£1,âˆ
)0 = Sht T (Âµâˆ Â· Î£1,âˆ
) Ã— S0

1,âˆ

(2.23)

eâˆ
S

According to Yun-Zhang, one has:
Âµ

Âµ

i

i

0
) = Sht T ( D1,âˆ )
Sht T (Âµâˆ Â· Î£1,âˆ

(2.24)

0 mod Î½âˆ— D . Also, Yun-Zhang showed ([7], Corollary 4.3):
for any choice of D1,âˆ = Âµâˆ Â· Î£1âˆ
1 âˆ
Âµ

0 ) is a smooth Deligne-Mumford stack of dimension r
Proposition 2.11. Sht T (Âµâˆ Â· Î£1,âˆ
i

Âµ

0 )0 is also a smooth DeligneTherefore the stack we are going to consider here Sht T (Âµâˆ Â· Î£1,âˆ
i
Mumford stack of dimension r.
To define Heegner-Drinfeld cycles, one first need to know how to assign an Iwahori level
structure to the push foward of a line bundle. To do this, we now fix a tuple of 1 and âˆ’1s:

ÂµÎ£ = (Âµ f , Âµâˆ ) âˆˆ {Â±1}Î£ f Ã— {Â±1}Î£âˆ

(2.25)

define the following morphism:
Definition 2.12. Define:

ÂµÎ£
e âˆ âˆ’â†’ Bun2 (Î£)
: PicY1 Ã— S
Î¸e1,Bun

(2.26)

e âˆ , the image of L, a line bunde over
in the following way: For a k-scheme S with a map S âˆ’â†’ S
Y1 Ã— S, is Î½1,âˆ— L, whose Iwahori level structure, i.e. the â€lattice filtrationâ€ at Î£ is given by:
(1) At x âˆˆ Î£ f :
â€¢ If Âµ x = 1, define Î½1,âˆ— L(âˆ’ 12 ) to be Î½1,âˆ— (L(âˆ’y x ))
â€¢ If Âµ x = âˆ’1, define Î½1,âˆ— L(âˆ’ 21 ) to be Î½1,âˆ— (L(âˆ’y0x ))
(2) At x âˆˆ Î£âˆ
(1)
(2)
â€¢ If Âµ x = 1, define Î½1,âˆ— L(âˆ’ 12 ) to be Î½1,âˆ— (L(âˆ’y x âˆ’ y x âˆ’ ... âˆ’ y(dx ) ))
( d x +1)

â€¢ If Âµ x = âˆ’1, define Î½1,âˆ— L(âˆ’ 21 ) to be Î½1,âˆ— (L(âˆ’y x

( d x +2)

âˆ’ yx

âˆ’ ... âˆ’ y(2dx ) ))

This definition is the same as Yun-Zhangâ€™s definition applied to the S0âˆ,1 structure for S
e âˆ with the canonical projection mentioned above.
induced by its S
For Y2 we define the map
ÂµÎ£
e âˆ âˆ’â†’ Bun2 (Î£)
Î¸e2,Bun
: PicY2 Ã— S

in completely the same way.

(2.27)

12

HAO LI

By quotienting out Pic X , one gets:
Î£
e âˆ âˆ’â†’ BunG (Î£)
Î¸1,Bun
: Bun T1 Ã— S

(2.28)

ÂµÎ£
e âˆ âˆ’â†’ BunG (Î£)
Î¸2,Bun
: Bun T2 Ã— S

(2.29)

Âµ

and
We can define the morphism on the Hecke stacks:
Âµ

Âµ

e âˆ âˆ’â†’ Hk (Î£)
Hk T1 Ã—k S
G

(2.30)

Î£
By applying Î¸ Bun,1
to each single Li in the sequence of line bundles.
As in their paper, define the following #-Atkin-Lehner for T1 :

Âµ

e âˆ ), Fr e ) : Bun T Ã— S
e âˆ âˆ’â†’ Bun T Ã— S
eâˆ
AL#T1 ,Âµâˆ := ( AL(âˆ’Âµâˆ Â· Î£
1
1
Sâˆ

(2.31)

Then one has the following commutative diagram:
Bun T1

eâˆ
Ã—S

AL#T

1 ,Âµâˆ

/ Bun T Ã— S
eâˆ
1

ÂµÎ£
(Î¸1,Bun
,Î½âˆ )

(2.32)

ÂµÎ£
Î¸1,Bun


BunG (Î£) Ã—k Sâˆ


/ BunG (Î£)

AL G,âˆ

Âµ

By unraveling the meaning of the functor of points of Sht T1 (Âµâˆ Â· Î£1,âˆ )0 , one finds that it also
fits in the following fiber diagram:
/ HkÂµ (Î£) Ã—k S
eâˆ
T1

Âµ

Sht T1 (Âµâˆ Â· Î£1,âˆ )0

(2.33)

( p0 Ã—idSe âˆ ,AL#T

1 ,Âµâˆ


Bun T1

(id,Fr )

/ ( Bun T
1


e âˆ ) Ã— ( Bun T Ã— S
e âˆ)
Ã—S
1

â—¦( pr Ã—idSe âˆ )

Then by (2.32), (2.33), together with the morphism of the Hecke stacks (2.30), one gets the
Heegner-Drinfeld map for Y1 :
Âµ

Âµ

Î¸1 : Sht T1 (Âµâˆ Â· Î£1,âˆ )0 âˆ’â†’ ShtG (Î£; Î£âˆ )
Âµ

(2.34)

e âˆ -structure, one actually gets:
By remembering the S
0Âµ
eâˆ
Î¸1 : Sht T1 (Âµâˆ Â· Î£1,âˆ )0 âˆ’â†’ ShtG (Î£; Î£âˆ ) Ã—Sâˆ S
Âµ

Âµ

(2.35)

Repeat all the above for Y2 , one gets the Heegner-Drinfeld map for Y2 :
0Âµ
eâˆ
Î¸2 : Sht T2 (Âµâˆ Â· Î£2,âˆ )0 âˆ’â†’ ShtG (Î£; Î£âˆ ) Ã—Sâˆ S
Âµ

Âµ

(2.36)

Âµ

Denote the common right hand side by ShtG (Î£; Î£âˆ )0 . Note that unlike Yun-Zhang, there is
no base with respect to Yir âˆ’â†’ X r .
By pushing foward the fundamental cycles of the left hand side of the equation, one gets
classes in the middle dimension Chow groups of the right hand side:
Definition 2.13. Define the Heegner-Drinfeld cycle for Y1 and Y2 as follows:
0Âµ

Âµ

Âµ

(2.37)

Âµ
Chc,r (ShtG (Î£; Î£âˆ )0 )

(2.38)

Z1 := Î¸1 [Sht T1 (Âµâˆ Â· Î£1,âˆ )0 ] âˆˆ Chc,r (ShtG (Î£; Î£âˆ )0 )
Âµ

Âµ
Z2

:=

Âµ
0Âµ
Î¸2 [Sht T2 (Âµâˆ

0

Â· Î£2,âˆ ) ] âˆˆ

Finishing all the setups, it is the time for us to state the question:
â€œComputeâ€ the following number:
Âµ

Âµ

hZ1 , f âˆ— Z2 i

(2.39)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

13

for an f âˆˆ HGÎ£ . One can first take f to be a basis element indexed by an effective divisor D
Âµ
Âµ
of X âˆ’ Î£, namely h D . hZ1 , h D âˆ— Z2 i can be computed by the following fiber diagram:
/ ShtÂµ (Î£; Î£âˆ ; h D )0
G

âˆ—

Âµ
Sht T1 (Âµâˆ

Â· Î£1,âˆ

)0

(2.40)



0Âµ
0Âµ
Î¸1 Ã— Î¸2
Âµ
Âµ
Âµ
0
âˆ
0
/
Ã— Sht T2 (Âµâˆ Â· Î£2,âˆ )
ShtG (Î£; Î£ ) Ã— ShtG (Î£; Î£âˆ )0

Âµ

In which ShtG (Î£; Î£âˆ ; h D )0 is defined as:
Âµ

Âµ

eâˆ
ShtG (Î£; Î£âˆ ; h D )0 := ShtG (Î£; Î£âˆ ; h D ) Ã—Sâˆ S

(2.41)

Âµ
Âµ
0Âµ
0Âµ
âˆ— Z2 i = deg(Î¸1 Ã— Î¸2 )! [ShtG (Î£; Î£âˆ ; h D )0 ].
Âµ
Âµ
2d x )âˆ’1 hZ1 , f âˆ— Z2 i. The clumsy factor before

Âµ
hZ1 , h D

and we will later give âˆ— a name. Then
For simplicity, for f , let IÂµ ( f ) = (âˆ xâˆˆÎ£âˆ
the
e âˆ,
intersection pairing is for the nomalization purpose. To remove it, one can fix a k-point of S
e âˆ to k:
say Î¾, and consider the base change from S
Âµ

ShtG (Î£; Î¾ ) := ShtG (Î£; Î£âˆ ) Ã—Sâˆ Î¾
Âµ

Âµ

Âµ

Sht T (Âµâˆ Â· Î¾ ) := Sht T (Âµâˆ Â· Î£i,âˆ )0 Ã—S
eâˆ Î¾
i

Then one has:
0Âµ

Âµ
Sht T (Âµâˆ
i

Î¸i,Î¾

Âµ

Âµ

Âµ

Â· Î¾ ) âˆ’â†’ ShtG (Î£; Î£âˆ )0 Ã—Se âˆ Î¾ = ShtG (Î£; Î£âˆ ) Ã—Sâˆ Î¾ = ShtG (Î£; Î¾ )
0Âµ

Âµ

Define Zi (Î¾ ) := Î¸i,Î¾ [Sht T (Âµâˆ Â· Î¾ )] âˆˆ Chc,r (ShtG (Î£; Î¾ ))Q for i = 1, 2. Actually the pull back
Âµ

Âµ

i

Âµ

of Zi to ShtG (Î£; Î£âˆ )0 Ã—S
e âˆ k splits into is just the disjoint union of Zi ( Î¾ ) as Î¾ runs through all
e âˆ . Following the method of Yun-Zhang ([7], Corollary 4.11), one
the âˆ xâˆˆÎ£âˆ 2d x k-points of S
can prove the following:
Âµ

Âµ

e (k), one has:
Lemma 2.14. For any two Î¾, Î¾ 0 âˆˆ S

hZ1 (Î¾ ), f âˆ— Z2 (Î¾ )iShtÂµ (Î£;Î¾ ) = hZ1 (Î¾ 0 ), f âˆ— Z2 (Î¾ 0 )iShtÂµ (Î£;Î¾ 0 )

(2.42)

IÂµ ( f ) = hZ1 (Î¾ ), f âˆ— Z2 (Î¾ )iShtÂµ (Î£;Î¾ )

(2.43)

Âµ

Âµ

Âµ

Âµ

G

G

In particular:
Âµ

Âµ

G

By the general theory of Yun-Zhang, one expects that this number can be computed by applying the Grothendieck-Lefschetz trace formula to some cohomological self-correspondence
of certain â€œHitchin typeâ€ fiberation derived from the moduli of shtukas and the constant sheaf
for D of large enough degree. This is the topic of the next section.
3. T HE H ITCHIN TYPE FIBERATION FOR THE H EEGNER -D RINFELD CYCLES
3.1. The moduli space Md Î£ . Unraveling the definition of diagram used to compute hZ1 , h D âˆ—
Âµ
Z2 i, i.e.(??) and the general philosophy of Yun-Zhangâ€™s work, we are led to the following definition. Fixing Âµâˆ = (Âµ f , Âµâˆ ) as in the last section.
Âµ

Âµ

f Î£ as the stack whose funtor of point on a k-scheme S is the following:
Definition 3.1. Define M
d
e
â€¢ A map S âˆ’â†’ Sâˆ
â€¢ A line bundle L on Y1 Ã—k S and a line bundle F on Y2 Ã—k S.
ÂµÎ£
ÂµÎ£
â€¢ A morphim of coherent sheaves on X Ã—k S, Ï† from Î¸e1,Bun
(L) to Î¸e2,Bun
(F ), more precisely:
Ï† : Î½1,âˆ— L âˆ’â†’ Î½2,âˆ— F
(3.1)
sending each â€œsublatticeâ€ of Î½1,âˆ— L defined in (2.12) to the corresponding one of Î½2,âˆ— F .
And Ï† has the following property: the induced map on the determinant line bundle
Âµ

detÏ† : det(Î½1,âˆ— L) âˆ’â†’ det(Î½2,âˆ— F )

(3.2)

14

Let

HAO LI

has zeroes of total degree d and away from Î£.
fÂµÎ£ /Pic X .
:= M

Âµ
Md Î£

d

Now let N = degÎ£, and YÌ‚2dâˆ’ N be the moduli space of the effective divisor of degree 2d âˆ’ N
on Y, which is simply the 2d âˆ’ N-fold symmetric product scheme of Y. I want to define a map
Âµ
e âˆ , depending on our choice of (Âµ f , Âµâˆ ) as
from Md Î£ to YÌ‚2dâˆ’ N . First define a divisor on Y Ã—k S
follows:
e:=
D
(3.3)
âˆ‘ (y0x , zx ) + âˆ‘ (yx , z0x )
x âˆˆÎ£ f ,Âµ x =1

+

âˆ‘

x âˆˆÎ£ f ,Âµ x =âˆ’1

dx

âˆ‘ (y x x

x âˆˆÎ£âˆ ,Âµ x =1 i =1

( d +i )

(i )

, zx ) +

âˆ‘

dx

âˆ‘ (y x

x âˆˆÎ£âˆ ,Âµ x =âˆ’1 i =1

(i )

( d x +i )

, zx

)

(3.4)

And also let D30 = âˆ‘ xâˆˆÎ£ w0x , it is a divisor of Y3 . For the definition of wx and w0x , look at
section (2.1) and section (2.7).
Now as Howard-Shnidman did, pull back Ï† : Î½1,âˆ— L âˆ’â†’ Î½2,âˆ— F all the way up to Y, this map
splits into the following:
Ï†
â†’ Fe âŠ• Ï„3âˆ— Fe
Le âŠ• Ï„3âˆ— Le âˆ’

(3.5)

e can be described more precisely:
in which Ï†
Ï†11
Le âˆ’â†’ Fe
Ï„1 (Ï†11 )
âˆ¼
âˆ¼
Le âˆ’
â†’ Ï„1âˆ— Le âˆ’âˆ’âˆ’âˆ’â†’ Ï„1âˆ— Fe âˆ’
â†’ Ï„3âˆ— Fe
Ï„2 (Ï†11 )
âˆ¼
âˆ¼
Ï„3âˆ— Le âˆ’
â†’ Ï„2âˆ— Le âˆ’âˆ’âˆ’âˆ’â†’ Ï„2âˆ— Fe âˆ’
â†’ Fe
Ï„3 (Ï†11 )
Ï„3âˆ— Le âˆ’âˆ’âˆ’âˆ’â†’ Ï„3âˆ— Fe

Now Ï†11 can be viewed as a section of Leâˆ’1 âŠ— Fe .
Let âˆ† := det(Î½1,âˆ— L)âˆ’1 âŠ— det(Î½2,âˆ— F ). It is a degree d line bundle on X Ã—k S since it admits a
section det(Ï†) of degree d by definition. Then by observing that:
Î½3âˆ— âˆ† = Nm(Leâˆ’1 âŠ— Fe )

(3.6)

one can see that the degree of Leâˆ’1 âŠ— Fe is 2d:
âˆ¼
âˆ¼
Î½âˆ— âˆ† âˆ’
â†’ Ï€3âˆ— Î½3âˆ— âˆ† = Ï€3âˆ— Nm(Leâˆ’1 âŠ— Fe ) âˆ’
â†’ Leâˆ’1 âŠ— Fe âŠ— Ï„3âˆ— Leâˆ’1 âŠ— Ï„3âˆ— Fe

(3.7)

Of course Î½âˆ— âˆ† has degree 4d, so Leâˆ’1 âŠ— Fe has degree 2d since deg(Leâˆ’1 âŠ— Fe = deg(Ï„3âˆ— Leâˆ’1 âŠ— Ï„3âˆ— Fe .
We also have to take care of the Iwahori level structure. we will see that this results in certain
prescribed zeros of Ï†11 :
(1) At x âˆˆ Î£ f .
â€¢ Âµ x = 1. In this case, the Iwahori level structures are defined by Î½1,âˆ— (L(âˆ’y x )) and
Î½2,âˆ— (F (âˆ’z x )) respectively. Pull them back to the very top curve Y, one finds that:
e
e
Î½âˆ— Î½1,âˆ— (L(âˆ’y x )) = L(âˆ’(
y x , z x ) âˆ’ (y x , z0x )) âŠ• Ï„3âˆ— L(âˆ’(
y0x , z x ) âˆ’ (y0x , z0x ))
Î½âˆ— Î½2,âˆ— (F (âˆ’z x )) = Fe (âˆ’(y x , z x ) âˆ’ (y0x , z x )) âŠ• Ï„3âˆ— Fe (âˆ’(y0x , z0x ) âˆ’ (y0x , z0x ))
e
Since Ï† preserves Iwahori level structure, Ï†11 should send L(âˆ’(
y x , z x ) âˆ’ (y x , z0x ))
0
to Fe (âˆ’(y x , z x ) âˆ’ (y x , z x )), and by Galois equivariancy this is enough. Therefore
one has:
Ï†11 |(y0x ,zx ) = 0 and Ï†11 |(yx ,zx ) , 0, Ï†11 |(y0x ,z0x ) , 0

(3.8)

The nonvanishing part comes from the nonvanishing of det(Ï†) at Î£
â€¢ Âµ x = âˆ’1. In this case, the Iwahori level structures are defined by Î½1,âˆ— (L(âˆ’y0x )) and
Î½2,âˆ— (F (âˆ’z0x )) respectively. The same analysis as above yields:
Ï†11 |(yx ,z0x ) = 0 and Ï†11 |(yx ,zx ) , 0, Ï†11 |(y0x ,z0x ) , 0

(3.9)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

15

(2) At x âˆˆ Î£âˆ .
â€¢ Âµ x = 1. In this case, the Iwahori level structures are defined by:
(1)

Î½1,âˆ— (L(âˆ’y x âˆ’ ... âˆ’ y(dx ) ))
(1)

Î½2,âˆ— (F (âˆ’z x âˆ’ ... âˆ’ z(dx ) ))
pull back them to the very top curve Y, one gets:
(1) (1)
(d ) (d )
( d +1)
(2d )
e
L(âˆ’(
y x , z x )... âˆ’ (y x x , z x x ) âˆ’ (y(1) , z x x )... âˆ’ (y(dx ) , z x x ))
( d x +1)

e
yx
âŠ•Ï„3âˆ— L(âˆ’(

(1)

(2d x )

, z x )... âˆ’ (y x

(d x )

, zx

( d x +1)

)... âˆ’ (y x

( d x +1)

, zx

(2d x )

)... âˆ’ (y x

(2d x )

, zx

))

(1) (1)
(d ) (d )
(1)
(d )
Fe (âˆ’(y x , z x )... âˆ’ (y x x , z x x ) âˆ’ (y(dx +1) , z x )... âˆ’ (y(2dx ) , z x x ))
(1) ( d +1)
(d ) (2d )
( d +1) ( d +1)
(2d ) (2d )
âŠ•Ï„3âˆ— Fe (âˆ’(y x , z x x )... âˆ’ (y x x , z x x )... âˆ’ (y x x , z x x )... âˆ’ (y x x , z x x ))

Preserving Iwahori level structures translates to:
Ï†11 |

(1)

(d x )

(y(d x +1) ,z x )...+(y(2d x ) ,z x

)

=0

(3.10)

â€¢ Âµ x = âˆ’1. In this case, the Iwahori level structure are defined by:
( d x +1)

âˆ’ ... âˆ’ y(2dx ) ))

( d x +1)

âˆ’ ... âˆ’ z(2dx ) ))

Î½1,âˆ— (L(âˆ’y x

Î½2,âˆ— (F (âˆ’z x

The same analysis as above yields the following:
Ï†11 |

( d x +1)

(y(1) ,z x

(2d x )

)...+(y(d x ) ,z x

)

=0

(3.11)

e is defined. Due to the vanishing conditions, one can
Now you must see how the divisor D
e ), which as degree 2d âˆ’ N.
view Ï†11 as a section of the line bundle (Leâˆ’1 âŠ— Fe )(âˆ’ D
Definition 3.2. Define the map:

Md Î£ âˆ’â†’ YÌ‚2dâˆ’ N

(3.12)

e ), Ï†11 )
(L, F , Ï†) 7âˆ’â†’ ((Leâˆ’1 âŠ— Fe )(âˆ’ D

(3.13)

Âµ

as

Remark 3.3. Roughly speaking, this map is something to remember the divisor of Ï†11 . Since Ï†11
must vanish at some prescribed points arising from the Iwahori level structure, one only has to
e
remember the varying parts. This is the meaning of twisting it by D.
3.2. The moduli space Ad . The â€œHitchin typeâ€ fiberation needs a base space. Iâ€™m going to
describe it here.
Definition 3.4. Define Ad to be the stack over k whose functor of point on a k-scheme S consisting of:
â€¢ A degree d line bundle âˆ† over X Ã—k S
â€¢ A global section a âˆˆ H 0 (Y3 Ã—k S, Î½3âˆ— âˆ†) who vanishes at the support of D30 , and Tr ( a) is a
nonzero section of âˆ† who doesnâ€™t vanish at Î£.
This is almost the same as the definition of Howard-Shnidman, the new things are the vanishing and nonvanishing conditions, as you know, coming from the Iwahori level structure.
Unlike the case considered by Yun-Zhang, this Ad is somehow simpler, since it is a scheme
on the nose ([4], section 3.4).
Proposition 3.5. Consider the trace map:
Tr : Ad âˆ’â†’ XÌ‚d

(âˆ†, a) 7âˆ’â†’ (âˆ†, Ïƒ3 invariant of a + Ïƒ3 ( a))
This map is quasi-projective, and Ad is a quasi-projective scheme.
As in the case of Md Î£ , one can define the divisor memorizing map for Ad .
Âµ

16

HAO LI

Definition 3.6. Define the map:

Ad âˆ’â†’ YÌ‚3,2dâˆ’ N

(3.14)

as

(âˆ†, a) 7âˆ’â†’ (Î½3âˆ— âˆ†(âˆ’ D30 ), a0 )
In which a0 means viewing a as a section of Î½3âˆ— âˆ†(âˆ’ D30 ) rather than Î½3âˆ— âˆ†

(3.15)

Let D âˆˆ Div+ ( X âˆ’ Î£) be an effective divisor on X âˆ’ Î£. We can define A D as the following
fiber product:
Definition 3.7.

/ Ad

AD

Speck

Tr


/ XÌ‚d

(O X ( D ),1)

From the definitions of Md Î£ and Ad , it is obvious that there exists a map from Md Î£ to Ad .
Âµ

Âµ

Definition 3.8. The â€œHitchin typeâ€ fiberation for the shtuka side is the following morphism:
f d : Md Î£ âˆ’â†’ Ad

(3.16)

(L, F , Ï†) 7âˆ’â†’ (âˆ† := det(Î½1,âˆ— L)âˆ’1 âŠ— det(Î½2,âˆ— F ), Nm(Ï†11 ))

(3.17)

Âµ

Preserving the Iwahori level structure makes sure the image lies in the right hand side. Also
this map fits into the following diagram:

Md Î£

/ YÌ‚2dâˆ’ N


Ad



Âµ

(3.18)

Nm

/ YÌ‚3,2dâˆ’ N

This diagram is almost a Cartesian diagram. As we will see.
3.3. The diagram above is almost Cartesion. First for convenience, denote by Md the Cartesian product, i.e.
/ YÌ‚2dâˆ’ N
Md
(3.19)

Ad



Nm

/ YÌ‚3,2dâˆ’ N

Since Ad is a scheme, Md is a scheme. From Howard-Shnidman, one can know the following
([4], Lemma 4.4):
Proposition 3.9. When 2d â‰¥ 2(2g3 âˆ’ 1) âˆ’ 1 + N, Md and Ad are of dimension 2d âˆ’ N âˆ’ g + 1.
First Let U2dâˆ’ N = { E âˆˆ YÌ‚2dâˆ’ N : TrY3 /X ( NmY/Y3 ( E)) âˆ© Î£ = âˆ…}, this is an open subscheme of
YÌ‚2dâˆ’ N . The space Md actually also fits into the following Cartesian diagram:

Md

/ U2dâˆ’ N


PicdX


/ Pic2dâˆ’ N
Y3

The bottom horizontal arrow is simply pull back then twisted by the divisor D30 .
The right vertical arrow is the restriction to U2dâˆ’ N of the map:
AJ

NmY/Y3

2dâˆ’ N
YÌ‚2dâˆ’ N âˆ’â†’ PicY
âˆ’âˆ’âˆ’âˆ’â†’ PicY2d3 âˆ’ N

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

17

in which AJ is the Abel-Jacobi map, which is smooth when 2d âˆ’ N â‰¥ 2(2g3 âˆ’ 1) âˆ’ 1. And the
smoothness of NmY/Y3 is shown by Howard-Shnidman. Therefore the right vertical map in the
Cartesian diagram is smooth. From this, one can concludes that:
2dâˆ’ N
dimMd = dimU2dâˆ’ N âˆ’ dimPicY
+ dimPicdX
3

= 2d âˆ’ N âˆ’ ( g3 âˆ’ 1) + ( g âˆ’ 1)
= 2d âˆ’ N âˆ’ (2g âˆ’ 2) + g âˆ’ 1 = 2d âˆ’ N âˆ’ g + 1
We used g3 = 2g âˆ’ 2 since Y3 is nonramified over X. Then from the defining diagram for Md
(3.19), one knows Ad is of the same dimension. 
e âˆ . Actually this is the
By the definition of MÂµÎ£ one can see that it is actually a space over S
ÂµÎ£
only difference between Md and Md :
Proposition 3.10. We have an isomorphism:
âˆ¼

eâˆ
Md Î£ âˆ’
â†’ Md Ã—k S
Âµ

(3.20)

Therefore Md Î£ is also a scheme, not just a Deligne-Mumford stack.
Âµ

From the left to the right is simply the maps from Md Î£ to YÌ‚2dâˆ’ N , to Ad defined in the last
e âˆ . We only have to construct its
subsection, together with remembering the map: S âˆ’â†’ S
inverse.
What does an S point of Md consists of? It is the following
Âµ

â€¢ a degree 2d âˆ’ N effective divisor (K 0 , Ïˆ0 ) on Y Ã—k S;
â€¢ a degree d line bundle on X Ã—k S, say âˆ†, and a section a of Î½3âˆ— âˆ†, vanishing at D30 , and
Tr ( a) doesnâ€™t vanish at Î£.
such that:
Nm((K 0 , Ïˆ0 )) = (Î½3âˆ— âˆ†(âˆ’ D30 ), a0 )
(3.21)
In which, again, a0 is just a viewed as a section Î½3âˆ— âˆ†(âˆ’ D30 ).
e ), Ïˆ) in which Ïˆ is Ïˆ0 viewed as a
e âˆ structure allows us to consider the twists (K 0 ( D
The S
0
e
section of the more positive line bundle K ( D ). Denote this more positive one by just K. Then
from the above equation we find the following equation:

K âŠ— Ï„3âˆ— K = Î½âˆ— âˆ†

(3.22)

This provides K âŠ— Ï„3âˆ— K with the Ï„1 and Ï„2 equivariant structure, since it is pulled back from the
very bottom:
âˆ¼

âˆ¼

K âŠ— Ï„3âˆ— K âˆ’
â†’ Ï„1âˆ— (K âŠ— Ï„3âˆ— K) âˆ’
â†’ Ï„1âˆ— K âŠ— Ï„2âˆ— K

(3.23)

This in turn yields:
âˆ¼

âˆ¼

Ï„1âˆ— K âˆ’1 âŠ— K âˆ’
â†’ Ï„3âˆ— K âˆ’1 âŠ— Ï„2âˆ— K âˆ’
â†’ Ï„2âˆ— (Ï„1âˆ— K âˆ’1 âŠ— K)

(3.24)

Therefore Ï„1âˆ— K âˆ’1 âŠ— K descent to Y2 Ã—k S. Denote the descent by M.
Since one has the canonical Ï„i , i = 1, 2, 3-equivariant isomorphism:
âˆ¼

Ï€2âˆ— (M âŠ— Ïƒ2âˆ— M) âˆ’
â†’ Ï„1âˆ— K âˆ’1 âŠ— K âŠ— Ï„3âˆ— (Ï„1âˆ— K âˆ’1 âŠ— K)
âˆ¼

âˆ¼

â†’ OY Ã— k S
âˆ’
â†’ Ï„1âˆ— K âˆ’1 âŠ— K âŠ— Ï„2âˆ— K âˆ’1 âŠ— Ï„3âˆ— K âˆ’
The last equation comes from the left equation above, moving everything to the left hand side.
This equivariant trivialization shows that NmY2 Ã—k S/X Ã—k S (M) is trivial. Therefore from the exact
sequence:
idâˆ’Ïƒ

Nm

2
0
1âˆ’
â†’ PicY2 /Pic X âˆ’âˆ’âˆ’â†’
PicY
âˆ’âˆ’â†’ Pic0X âˆ’
â†’1
2

(3.25)

one knows that there exists a unique line bundle F over Y2 Ã—k S up to twisted by line bundles
pulling back from X Ã—k S, such that
âˆ¼

F âŠ— Ïƒ âˆ— F âˆ’1 âˆ’
â†’M

(3.26)

18

HAO LI

Now Ï€2âˆ— (K âˆ’1 âŠ— F ) has a Ï„1 equivariant structure:
âˆ¼

Ï„1âˆ— (K âˆ’1 âŠ— Ï€2âˆ— F ) âˆ’
â†’ Ï„1âˆ— K âˆ’1 âŠ— Ï€2âˆ— Ïƒ2âˆ— F
âˆ¼

âˆ’
â†’ Ï„1âˆ— K âˆ’1 âŠ— Mâˆ’1 âŠ— Ï€2âˆ— F
âˆ¼

âˆ’
â†’ Ï„1âˆ— K âˆ’1 âŠ— Ï„1âˆ— K âŠ— K âˆ’1 âŠ— Ï€2âˆ— F
âˆ¼

âˆ’
â†’ K âˆ’1 âŠ— Ï€2âˆ— F
âˆ¼

This produces the desired line bundle L on Y1 âŠ—k S such that Ï€1âˆ— L âˆ’
â†’ K âˆ’1 âŠ— Ï€2âˆ— F .
As in the previous subsections, let Le = Ï€1âˆ— L and Fe = Ï€2âˆ— F , one gets
âˆ¼
Leâˆ’1 âŠ— Fe âˆ’
â†’K

(3.27)

Leâˆ’1

Via this isomorphism, one can view Ïˆ as a global section of
âŠ— Fe . Note that (K, Ïˆ) comes
0
0
âˆ’
1
e
e
e ). In other words, one
from (K ( D ), Ïˆ), one can also view Ïˆ as a global section of L âŠ— Fe (âˆ’ D
can view a as:
e
Ïˆ : Le âˆ’â†’ K
(3.28)
e
vanishing at the divisor D.
By applying Ï„i s to it, one can produce:
Ïˆ
Le âˆ’
â†’ Fe
Ï„1 (Ïˆ)
âˆ¼
âˆ¼
Le âˆ’
â†’ Ï„1âˆ— Le âˆ’âˆ’âˆ’â†’ Ï„1âˆ— Fe âˆ’
â†’ Ï„3âˆ— Fe
Ï„2 (Ïˆ)
âˆ¼
âˆ¼
Ï„3âˆ— Le âˆ’
â†’ Ï„2âˆ— Le âˆ’âˆ’âˆ’â†’ Ï„2âˆ— Fe âˆ’
â†’ Fe
Ï„3 (Ïˆ)
Ï„3âˆ— Le âˆ’âˆ’âˆ’â†’ Ï„3âˆ— Fe

This matrix descent to a morphism:
Ï† : Î½1,âˆ— L âˆ’â†’ Î½2,âˆ— F

(3.29)

e makes sure that Ï† preserves
It is easy to check that det(Ï†) = Tr ( a). The fact that Ïˆ vanishes at D
the Iwahori level structure, and the nonvanishing of Tr ( a) at Î£ makes sure the nonvanishing of
det(Ï†) at Î£. This finishes the construction of the inverse map. One can check that this is really
the inverse. 
3.4. The Hecke correspondence for Md Î£ and Md . You may have noticed that in the definition
Âµ
of Md Î£ , the Ï† comes from the vertical Hecke symmetries of the moduli of shtukas. Now we
take care of the horizontal Hecke modifications. As before, fix our choice of (Âµ, Âµ f , Âµâˆ ). Define
the following stack:
Âµ

f Âµ be the stack over k whose functor of points on a k-scheme S consists
Definition 3.11. Let Hk
Md
of the following:
eâˆ
â€¢ S âˆ’â†’ S
â€¢ r S-points of Y1 : y1 , y2 , ..., yr : S âˆ’â†’ Y1 and S-points of Y2 : z1 , z2 , ..., zr : S âˆ’â†’ Y2
such that Î½1 â—¦ yi = Î½2 â—¦ zi as S points of X, for i = 1, ...r. These two points is equivalent
to r S-points of Y = Y1 Ã— X Y2 .
Âµ
â€¢ r + 1 S-objects of Md Î£ : (L0 , F0 , Ï†0 ), ..., (Lr , Fr , Ï†r ).
â€¢ Morphisms of coherent sheaves: f i : Liâˆ’1 d Li and f i0 : Fiâˆ’1 d Fi such that their push
foward to X Ã—k S fit into the following commutative diagram:
Î½1,âˆ— L0


Î½1,âˆ— f 1

Ï†0

Î½2,âˆ— F0

Î½2,âˆ— f 10

/ Î½1,âˆ— L1


Î½1,âˆ— f 2

/ ......

Î½1,âˆ— f r

/ ......

Î½2,âˆ— f r0

Ï†1

/ Î½2,âˆ— F1

Î½2,âˆ— f 20

/ Î½1,âˆ— Lr


Ï†r

/ Î½2,âˆ— Fr

(3.30)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

19

Âµ
f Âµ /Pic X .
As usual, let Hk M be Hk
M
d

d

Âµ
e âˆ , though we donâ€™t
It is a self-correspondence of Md Î£ over Ad (actually even over Ad Ã—k S
use it)
Âµ

â†
âˆ’
p

Md Î£
Âµ

Hk M

(3.31)

d

âˆ’
â†’
p

z
$

Md Î£
Âµ

$
z
eâˆ
Ad Ã—k S
The case Âµ = +1 is the building block of the mutiple modification points ones, i.e., one has
the following isomorphism as a self-correspondence of Md over Ad :
Âµ

1
1
â†’
âˆ’
â†’
âˆ’
â†’
âˆ’
Hk M = Hk1Md Ã—âˆ’
p ,M d ,â†
p Hk Md
p ,M d ,â†
p ...... Ã—âˆ’
p ,M d ,â†
p Hk Md Ã—âˆ’
d

(3.32)

The purpose now is to transfer the Hecke correspondence for Md Î£ to a Hecke correspondence for Md . But letâ€™s first see what that looks like. Recall a definition made by HowardShnidman ([4] section 4.3).
Âµ

Definition 3.12. Let H2dâˆ’ N be the k-stack whose typical S-objects are the following:

â€¢ Two S-points of YÌ‚2dâˆ’ N : (K00 , Ïˆ00 ), (K10 , Ïˆ10 ).
â€¢ An S-point of Y, i.e. v : S âˆ’â†’ Y.
âˆ¼
â€¢ An isomorphism of sheaves: s : K00 (Ï„2 (v) âˆ’ Ï„1 (v)) âˆ’
â†’ K10 , such that s(Ïˆ00 ) = Ïˆ10 , in
0
0
which vewing a0 as a rational section of K0 (Ï„2 (v) âˆ’ Ï„1 (v)).
The last condition guarantees that Nm(K00 , Ïˆ00 ) = Nm(K10 , Ïˆ10 ), therefore one gets the following diagram:
H2dâˆ’ N
Î³0

(3.33)
Î³1

z

$

YÌ‚2dâˆ’ N

YÌ‚2dâˆ’ N
$
z
YÌ‚3,2dâˆ’ N

Recall that Md is defined to be the fiber product: Md := YÌ‚2dâˆ’ N Ã—YÌ‚

3,2dâˆ’ N

Ad . Pull back the

above self-correspondence of YÌ‚2dâˆ’ N to a self-correspondence of Md over Ad , denoted by Hd :

Hd

(3.34)

Î³0

Md

Î³1

}

!

!

Ad

Md

}

We know the dimension of Hd :
Proposition 3.13. Î³0 and Î³1 are finite and surjective. Hd is a scheme of dimension 2d âˆ’ N âˆ’ g + 1.
You may wonder how this Hd is so defined, the next proposition just tells you this:
e âˆ is isomorphic to Hk1 as a self-correspondence over A Ã—k S
e âˆ if one
Proposition 3.14. Hd Ã—k S
Md
Âµ
Î£
e âˆ with M via the proposition in the last subsection.
identifies Md Ã—k S
d

20

HAO LI

e âˆ actually is the definition of Hd . Starts with the point of
Going from Hk1M to Hd Ã—k S
Hk1M , say:

d

d

e âˆ , (L0 , F0 , Ï†0 ), (L1 , F1 , Ï†1 ), f , f 0 , (y, z)
S âˆ’â†’ S
one gets two S-point of Md :
e ), Ïˆ10 )
e ), Ïˆ00 ), (Leâˆ’1 âŠ— Fe1 (âˆ’ D
(Le0âˆ’1 âŠ— Fe0 (âˆ’ D
1
Pulling back f and f 0 to Y, one finds:
âˆ¼
fe : Le0 ((y, z) + (y, z0 )) âˆ’
â†’ Le1
âˆ¼
fe0 : Fe0 ((y, z) + (y0 , z)) âˆ’
â†’ Fe1

from this one can get:
âˆ’1
âˆ¼
â†’ Le1âˆ’1 âŠ— Fe1
fe âŠ— fe0 : Le0âˆ’1 âŠ— Fe0 ((y0 , z) âˆ’ (y, z0 )) âˆ’

Therefore the following tuple:
e ), Ïˆ00 ), (Leâˆ’1 âŠ— Fe1 (âˆ’ D
e ), Ïˆ10 ), ( fe âŠ— fe0 âˆ’1 )(âˆ’ D
e)
(Le0âˆ’1 âŠ— Fe0 (âˆ’ D
1
lies in Hd .
Âµ
e âˆ , the important part is
Like in the proof of the equivalence between Md Î£ and Md Ã—k S
going backwards. From that equivalence, starting from a point YÌ‚2dâˆ’ N : (K00 , Ïˆ00 ), (K10 , Ïˆ10 ) on
ÂµÎ£
e âˆ , one can produce a point on MÂµÎ£ Ã—
(Md Ã—Ad Md ) Ã—k S
e âˆ Md :
A Ã— S
d
d

k

(L0 , F0 , Ï†0 ), (L1 , F1 , Ï†1 )
Now the only thing need to do is to prove that giving an S point v = (y, z) of Y and s identifying
(K00 (Ï„2 (v) âˆ’ Ï„1 (v)), Ïˆ00 ) with (K10 , Ïˆ10 ), one can reconstruct the following:
âˆ¼

âˆ¼

f : L0 ( y ) âˆ’
â†’ L1 and f 0 : F0 (z) âˆ’
â†’ F1
To do this, as mentioned by Howard-Shnidman, one has to go back to the prove of the equivalence.
e ). Apply Ï„ âˆ— to
e âˆ allows one to define: Ki = K 0 ( D
As in the prove of the equivalence, S âˆ’â†’ S
1
i
the following the equation and taking the inverse:
âˆ¼

s : K0 ((y0 , z) âˆ’ (y, z0 )) âˆ’
â†’ K1
one gets:

âˆ¼

Ï„1 (s) : Ï„1âˆ— K0âˆ’1 ((y, z) âˆ’ (y0 , z0 )) âˆ’
â†’ Ï„1âˆ— K1âˆ’1
Tensor them up:
âˆ¼

â†’ Ï„1âˆ— K1âˆ’1 âŠ— K1
Ï„1âˆ— K0âˆ’1 âŠ— K0 ((y0 , z) âˆ’ (y, z0 ) + (y, z) âˆ’ (y0 , z0 )) âˆ’
Descent to Y2 , one finds:

âˆ¼

M0 ( z âˆ’ z 0 ) âˆ’
â†’ M1
âˆ¼

By construction, F1 is the unique line bundle up twists by Pic X such that F1 âŠ— Ïƒ2âˆ— F1 âˆ’
â†’ M1 ,
âˆ¼
but the above equation shows that F0 (z) is another such. This way one gets f 0 : F0 (z) âˆ’
â†’ F1 .
Now recall how we reconstructed L. Li is defined to be a line bundle on Y1 âŠ—k S pullback to
be Kiâˆ’1 âŠ— Fei . Using the isomorphism s and f 0 :
âˆ¼
Le1 âˆ’
â†’ K0 ((y, z) âˆ’ (y0 , z)) âŠ— Fe0 ((y, z0 ) + (y0 , z))
âˆ¼
âˆ’
â†’ K0 âŠ— Fe0 ((y, z0 ) + (y, z))
âˆ¼

âˆ’
â†’ Ï€1âˆ— (L0 (y))
One can check that this isomorphism is actually Ï„1 -equivariant, therefore descent to an isomorâˆ¼
phism: f : L0 (y) âˆ’
â†’ Le1 (I have taken the reverse direction).
Âµ
The Iwahori level structure part is already built up in the proof of the equivalence of Md Î£
e âˆ. 
and Md Ã—k S

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

21

Âµ

Similarly one can form the multiple Hecke correspondence for Md : Hd . The same proof as
Âµ
above can show that there is an isomorphism of self-correspondences of Md Î£ over Ad , when
ÂµÎ£
e âˆ:
Md is identified with Md Ã—k S
âˆ¼

Âµ

Âµ

eâˆ
Hk M âˆ’
â†’ Hd Ã—k S

(3.35)

d

Âµ

and Hd is actually the building block of Hd :
Âµ âˆ¼

Hd âˆ’
â†’ Hd Ã—Î³1 ,Md ,Î³0 Hd Ã—Î³1 ,Md ,Î³0 ... Ã—Î³1 ,Md ,Î³0 Hd

(3.36)

4. G OING TOWARDS THE INTERSECTION NUMBER
4.1. The master diagram. The master diagram plays a key role in Yun-Zhangâ€™s theory. We first
review an auxilary moduli space appearing in this diagram, namely Hd .
e d (Î£) to be the k-stack whose S-points consist of the following:
Definition 4.1. Define H

â€¢ two S-points of BunG (Î£), say E â€  = (E , {E (âˆ’ 21 x )}) and E 0 â€  = (E 0 , {E 0 (âˆ’ 12 x )}), overX Ã—k
S;
â€¢ a morphism of coherent sheaves Ï† : E âˆ’â†’ E 0 preserving the Iwahori level structure, i.e.
sending {E (âˆ’ 21 x )} to {E 0 (âˆ’ 21 x )}. Also, as before, det(Ï†) has degree d and its vanishing
locus is away from Î£.
e d (Î£)/Pic X , and let:
As you know, define Hd (Î£) := H

â†
â†’
âˆ’
â†’
p H = (â†
p H, âˆ’
p H ) : Hd (Î£) âˆ’â†’ BunG (Î£)2 .
be the two projections. Yun and Zhang pointed out the following ([4], Definition 5.7):

âˆ’
â†’
Proposition 4.2. The two projections, â†
p H, âˆ’
p H are representable and smooth of relative dimension 2d.
Therefore, Hd (Î£) is a smooth Artin stack of pure dimension 2d + 3( g âˆ’ 1) + N.
From this definition you can see that the above Md Î£ is simply the following fiber product:
Âµ

Md Î£
Âµ

Bun T1


eâˆ
Ã—k Bun T2 Ã—k S

/ Hd (Î£)


(4.1)

âˆ’
â†’
(â†
p ,âˆ’
p)

/ BunG (Î£)

Since the definition of shtukas involves Atkin-Lehner involution, here we also introduce the
Âµ
Atkin-Lehner involution for Hd (Î£) and Md Î£ . Recall we have the Atkin-Lehner involution for
BunG (Î£), namely ALG,âˆ . For Hd (Î£), its Atkin-Lehner involution AL Hâˆ :
Hd (Î£) Ã—k Sâˆ âˆ’â†’ Hd (Î£)
â€  Ï†

(4.2)
Ï†

(E âˆ’
â†’ E 0â€  , S âˆ’â†’ Sâˆ ) 7âˆ’â†’ ( ALG,âˆ (E â€  ) âˆ’
â†’ ALG,âˆ (E â€  ))

(4.3)

Recall the relation (2.32), define the Atkin-Lehner involution ALM,âˆ in the following way:

Md Î£ âˆ’â†’ Md Î£
Âµ

Âµ

(4.4)
Fr

S
e âˆ ) 7âˆ’â†’ ( AL T ,Âµâˆ (L), AL T ,Âµâˆ (F ), Ï†, S âˆ’âˆ’â†’
e âˆ)
(L, F , Ï†, S âˆ’â†’ S
S âˆ’â†’ S
2
1

(4.5)

Of course as you can see, Hd (Î£) is modeled on the vertical Hecke symmetries of moduli
shtukas. Considering the horizontal Hecke modifications lead one to the following definition:
f Âµ (Î£) to be the stack whose S-points consist of:
Definition 4.3. Letâ€™s define Hk
H
d

â€¢ r-S points of X, say x1 , ..., xr

22

HAO LI

â€¢ a commutative diagram:
f1

E0
Ï†0


E00

f2

/ E1

/ ......

fr

/ ......

f r0

/ Er

Ï†1


/ E0
1

f 10

(4.6)

Ï†r

f 20


/ Er0

e d (Î£)(S). f i and f 0 are isomorphisms away from Î“ x
in which each column is a point of H
i
i
for i = 1, ..., r, and have relative position Âµi .
Âµ
f Âµ (Î£)/Pic X . One has:
Let Hk H (Î£) := Hk
H
d

d

Proposition 4.4.

Âµ
Hk H (Î£)
d

is an Artin stack of dimension 2d + 2r + 3( g âˆ’ 1) + N

Now we are ready for Yun-Zhangâ€™s master diagram, adapted to our current case:
Âµ

Î¸1,Hk Ã—Î¸2,Hk Ã— IdS
e

Âµ

eâˆ
Hk T1 Ã— Hk T2 Ã— S

( Bun T1

/ Hkr (Î£)2 Ã— S
eâˆ o
G

âˆ

Âµ
Âµ
p T ,0 Ã— p T ,0 Ã— IdS
e âˆ ,Î± T
2
1
ÂµÎ£
ÂµÎ£
(Î¸1,Bun
Ã—Î¸2,Bun
)2
2


e âˆ)
Ã— Bun T2 Ã— S
O

â†
â†’
q Ã— IdS
eâˆ

d

p2G,0 ,Î± G


/ BunG (Î£)2 Ã— BunG (Î£)2 o
O

eâˆ
HkrH (Î£) Ã— S
p H,0 ,Î± H

â†
â†
â†’
pâ†’
H Ã— pH


Hd (Î£) Ã— Hd (Î£)
O

id,Fr

id,Fr
Î£ Ã—Î¸ Î£
Î¸1,Bun
2,Bun
Âµ

eâˆ
Bun T1 Ã— Bun T2 Ã— S

id,Fr

â†
pâ†’
H

Âµ

/ BunG (Î£)2 o

Hd (Î£)
(4.7)

Letâ€™s review the meaning of those Î±s appeared above.
(1)
Âµ

Î±T :

Âµ
Hk T1

Ã—

Âµ
Hk T2

pT

Âµ
,r Ã— p T ,r Ã—id e

Sâˆ
1
1
e âˆ âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’
eâˆ
Ã—S
â†’ Bun T1 Ã— Bun T2 Ã— S

(4.8)

AL

T1 ,T2 ,Âµâˆ
eâˆ
âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’
â†’ Bun T1 Ã— Bun T2 Ã— S

(4.9)

e âˆ ) to:
In which AL T1 ,T2 ,Âµâˆ sends (L, F , v(1) : S âˆ’â†’ S

(L(âˆ’

âˆ‘

x âˆˆÎ£âˆ

(1)

Âµ x y x ), F (âˆ’

âˆ‘

x âˆˆÎ£âˆ

(1)

Fr
v
(1)
e âˆ)
Âµ x z x ) , v (2) : S âˆ’
â†’ S âˆ’âˆ’â†’ S

(4.10)

Notice that there is a Frobenius shift on the last factor. From the master diagram, this is
obvious.
p2 Ã—id e

AL2

G,r
G,âˆ
Sâˆ
e âˆ âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’
e âˆ âˆ’âˆ’âˆ’
(2) Î±G : HkrG (Î£)2 Ã— S
â†’ BunG (Î£)2 Ã— S
â†’ BunG (Î£)2

p2 Ã—id e

AL

H,r
H,âˆ
Sâˆ
e âˆ âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’
e âˆ âˆ’âˆ’âˆ’â†’
(3) Î± H : HkrH (Î£) Ã— S
â†’ Hd (Î£) Ã— S
Hd (Î£)
d

How this diagram plays its role in Yun-Zhangâ€™s theory? Because taking the fiber products
of the columns is how we reached the â€œthing we want to computeâ€, taking the fiber product of
the rows is how we are going to compute it.
The fiber product of the columns:
Âµ

Âµ

Âµ

Î¸ Ã— Î¸2

Âµ

Âµ

Âµ

Âµ

0 1
0
0
âˆ’ Sht Hd (Î£; Î£âˆ )0
Sht T1 (Âµâˆ Â· Î£1,âˆ )0 Ã—S
e âˆ Sht T2 ( Âµâˆ Â· Î£2,âˆ ) âˆ’âˆ’âˆ’â†’ Sht G ( Î£; Î£âˆ ) Ã—S
e âˆ Sht G ( Î£; Î£âˆ ) â†
(4.11)
In which:
Âµ
/ Hkr (Î£) Ã— Sâˆ
(4.12)
Sht (Î£; Î£âˆ )
Hd

Hd

p H,0 ,Î± H


Hd (Î£)

id,Fr


/ Hd (Î£) Ã— Hd (Î£)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

23

Âµ

Âµ

e âˆ.
and Sht H (Î£; Î£âˆ )0 = Sht H (Î£; Î£âˆ ) Ã—Sâˆ S
d
d
This looks familiar right? Actually by taking the fiber product of the two arrows one obtains
all âˆ—s in (2.40) for all D âˆˆ Div+ ( X âˆ’ Î£) of degree d collectively. To see it, just observe that one
has the following decomposition:

Ã¤

Âµ

Sht H (Î£; Î£âˆ ) =
d

Âµ

D âˆˆ Divd ( X âˆ’Î£)(k ),degD =d

ShtG (Î£; Î£âˆ , h D )

(4.13)

e âˆ with respect to Sâˆ :
Here for use, base change this equality to S

Ã¤

Âµ

Sht H (Î£; Î£âˆ )0 =
d

Âµ

D âˆˆ Divd ( X âˆ’Î£)(k ),degD =d

ShtG (Î£; Î£âˆ , h D )0

Now taking the fiber product of each row, what you see? The following:
Âµ

Hk M

(4.14)

d

pM,0 ,Î± M

Md Î£
Âµ


Âµ
Ã— Md Î£
O

id,Fr

Md Î£
Âµ

in which: Î±M := ALM,âˆ â—¦ pM,r .
Let the fiber product of these two arrows be:
Definition 4.5.
/ HkÂµ
M

Âµ

ShtM

Âµ
Md Î£

d

(4.15)

d

pM,0 ,Î±M

id,Fr

/ MÂµÎ£
d


Âµ
Ã— Md Î£

Of course, ShtÂµ should coincide with (4.11). Then (4.13) can induce the following decompoÂµ
sition of ShtM :
d

Âµ

ShtM =
d

Âµ

Ã¤

Âµ

ShtM,D

D âˆˆ Div+ ( X âˆ’Î£)(k ),degD =d
Âµ
preimage of Sht H (Î£; Î£âˆ , h D )0 in
d

in which ShtM,D means the
The expectation is the following:

(4.16)

Âµ

ShtM,D .

Âµ

e âˆ ] = [Sht (Î£; Î£âˆ )0 ]
(id, Fr )! [ HkrHd (Î£) Ã— S
Hd

(4.17)

then one has the following equation:
Âµ
0Âµ
0Âµ
0Âµ
0Âµ
e âˆ]
(Î¸1 Ã— Î¸2 )! [Sht Hd (Î£; Î£âˆ )0 ] = (Î¸1 Ã— Î¸2 )! (id, Fr )! [ HkrHd (Î£) Ã— S

(4.18)

If one can check those conditions listed by Yun-Zhang in their first volumn concerning the
master diagram, one should get:
0Âµ

0Âµ

e âˆ ] = (id, Fr )! (Î¸1,Hk Ã— Î¸2,Hk Ã— id e )! [ HkrH (Î£) Ã— S
e âˆ ] (4.19)
(Î¸1 Ã— Î¸2 )! (id, Fr )! [ HkrHd (Î£) Ã— S
Sâˆ
d
If one can check the following:
Âµ

e âˆ ] = [ Hk ]
(Î¸1,Hk Ã— Î¸2,Hk Ã— idSe âˆ )! [ HkrHd (Î£) Ã— S
M
d

(4.20)

the right hand side of the equation would become:
Âµ

(id, Fr )! [ Hk M ]
d

which can be shown is accessible to the Grothendieck-Lefschetz trace formula.

(4.21)

24

HAO LI

4.2. Checking the equations. This section is devoted to check those equations mentioned above.
They basically follow from Yun-Zhangâ€™s fundamental work.
First, checking (4.17). Let (( X âˆ’ Î£)d Ã— X r )â—¦ âŠ‚ (( X âˆ’ Î£)d Ã— X r ) be the locus {( D; x1 , ...xr ) :
Âµ
D is disjoint from x1 , ..., xr }. Then restrict Sht H (Î£; Î£âˆ ) to (( X âˆ’ Î£)d Ã— X r )â—¦ âŠ‚ (( X âˆ’ Î£)d Ã— X r ):
d

Âµ,â—¦
Sht H (Î£; Î£âˆ )
d

/ ShtÂµ (Î£; Î£âˆ )
H


(( X âˆ’ Î£)d Ã— X r )â—¦ Ã— Sâˆ


/ (( X âˆ’ Î£)d Ã— X r ) Ã— Sâˆ

(4.22)

d

Âµ

Then the preimage of each piece on the right hand of the decomposition (4.13) in Sht H (Î£; Î£âˆ )â—¦
Âµ

Âµ

d

is simply ShtG (Î£; Î£âˆ , h D )|(X âˆ’ D)r Ã—Sâˆ , which is eÌtale over ShtG (Î£; Î£âˆ ), therefore is smooth of
Âµ

Âµ

dimension 2r, since ShtG (Î£; Î£âˆ ) is. Then ShtG (Î£; Î£âˆ , h D )0 |(X âˆ’ D)r Ã—S
e âˆ , base change from Sâˆ
e
to Sâˆ , is also smooth of dimension 2r. Then the following diagram is a complete intersection
diagram:
Âµ,â—¦

Sht H (Î£; Î£âˆ )0

/ Hkr,â—¦ (Î£) Ã— S
eâˆ
H


Hd (Î£)


/ Hd (Î£) Ã— Hd (Î£)

d

d

(4.23)

p H,0 ,Î± H
id,Fr

Âµ,â—¦

since Sht H (Î£; Î£âˆ )0 is smooth of the expected dimension:
d

e âˆ + dim( Im(id, Fr )) âˆ’ 2 Â· dimHd (Î£) Ã— Hd (Î£)
dimHkr,Hâ—¦ (Î£) Ã— S

(4.24)

= 2d + 2r + 3( g âˆ’ 1) + N âˆ’ (2d + (3g âˆ’ 1) + N ) = 2r

(4.25)

d

Âµ,â—¦

e âˆ ] = [Sht (Î£; Î£âˆ )0 ]. But one already knows that the dimenTherefore (id, Fr )! [ Hkr,Hâ—¦ (Î£) Ã— S
H
d

Âµ

d

sion of ShtG (Î£; Î£âˆ , h D )0 is 2r (not necessarily smooth though), the equation holds not only after
e âˆ , but entirely, that is to say, one has the expected equation:
restricted to (( X âˆ’ Î£)d Ã— X r )â—¦ Ã— S
Âµ

e âˆ ] = [Sht (Î£; Î£âˆ )0 ]
(id, Fr )! [ HkrHd (Î£) Ã— S
Hd

(4.26)


Next, check the conditions concerning the master diagram.
(1) Condition one: In the master diagram, all stacks except the right top corner, namely
e âˆ are smooth. Basically Yun and Zhang proved all of these in their second
HkrH (Î£) Ã— S
d
e âˆ , this doesnâ€™t affect the
volumn. Here we just take the product of some of them with S
e âˆ is just a product of points.
smoothness since S
(2) Condition two: The following fiber products are of the expected dimension:
Âµ
Âµ
â€¢ The first column: it is Sht T1 (Âµâˆ Â· Î£1,âˆ )0 Ã—Se âˆ Sht T2 (Âµâˆ Â· Î£2,âˆ )0 . It is of dimension
2r. The expected dimension is:
Âµ

Âµ

dimHk T1 + dimHk T2 âˆ’ dimBun T1 âˆ’ dimBun T2

(4.27)

= r + dimBun T1 + r + dimBun T2 âˆ’ dimBun T1 âˆ’ dimBun T2 = 2r

(4.28)

â€¢ The last row: The fiber product is Md Î£ . For d large enough, as we have seen
Âµ
dimMd Î£ = 2d âˆ’ N âˆ’ g + 1. The expected dimension is:
Âµ

dimHd (Î£) âˆ’ dimBun T1 âˆ’ dimBun T2

(4.29)

= 2d + 3( g âˆ’ 1) + N âˆ’ 4( g âˆ’ 1) âˆ’ 2N
= 2d âˆ’ g + 1 âˆ’ N

(4.31)

(4.30)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

25

Âµ

Âµ

â€¢ The middle column: the fiber product is ShtG (Î£; Î£âˆ )0 Ã—Se âˆ ShtG (Î£; Î£âˆ )0 , so its dimension is simply 4r, and the expected dimension is:
Âµ

2dimHk G (Î£) âˆ’ 2dimBunG (Î£)

(4.32)

= 6( g âˆ’ 1) + 2N + 4r âˆ’ 6( g âˆ’ 1) âˆ’ 2N
= 4r

(4.33)
(4.34)

â€¢ The middle row. It is simply double of the last row.
(3) Condition three:
Ã—Î¸

Î¸

Ã—id

Âµ
Âµ
eâˆ
1,Hk
2,Hk
S
e âˆ âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’
e âˆ can be factored into a regular
â€¢ Hk T1 Ã— Hk T2 Ã— S
â†’ HkrG (Î£)2 Ã— S
local immersion followed by a smooth relative Deligne-Mumford type morphism.
Âµ
Yun and Zhang showed this is true for Hk T âˆ’â†’ HkrG (Î£). Therefore the product
i
also has the desired property.
id,Fr

â€¢ Hd (Î£) âˆ’âˆ’â†’ Hd (Î£) Ã— Hd (Î£) satisfy the conditions in (A.2.10) in their first volumn[6].
They proved it in their second volumn, and nothing changed here.
(4) Condition four:
Âµ
Âµ
Âµ
â€¢ ShtM admits a finite flat presentation. ShtM âˆ’â†’ Md Î£ is representable, and in
d
d
âˆ¼
Âµ
â†’ Md Ã— Seâˆ is actually a smooth scheme, as have seen from last
our case M Î£ âˆ’
d

Âµ

section. Therefore ShtM admits a finite flat presentation. For the same reason
d

â€¢

Âµ id,Fr
Âµ
Âµ
Md Î£ âˆ’âˆ’â†’ Md Î£ Ã— Md Î£ is a regular local immersion.
Âµ
Âµ
Sht T (Âµâˆ Â· Î£1,âˆ )0 for i = 1, 2 and ShtG (Î£; Î£âˆ )0 are all
i

smooth Deligne-Mumford

stacks. So

Âµ

Âµ

0
Sht T1 (Âµâˆ Â· Î£1,âˆ )0 Ã—S
e âˆ Sht T2 ( Âµâˆ Â· Î£2,âˆ )
Âµ

Î¸ Ã—Î¸

Âµ

Âµ

Âµ

2
1
0
âˆ’âˆ’âˆ’
â†’
ShtG (Î£; Î£âˆ )0 Ã—S
e âˆ Sht G ( Î£; Î£âˆ )

can automatically be factored as a regular local immersion followed by a smooth
relative Deligne-Mumford type morphism, according to the observation by Yun
and Zhang in their first volumn ([6], Remark A4). 
Âµ

!
r
e
Finally checking (Î¸1,Hk Ã— Î¸2,Hk Ã— idS
e âˆ ) [ Hk Hd ( Î£ ) Ã— Sâˆ ] = [ Hk Md ]. First consider the restricr
r
tion of Hk H (Î£) to ( X âˆ’ Î£)r Ã— X , which means div(Ï†) and the horizontal modification points
d
are disjoint, and denoted by Hkr,Hâ—¦ (Î£). As Yun-Zhang pointed out ([7], Lemma 5.19), the map:
d
HkrH (Î£) âˆ’â†’ HkrG (Î£) Ã— BunG (Î£) Hd (Î£) is an isomorphism when restricted to HkrH (Î£)â—¦ , so
d

Âµ,â—¦

d

Hkr,Hâ—¦ (Î£) is a smooth stack of dimension 3( g âˆ’ 1) + N + 2r + 2d. Therefore Hk M , which means
d

d

Âµ

e âˆ in Hk , should have dimension:
the preimage of Hkr,Hâ—¦ (Î£) Ã— S
M
d

d

Âµ

Âµ

dimHkr,Hâ—¦ (Î£) + dimHk T1 + dimHk T1 âˆ’ 2dimHkrG (Î£)
d

= 3( g âˆ’ 1) + N + 2r + 2d + 2( g âˆ’ 1 + r ) âˆ’ 6( g âˆ’ 1) âˆ’ 2N âˆ’ 4r = 2d âˆ’ g + 1 âˆ’ N
Âµ,â—¦

r,â—¦
!
e
Therefore (Î¸1,Hk Ã— Î¸2,Hk Ã— idS
e âˆ ) [ Hk H ( Î£ ) Ã— Sâˆ ] = [ Hk M ].
d

d

Âµ

Âµ,â—¦

Âµ

The remaining thing to check is that: dim( Hk M âˆ’ Hk M ) < dimHk M . Since there is
âˆ¼

Âµ

Âµ

d

d

d

Âµ

e âˆ , one only has to check a similar inequality for H Ã—
the isomorphism: Hk M âˆ’
â†’ Hd Ã— S
d
Âµ

d

e âˆ . Recall the H from the last section, its points can be considered as: a tuple of divisors
S
d
( E0 , E1 , ...Er ), each of degree 2d âˆ’ N, and a sequence of points (y1 , ..., yr ) such that Ei is obtained
from Eiâˆ’1 by changing a point yi âˆˆ Ei to Ï„3 (yi ); together with âˆ† âˆˆ PicdX (S) and a âˆˆ H 0 (Y3 Ã—
Âµ,â—¦

S, Î½3âˆ— âˆ†) such that D30 âˆˆ div( a) and div( a) âˆ’ D30 = Ï€3 ( Ei ) := E for all i = 1, ...r. Let Hd
Âµ

be the

subscheme of Hd whose points have the property that div( TrY3 /X ) âˆ© (âˆ‘ri=1 Î½3 Ï€3 (yi )). Then a

26

HAO LI

Âµ,â—¦

Âµ

point in Hd âˆ’ Hd is characterized by the following:
div( TrY3 /X ( a)) âˆ© Î½3 ( E) , âˆ…
This implies that there exist an x âˆˆ | X | such that Î½3âˆ’1 ( x ) âŠ‚ E. Now consider the pair (âˆ†(âˆ’ x ), div( a) âˆ’
Î½3âˆ’1 ( x )), it is a point of Adâˆ’1 by the construction. There is a map:
X Ã— Adâˆ’1 âˆ’â†’ Ad

( x, (âˆ†, div( a))) 7âˆ’â†’ (âˆ†( x ), div( a) + Î½3 ( x ))
Then obviously (âˆ†, a) is the image of (âˆ†(âˆ’ x ), div( a) âˆ’ Î½3âˆ’1 ( x )). Therefore the projection of
Âµ

Âµ,â—¦

Hd âˆ’ Hd to Ad lies in the image of X Ã— Adâˆ’1 under the above map. However, one has
dim( X Ã— Ad ) = 1 + 2(d âˆ’ 1) âˆ’ N âˆ’ g + 1 = 2d âˆ’ N âˆ’ g. By the finiteness of the projection,
Âµ
Âµ,â—¦
one has dim(Hd âˆ’ Hd ) â‰¤ dim( X Ã— Ad ) = 2d âˆ’ N âˆ’ g < 2d âˆ’ N âˆ’ g + 1. 
Recall that we have the following diagram:
/ HkÂµ
M

Âµ

ShtM

d

(4.35)

d

pM,0 ,Î±M


Âµ
Md Î£

id,Fr


Âµ
Ã— Md Î£

/ MÂµÎ£
d

Âµ

ÂµÎ£
!
r
e
Let Î¶ = [ Hk M ] = (Î¸1,Hk Ã— Î¸2,Hk Ã— idS
e âˆ ) [ Hk Hd ( Î£ ) Ã— Sâˆ ]. Then from the smoothness of Md ,
d
one knows that:
Âµ
(id, Fr )! Î¶ âˆˆ Ch0 (ShtM,d )
(4.36)

is well defined.
Âµ
Using the decomposition (4.13), define ((id, Fr )! Î¶ ) D âˆˆ Ch0 (ShtM,D ) be the D-component.
Âµ

Since ShtM is proper, one can take the degree, and define:
d

hÎ¶, Î“( FrMÂµÎ£ )i D := deg((id, FrMÂµÎ£ )! Î¶ ) D
d

(4.37)

d

From all have been checked above, one has:
Proposition 4.6. Suppose D is an effective divisor on X âˆ’ Î£ of degree d such that 2d â‰¥ 2(2g3 âˆ’ 1) âˆ’
Âµ
1 + N (as we have seen, this is for the dimension purpose of Md Î£ ), then one has:

hZ1 , h D âˆ— Z2 i = hÎ¶, Î“( FrMÂµÎ£ )i D
Âµ

Âµ

(4.38)

d

From all the facts in the last subsection, one has:
0Âµ

0Âµ

0Âµ

Âµ

0Âµ

e âˆ]
(Î¸1 Ã— Î¸2 )! [Sht Hd (Î£; Î£âˆ )0 ] = (Î¸1 Ã— Î¸2 )! (id, Fr )! [ HkrHd (Î£) Ã— S

(4.39)

e âˆ]
= (id, Fr )! (Î¸1,Hk Ã— Î¸2,Hk Ã— idSe âˆ )! [ HkrHd (Î£) Ã— S

=

Âµ
(id, Fr )! [ Hk M ]
d

(4.40)

= (id, Fr )! Î¶

(4.41)

Extracting the D-component and taking the degree, one gets:
0Âµ

0Âµ

Âµ

deg((Î¸1 Ã— Î¸2 )! [Sht H (Î£; Î£âˆ ; h D )0 ]) = deg((id, Fr )! Î¶ ) D

(4.42)

d

By definition, left hand side is hZ1 , h D âˆ— Z2 i while the right hand side is hÎ¶, Î“( FrMÂµÎ£ )i D .
Âµ

Âµ

d

4.3. The intersection number and the Grothendieck-Lefschetz trace formula. Define the â€œmodÂµ
uli of shtukasâ€ Sd , for Md as follow first:
/ HÂµ
d

Âµ

Sd


Md

( pH,0 ,pH,r )

(id,Fr )


/ Md Ã— Md

(4.43)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

27

e âˆ:
Base change all the spaces above to S
/ HÂµ Ã— S
eâˆ
d

Âµ

eâˆ
Sd Ã— S

eâˆ
Md Ã— S

(4.44)

( pH,0 Ã—idSe âˆ ,pH,r Ã—idSe âˆ )

(id,Fr Ã—idSe âˆ )


/ (Md Ã— S
e âˆ ) Ã— (Md Ã— S
e âˆ)

We want to compare this diagram with (4.5). From meaning of its functor of points,
/ HkÂµ
M

Âµ

ShtM

Âµ
Md Î£

d

(4.45)

d

( pM,0 ,pM,r )

1
(id,ALâˆ’
M,âˆ â—¦ Fr )

/ MÂµÎ£
d


Âµ
Ã— Md Î£

Actually (4.44) and (4.45) are isomorphic, with the assistance of the following lemma:
Lemma 4.7. The following diagram is commutative:
eâˆ
Md Ã— S

Âµ
Md Î£

Fr Ã—idS
e

âˆ

/ Md Ã— S
eâˆ

(4.46)


/ MÂµÎ£
d

1
(id,ALâˆ’
M,âˆ â—¦ Fr )

Iâ€™m going to check the diagram with the vertical arrows reversed. Since one can checks it
locally, here I only check one x âˆˆ Î£âˆ . In other words I assume Î£âˆ = { x } and Î£ f = âˆ…. Take an
S-object of the left bottom corner:

(L, F , x : S âˆ’â†’ Speck vx , Ï† : Î½1,âˆ— L âˆ’â†’ Î½2,âˆ— F ).
Going up along the reversed left arrow, one gets:

Le âŠ— Fe (âˆ’(y(d+1) , z(1) ) âˆ’ ... âˆ’ (y(2d) , z(d) )), x : S âˆ’â†’ Speck vx .
Then going along the top horizontal arrow, one gets:
Ï„

Le âŠ— Ï„ Fe (âˆ’(y(d+2) , z(2) ) âˆ’ ... âˆ’ (y(2d) , z(d) ) âˆ’ (y(1) , z(d+1) ))

On the other hand, if the original objects goes along the bottom horizontal arrow, it becomes:
Ï„

eâˆ
L(y(1) ), Ï„ F (z(1) ), x : S âˆ’â†’ S

Then going up long the right vertical arrow, one gets:
Ï„

Le âŠ— Ï„ Fe (âˆ’(y(1) , z(1) ) âˆ’ (y(1) , z(d+1) ) + (y(1) , z(1) ) + (y(d+1) , z(1) )
âˆ’(y(d+1) , z(1) ) âˆ’ (y(d+2) , z(2) )... âˆ’ (y(2d) , z(d) ))

One can see that (y(1) , z(1) ) and (y(d+1) , z(1) ) both cancel away, so the remaining is:
Ï„

Le âŠ— Ï„ Fe (âˆ’(y(1) , z(d+1) ) âˆ’ (y(d+2) , z(2) ) âˆ’ ... âˆ’ (y(2d) , z(d) ))

It is the same as you going the other way around as above. 
Âµ
âˆ¼
Âµ
e âˆ ]. Since we just
e âˆ , we still use Î¶ for [H Âµ Ã— S
â†’ Hd Ã— S
Now via the identification Hk M âˆ’
d
d
saw that one can identify (4.45) with (4.44), it is ok to instead consider
e âˆ]
(id, Fr Ã— idSe âˆ )! Î¶ = (id, Fr Ã— idSe âˆ )! [Hd Ã— S
Âµ

= ((id, Fr )

!

Âµ
e âˆ ])
[Hd ] Ã— [S

âˆˆ

Âµ
Ch0 (Sd

(4.47)
e âˆ)
Ã—S

(4.48)

Extracting the D component one gets:
e âˆ ) Â· h[H ], Î“( Fr )i D
h(Î¶, Î“( Fr ))i D = deg(S
d
Âµ

(4.49)

28

HAO LI

fd

Âµ

As you know, the image of the map Sd âˆ’â†’ Md âˆ’
â†’ Ad is in the rational points of Ad , i.e.
A(k). This is because any point in its image is â€œthe sameâ€ as its Frobenius twist, therefore must
Âµ
descent to k. Sd can be decomposed in the following way:

Ã¤

Âµ

Sd =

aâˆˆA(k )

Âµ

Sd ( a)

(4.50)

Under the identification of (4.45) with (4.44), one has:
âˆ¼

Âµ

Ã¤

â†’
ShtM âˆ’
D

Âµ

aâˆˆA D (k )

Sd ( a)

(4.51)

[Hd ] defines a cohomological self-correspondence of (Md , Ql ), therefore induces an endomorphism of the cohomology sheaf (complex) R f d,! Ql :
Âµ

f d,! [Hd ] : R f d,! Ql âˆ’â†’ R f d,! Ql
Âµ

(4.52)

According to Yun-Zhang, one can apply the Grothendieck-Lefschetz trace formula to the
diagram (4.43), getting the following formula:

h[Hd ], Î“( Fr )i D =

âˆ‘

Âµ

Tr( f d,! [Hd ] â—¦ Fr a , (R f d,! Ql ) a )
Âµ

aâˆˆA D (k )

(4.53)

Âµ

In which a is the geometric point sitting over a. Since Hd is built up from composing the
Âµ
building block Hd with itself, one can furthur writes f d,! [Hd ] = ( f d,! [Hd ])r .
In summary, we reach the following:
Proposition 4.8. Suppose D has degree greater than 2g3 âˆ’ 1 + N, then one has:
Âµ

Âµ

hZ1 , h D âˆ— Z2 i = (

âˆ

2d x ) Â·

x âˆˆÎ£âˆ

in other words:
IÂµ ( h D ) =

âˆ‘

aâˆˆA D (k )

âˆ‘

Tr( f d,! [Hd ] â—¦ Fr a , (R f d,! Ql ) a )
Âµ

aâˆˆA D (k )

Tr( f d,! [Hd ] â—¦ Fr a , (R f d,! Ql ) a )
Âµ

(4.54)

(4.55)

5. T HE ANALYTIC SIDE
e âˆ , for each x âˆˆ Î£ f
5.1. The moduli space on the analytic side. Recall that we fixed a choice of S
Î£f
Î£
an over point in Y, and (Âµ f , Âµâˆ ) âˆˆ {Â±1} Ã— {Â±1} âˆ . This choice defined a divisor D30 =
âˆ‘ xâˆˆÎ£ f w0x on Y3 .
Now fix a nonnegative integer d. For any pair of nonnegative integers (d1 , d2 ) such that
d1 + d2 = 2d, define the following moduli space:
f(d ,d ) be the stack over k whose functor of points on a k-scheme S consistDefinition 5.1. Let N
1 2
ing of the following:
â€¢ A line bundle L on Y3 Ã—k S, a splitted rank 2 vector bundle L1 âŠ• L2 on X Ã—k S.
â€¢ A map of coherent sheaves over X Ã—k S, Ï† : Î½3,âˆ— L âˆ’â†’ L1 âŠ• L2 , such that degÏ† = d and
div(det(Ï†)) is away from Î£. Also we require Ï†(Î½3,âˆ— (L(âˆ’w0x ))) âŠ‚ L1 âŠ• L2 (âˆ’ x ) for each
x âˆˆ Î£.
â€¢ 2degL1 âˆ’ degL = d1 and 2degL2 âˆ’ degL = d2
f(d ,d ) modulo the action of Pic X . Collecting all
Then as usual, N(d1 ,d2 ) is defined to be N
1 2
(d1 , d2 ) such that d1 + d2 = 2d, one can denote:

Nd =

Ã¤

d1 +d2 =2d

N(d1 ,d2 ) .

(5.1)

This N(d1 ,d2 ) fits into a commutative diagram similar to (3.18), in particular, admits a â€œHitchin
type fiberationâ€ over the moduli space Ad . To get it, first base change Ï† to Y3 , one gets:

L âŠ• Ïƒ3âˆ— L âˆ’â†’ Î½3âˆ— L1 âŠ• Î½3âˆ— L2

(5.2)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

29

Let Ï†11 : L âˆ’â†’ Î½3âˆ— L1 and Ï†21 : L âˆ’â†’ Î½3âˆ— L2 . Then the condition Ï†(Î½3,âˆ— (L(âˆ’w0x ))) âŠ‚ L1 âŠ•
L2 (âˆ’ x ) for each x âˆˆ Î£ becomes:

L(âˆ’w0x ) âŠ• Ïƒ3âˆ— L(âˆ’wx ) âˆ’â†’ Î½3âˆ— L1 âŠ• Î½3âˆ— L2 (âˆ’wx âˆ’ w0x )

(5.3)

This puts restrictions on Ï†21 :
Ïƒ3 (Ï†21 )|w0x = 0 and Ï†21 |wx = 0

(5.4)

Therefore one can view Ïƒ3 (Ï†21 ) as a section of the line bundle Ïƒ3âˆ— Lâˆ’1 âŠ— Î½3âˆ— L2 (âˆ’ D30 ), which is of
degree d2 âˆ’ N. By recording Ï†11 and Ïƒ3 (Ï†21 ), one gets the following morphism:

N(d1 ,d2 ) âˆ’â†’ YÌ‚3,d1 Ã—k YÌ‚3,d2 âˆ’ N

(5.5)

(L, L1 , L2 ) 7âˆ’â†’ ((Lâˆ’1 âŠ— Î½3âˆ— L1 , Ï†11 ), (Ïƒ3 âˆ— Lâˆ’1 âŠ— Î½3âˆ— L2 (âˆ’ D30 ), Ïƒ3 (Ï†21 ))

(5.6)

Taking the tensor product of Ï†11 and Ïƒ (Ï†21 ), one gets Ï†11 âŠ— Ïƒ3 (Ï†21 ) as a section of Lâˆ’1 âŠ—
Ïƒ3âˆ— Lâˆ’1 âŠ— Î½3âˆ— L1 âŠ— Î½3âˆ— L2 vanishing at D30 . But Lâˆ’1 âŠ— Ïƒ3âˆ— Lâˆ’1 âŠ— Î½3âˆ— L1 âŠ— Î½3âˆ— L2 is nothing but Î½3âˆ— âˆ†,
in which âˆ† is det(Î½3,âˆ— L)âˆ’1 âŠ— det(L1 âŠ• L2 ).
The fact that Lâˆ’1 âŠ— Î½3âˆ— L admits a global section Ï†11 implies that d1 â‰¥ 0 and Ïƒ3 (Ï†21 ) must
vanish at D30 forces d2 â‰¥ N, one has:

Nd =

Ã¤

d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N

N(d1 ,d2 )

(5.7)

From the definition, one obviously has the commutative diagram:

N(d1 ,d2 )

/ YÌ‚3,d Ã—k YÌ‚3,d âˆ’ N
2
1


Ad


/ YÌ‚3,2dâˆ’ N

(5.8)

Actually one has the following:
Proposition 5.2. This diagram is Cartesian.
It is amount to showing that given: (âˆ†, a) âˆˆ Ad (S) and (K1 , Ï†11 ) âˆˆ YÌ‚3,d1 , (K2 , Ï†22 ) âˆˆ YÌ‚3,d2 âˆ’ N
âˆ¼
together with an isomorphism Î½3âˆ— âˆ†(âˆ’ D30 ) âˆ’
â†’ K1 âŠ— K2 carrying a0 to Ï†11 âŠ— Ï†22 (recall that I use
a0 to mean a viewed as a section of Î½3âˆ— âˆ†(âˆ’ D30 ).), one can reconstruct a unique object in N(d1 ,d2 ) .
It is more or less the same as what Howard-Shnidman did, but paying attention to the sublattice
or vanishing of the sections at D30 .
âˆ¼
â†’ K1 âŠ— K2 by D30 , one gets:
Let K20 = K2 ( D30 ). Twisting the isomorphism Î½3âˆ— âˆ†(âˆ’ D30 ) âˆ’
âˆ¼

Î½3âˆ— âˆ† âˆ’
â†’ K1 âŠ— K2 ( D30 ) = K1 âŠ— K20
Take L1 to be any line bundle over X Ã—k S. Then you can guess that L is simply defined to be
K1âˆ’1 âŠ— Le1 . Then from the definition of the map N(d1 ,d2 ) âˆ’â†’ YÌ‚3,2dâˆ’ N , one can guess that Î½3âˆ— L2
should be defined as Ïƒ3âˆ— L âŠ— K20 . So one has to show that Ïƒ3âˆ— L âŠ— K20 can descent to X to get L2 ,
but:
Ïƒ3âˆ— (Ïƒ3âˆ— L âŠ— K20 ) = Ïƒ3âˆ— (Ïƒ3âˆ— K1âˆ’1 âŠ— Ïƒ3âˆ— Î½3âˆ— L1 ) âŠ— Ïƒ3âˆ— K20
âˆ¼

âˆ¼

â†’ K1âˆ’1 âŠ— Ïƒ3âˆ— K1âˆ’1 âŠ— Î½3âˆ— âˆ† âŠ— Î½3âˆ— L1
âˆ’
â†’ K1âˆ’1 âŠ— Î½3âˆ— L1 âŠ— Ïƒ3âˆ— K20 âˆ’
âˆ¼

âˆ¼

âˆ’
â†’ (K1âˆ’1 âŠ— Î½3âˆ— âˆ†) âŠ— Ïƒ3âˆ— K1âˆ’1 âŠ— Î½3âˆ— L1 âˆ’
â†’ K20 âŠ— Ïƒ3âˆ— (K1âˆ’1 âŠ— Î½3âˆ— L1 )
âˆ¼

âˆ’
â†’ Ïƒ3âˆ— L âŠ— K20
All the isomorphisms are either canonical or from the definition. Therefore, Ïƒ3âˆ— L âŠ— K20 is an Ïƒ3 equivariant line bundle, hence descent to X. One can view Ï†11 as a section of HomOY (L, Î½3âˆ— L1 )
3

30

HAO LI

and Ï†22 as a section of HomOY (L, Î½3âˆ— L2 ) vanishing at D30 . Now the homomorphisms of line
3
bundles over Y3 :
Ï†11 : L âˆ’â†’ Î½3âˆ— L1
âˆ¼

Ï†12 = Ïƒ3 (Ï†11 ) : Ïƒ3âˆ— L âˆ’â†’ Ïƒ3âˆ— Î½3âˆ— L1 âˆ’
â†’ Î½3âˆ— L1
âˆ¼

Ï†21 = Ïƒ3 (Ï†22 ) : Ïƒ3âˆ— L âˆ’â†’ Ïƒ3âˆ— Î½3âˆ— L2 âˆ’
â†’ Î½3âˆ— L2
Ï†22 : L âˆ’â†’ Î½3âˆ— L2
descent to a homomorphism: Ï† : Î½3,âˆ— L âˆ’â†’ L1 âŠ• L2 . Since Ï†22 vanishes at D30 and Ï†21 vanishes
at Ïƒ3 ( D30 ), Ï† actually sends Î½3,âˆ— (L(âˆ’w0x )) to L1 âŠ• L2 (âˆ’ x ) for each x âˆˆ Î£. 
e3 = GL2,Î½ O be the group scheme over X whose functor of
5.2. The orbital integral. Recall G
âˆ— Y3
e3 /Z ( G
e3 ). Also, G = PGL2,X .
points on an X-scheme U is H 0 (U, EndOU ( f âˆ— (Î½âˆ— OY3 ))), G3 = G
âˆ—
The pushfoward Î½3 OY3 is not isomorphic to O X âŠ• O X , but their generic fibers are simply K3
and F âŠ• F, both 2-dimensional vector space over F. Fix an isomorphism Ï : F âŠ• F âˆ’â†’ K3 . This
isomorphism induces isomorphisms: Fx âŠ• Fx âˆ’â†’ (K3 ) x for all x âˆˆ | X |. Almost all of them are
integral, except at finitely many xs. Therefore it induces an isomorphism: Ï : A âŠ• A âˆ’â†’ A3 ,
in which A is the adelic ring of X, and A3 = K3 âŠ— F A. It carries O âŠ• O not exactly to O3 .
One can take an h âˆˆ G3 (A) such that Ï(O âŠ• O) = h Â· O3 . Any x âˆˆ Î£ splits in K3 into wx
and w0x as we have seen above. Therefore one has (K3 ) x = Kwx âŠ• Kw0x and each one of them is
isomorphic to Fx as local fields. For later use, I furthur require that hâˆ’1 carries Ï(Ox âŠ• vx Ox )
into Owx âŠ• vw0x Ow0x . Use Ï and h, one can define the following maps:
Ï : GF âˆ’â†’ G3,F , g 7âˆ’â†’ Ï â—¦ g â—¦ Ïâˆ’1

(5.9)

Ï Â· h : G (A) âˆ’â†’ G3 (A), g 7âˆ’â†’ Ï â—¦ g â—¦ Ïâˆ’1 Â· h

(5.10)

The first map is an isomorphism of group schemes over F, not over X, and the second map
is an isomorphism of topological spaces, not a group homomorphism. Via the first isomorphism of group schemes, one gets a one to one correspondence between the Borel subgroups of
G0 (A) and G3 (A). Via the second isomorphism of topological spaces, one identify the space of
automorphic forms on them:
L2 ( G ( F )\ G (A)) âˆ’â†’ L2 ( G3 ( F )\ G3 (A))
Ï† 7âˆ’â†’ Ï†3 : y 7âˆ’â†’ Ï†(Ï

âˆ’1

â—¦ (y Â· h

(5.11)
âˆ’1

) â—¦ Ï)

(5.12)

Even though there is such a weird h here, one still has the following:
Proposition 5.3. The above map of function spaces enjoys the properties:
(1) It identifies L2cusp ( G ( F )\ G (A)) with L2cusp ( G3 ( F )\ G3 (A)).
f x be the Iwahori subgroup of G (Ox ) stablizing the lattice chain: Ox âŠ• Ox âŠƒ Ox âŠ• vx Ox
(2) Let Iw
f w0 be the Iwahori subgroup of G3 (Ox ) stablizing the lattice chain: Ox âŠ• Owx âŠƒ Ow0 âŠ•
and Iw
x

x

vw0x Ow0x . Let Iw x and Iww0x be their image in G (Ox ) and G3 (Ox ). Then the above maps
induces:
L2 ( G ( F )\ G (A))G(O

Î£ )Ã—

âˆ xâˆˆÎ£ Iw x

âˆ’â†’ L2 ( G3 ( F )\ G3 (A))

G3 (OÎ£ )Ã—âˆ xâˆˆÎ£ Iww0

x

(5.13)

For the first part, recall that Ï† âˆˆ L2cusp ( G ( F )\ G0 (A)) if it satisfy the following equation:


Z
1 x
Ï†(
g)dx = 0
0 1
F \A
for any Borel subgroup (the above equation is for the standard upper triangular one) and any
g. Since Ï : GF âˆ’â†’ G3,F is an isomorphism of group schemes, it induces a one to one correspondence between the Borels of GF and those of G3,F . Now let Ï†3 be the function on G3 (A)
correspond to Ï† as above, consider the following integral:

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

Z



1
Ï†3 (Ï â—¦
0
F \A

31


x
â—¦ Ïâˆ’1 Â· y)dx = 0
1

Using the relation between Ï† and Ï†3 :


1 x
Ï†3 (Ï â—¦
â—¦ Ï âˆ’1 Â· y )
0 1


1 x
= Ï† ( Ï âˆ’1 â—¦ Ï â—¦
â—¦ Ï âˆ’1 Â· y Â· h âˆ’1 â—¦ Ï )
0 1


1 x
= Ï†(
Â· Ï âˆ’1 â—¦ y Â· h âˆ’1 â—¦ Ï )
0 1
Therefore one has the equation:



Z
Z
1 x
1
Ï†3 (Ï â—¦
â—¦ Ïâˆ’1 Â· y)dx =
Ï†(
0 1
0
F \A
F \A


x
Â· Ïâˆ’1 â—¦ y Â· hâˆ’1 â—¦ Ï)dx
1

Now Ïâˆ’1 â—¦ y Â· hâˆ’1 â—¦ Ï is an element of G (A), so by the cupidality of Ï†, the right hand side
integral vanishes, therefore also the left hand side one.
For the second part, one needs to check that Ï†3 (y Â· g) = Ï†3 (y) for any g âˆˆ G3 (OÎ£ ) Ã—
âˆ xâˆˆÎ£ Iww0x , if Ï† is fixed by G (OÎ£ ) Ã— âˆ xâˆˆÎ£ Iwx . First letâ€™s check for g âˆˆ idÎ£ Ã— âˆ xâˆˆÎ£ Iww0x . To see
this:
Ï†3 (y Â· g) = Ï†(Ïâˆ’1 â—¦ y Â· g Â· hâˆ’1 â—¦ Ï)

= Ï†((Ïâˆ’1 â—¦ y Â· hâˆ’1 â—¦ Ï) Â· (Ïâˆ’1 â—¦ h Â· g Â· hâˆ’1 â—¦ Ï))
As I required, hâˆ’1 Â· Ï(Ox âŠ• vx Ox ) = Owx âŠ• vw0x Ow0x for every x âˆˆ Î£. Since g âˆˆ âˆ xâˆˆÎ£ Iwwx , one
gets: g Â· hâˆ’1 Â· Ï(Ox âŠ• vx Ox ) = Owx âŠ• vw0x Ow0x . Therefore Ïâˆ’1 â—¦ h Â· g Â· hâˆ’1 â—¦ Ï stablizes the lattice
chain: Ox âŠ• Ox âŠƒ Ox âŠ• vx Ox , therefore is in âˆ xâˆˆÎ£ Iwx . Therefore one finds:
Ï†((Ïâˆ’1 â—¦ y Â· hâˆ’1 â—¦ Ï) Â· (Ïâˆ’1 â—¦ h Â· g Â· hâˆ’1 â—¦ Ï))

= Ï†(Ïâˆ’1 â—¦ y Â· hâˆ’1 â—¦ Ï) = Ï†3 (y)
The spherical part is the same, only easier because you only have to care about the maximal
lattices not lattice chains. 
To relate the orbital side of relative trace formula to the moduli space on the analytic side,
one needs the following J space, introduced by Howard and Shnidman.
Definition 5.4. Let e
J be the following functor over X:

(Sch/X ) âˆ’â†’ ( Ens)
U 7âˆ’â†’ IsomOU (Î½3,âˆ— OY3 , O X âŠ• O X )
It is representable by a scheme over X. Let J be e
J/Gm,X . It is a G Ã— G3 bitorsor.
One can take its adelic point:
J (A) = IsoA (A3 , A âŠ• A)/Aâˆ—
Using Ï and h, it can be identified with G (A) as topological spaces:
J (A) âˆ’â†’ G (A)
Ïˆ 7âˆ’â†’ Ïˆ â—¦ h

âˆ’1

(5.14)

â—¦Ï

(5.15)

This map has the property:
f J,x be the subspace of e
Proposition 5.5. Let Iw
J (Ox ) sending the lattice chain Ox âŠ• Owx âŠƒ Ow0x âŠ•
vw0x Ow0x to the lattice chain Ox âŠ• Ox âŠƒ Ox âŠ• vx Ox for each x âˆˆ Î£. Let Iw J,x be its image in J (Ox ).
Then the above isomorphism of topological spaces identifies Iw J,x with Iwx . Away from Î£, it identifies
J (Ox ) with G (Ox ).

32

HAO LI

Let Ccâˆ ( G (A)) be the compactly supported group algebra (test functions) of G (A). Via the
above isomorphism of topological spaces, one can get the an isomorphism of function spaces:
Ccâˆ ( G (A)) âˆ’â†’ Ccâˆ ( J (A))

(5.16)

f 7âˆ’â†’ f J : Ïˆ 7âˆ’â†’ f (Ïˆ â—¦ h

âˆ’1

â—¦ Ï)

(5.17)

We also identify J ( F ) and G ( F ) as follows:
G ( F ) âˆ’â†’ J ( F )

(5.18)

Î³ 7âˆ’â†’ Î³ â—¦ Ï

(5.19)

Note that it is different from the map on the adelic points.
Recall the integration kernel for f âˆˆ Ccâˆ ( G (A) in the trace formulae:
K f : G (A) Ã— G (A) âˆ’â†’ Ql

( g0 , g00 ) 7âˆ’â†’

(5.20)

âˆ‘

f ( g0âˆ’1 Î³g00 )

(5.21)

Î³âˆˆ G ( F )

To relate it with the moduli space on the analytic side, we want to â€œmakeâ€ it a kernel function
on G (A) Ã— J (A).
Proposition 5.6. Let f and f J be the functions on G (A) and J (A) respectively, matching each other as
(5.16). Let Î³0 âˆˆ G ( F ) and Î³ = Î³0 â—¦ Ïâˆ’1 âˆˆ J (A). Let g3 âˆˆ G3 (A) and g00 âˆˆ G (A) match each other
as in (5.10). Then one has:
f J ( g0âˆ’1 Î³g3 ) = f ( g0âˆ’1 Î³0 g00 )
(5.22)
To see it:
f J ( g0âˆ’1 Î³g3 ) = f ( g0âˆ’1 Î³g3 â—¦ hâˆ’1 â—¦ Ï)

= f ( g0âˆ’1 Î³ â—¦ Ï â—¦ Ïâˆ’1 â—¦ g3 â—¦ hâˆ’1 â—¦ Ï)
By (5.10), one has Ïâˆ’1 â—¦ g3 â—¦ hâˆ’1 â—¦ Ï = g00 . Also since Î³0 = Î³ â—¦ Ï, one sees the right hand side is
exactly f ( g0âˆ’1 Î³0 g00 ). 
For f J , define:
K f J : G (A) Ã— G3 (A) âˆ’â†’ Ql

( g0 , g3 ) 7âˆ’â†’

âˆ‘

(5.23)
f J ( g0âˆ’1 Î³g3 )

(5.24)

Î³âˆˆ J ( F )

Let A âŠ‚ G be the diagonal torus and T3 = ResY3 /X Gm /Gm be the nonsplit torus determined
by Y3 naturally sitting inside G3 as in the introduction. By Howard-Shnidman, the fourfold
cover Y defines a character Î· of T3 (A) = A3âˆ— /Aâˆ— . Let:
A(A)n = {t0 âˆˆ A(A) : deg(t0 ) = n}
and [ A]n = A( F )\ A(A)n . For any f J âˆˆ
Jn ( f J , s ) =

Ccâˆ ( J (A),

Z
[ A]n Ã—[ T3 ]

= qâˆ’2ns

(5.25)

define the integral:

K f J (t0 , t3 )|t0 |2s Î· (t3 )dt0 dt3

(5.26)

K f J (t0 , t3 )Î· (t3 )dt0 dt3

(5.27)

Z
[ A]n Ã—[ T3 ]

and one has the fact:
Proposition 5.7. The integral Jn ( f J , s) vanishes for |n| sufficiently large.
Therefore it is legitimate to define:
J( f J , s ) =
Also, let:
K f J ,Î³ ( g0 , g3 ) =

âˆ‘

n âˆˆZ

Jn ( f J , s )

âˆ‘

Î´âˆˆ A( F )Î³T3 ( F )

f J ( g0âˆ’1 Î´g3 )

(5.28)

(5.29)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

33

For any Î³ âˆˆ J ( F ) and g0 âˆˆ G ( F )\ G (A), g3 âˆˆ G3 ( F )\ G3 (A). One also define:
Jn (Î³, f J , s) =

Z
[ A]n Ã—[ T3 ]

K f J ,Î³ (t0 , t3 )|t0 |2s Î· (t3 )dt0 dt3

and
J( f J , s ) =

(5.30)

âˆ‘ J(Î³, f J , s)

(5.31)

âˆ‘

Jn (Î³, f J , s)

(5.32)

âˆ‘

J(Î³, f J , s)

(5.33)

nâˆˆÎ£

so that:
Jn ( f J , s ) =

Î³âˆˆ A( F )\ J ( F )/T3 ( F )

and
J( f J , s ) =

Î³âˆˆ A( F )\ J ( F )/T3 ( F )

Recall that Howard and Shnidman defined the invariants of A( F )\ J ( F )/T3 ( F ):
Proposition 5.8. There is a bijection:
inv : A( F )\ J ( F )/T3 ( F ) âˆ’â†’ { a âˆˆ K3 : TrK3 /F ( a) = 1}

(5.34)

Let me review their proof. Actually this is the generic fiber version of the Hitchin type
fiebration introduced above. Take a morphism of F-vector spaces:
Ï† : K3 âˆ’â†’ F âŠ• F
base change it to SpecK3 (the double cover) to split K3 (the rank two vector bundle):
Ï†âŠ—id

âˆ¼

âˆ¼

K3 âŠ• K3 âˆ’
â†’ K3 âŠ— K3 âˆ’âˆ’â†’ K0 âŠ— F K3 âˆ’
â†’ K3 âŠ• K3
As in its geometrization, one gets the maps of K3 -vector spaces:
Ï†11 : K3 âˆ’â†’ K3 , Ïƒ3 (Ï†11 ) : K3 âˆ’â†’ K3
Ï†21 : K3 âˆ’â†’ K3 , Ïƒ3 (Ï†21 ) : K3 âˆ’â†’ K3
In which Ïƒ3 ( a) and Ïƒ3 (c) are Ïƒ3 -linear. Let:
âˆ† = Hom F (det F (K3 ), det F ( F âŠ• F ))
Then det F (Ï†) is an element of this vector space (a section of this line bundle over the generic
point of X).
Now the invariant map is defined to be inv(Ï†) = (Ï†11 Â· Ïƒ3 (Ï†21 ))/det(Ï†). The map Ï† is called
regular if a = inv(Ï†) is not 0 in K3 . 
Therefore one can also index the double cosets in A( F )\ J ( F )/T3 ( F ) by their invariants, i.e.:
J( f J , s ) =

âˆ‘

J(Î³, f J , s) =

Î³âˆˆ A( F )\ J ( F )/T3 ( F )

âˆ‘

J( a, f J , s)

(5.35)

aâˆˆK3 ,TrK3 /F ( a)=1

5.3. The orbital integral and the period integral. The relative trace formula relates the orbital
integral with certain period integrals summed over automorphic forms. Let Ï€ be a cuspidal
automorphic representation of G (A). For any Ï† âˆˆ Ï€, define the period integral along A(A):
P0 (Ï†, s) =

Z
[ A]

Ï†(t0 )|t0 |2s dt0

(5.36)

Using (5.3), one can move acusp form Ï† on G (A) to a cusp form Ï†3 on G3 (A). Define the period
of Ï†3 along T3 (A):
Z
P3,Î· (Ï†3 ) =

[ T3 ]

Ï†3 (t3 )Î· (t3 )dt3

(5.37)

Both integrals are absolutely convergent. For T3 there is no variable since it is anisotropic.
Define the global spherical character relative to ( A Ã— T3 , 1 Ã— Î· ) as:
JÏ€ ( f J , s ) =

âˆ‘
Ï†

P0 (Ï€ ( f )Ï†, s)P3,Î· (Ï†3 )
hÏ†, Ï†i

(5.38)

34

HAO LI

in which f âˆˆ Ccâˆ ( G (A)) is the function correspond to f J and Ï†3 is the automorphic form of
G3 (A) corresponding to Ï†. The sum is over an orthogonal basis of Ï†, and hÏ†, Ï†i is the Petersson
inner product of Ï† with itself.
Now letâ€™s choose the test function to be used. In their second volumn, Yun and Zhang
Î£ âˆˆ H Î£ . And they proved the following theorem:
defined the Eisenstein ideal I Eis
G
Î£ . Take any f âˆˆ C âˆ ( G (A )) such that it is left invariant under the Iwahori
Theorem 5.9. Let f âˆˆ I Eis
Î£
c
subgroup âˆ xâˆˆÎ£ Iwx . Then the kernel function of f Î£ = f âŠ— f Î£ has vanishing Eisenstein part, i.e.:

K f Î£ = K f Î£ ,cusp + K f Î£ ,sp
In other words, K f only has cuspidal and residual parts.
Please notice that f Î£ doesn0 t mean the product of the components away from Î£ as usual,
N
Î£ .
it is a product over all primes. Consider the test function f Î£ = f âŠ— ( xâˆˆÎ£ 1 Iwx ) for f âˆˆ I Eis
N
Î£
Then f J has the form f J = f J âŠ— ( xâˆˆÎ£ 1 Iw J,x ). Define the
Proposition 5.10. For each f Î£ of the form above, one has:
J( f JÎ£ , s) =

JÏ€ ( f JÎ£ , s)

âˆ‘

(5.39)

Ï€

where the sum is over all Ï€ with G (AÎ£ ) Ã— âˆ xâˆˆÎ£ Iwx fixed vector.
First on G (A), one has:
K f Î£ ( g0 , g00 ) = âˆ‘

Ï†( g0 )Ï†( g00 )
hÏ†, Ï†i

Î»Ï€ ( f ) Â·

Ï€

+âˆ‘

Î»Ï‡ ( f ) Â· Â·Ï‡(det( g0 )) Â· Ï‡(det( g00 ))

(5.40)
(5.41)

Ï‡

where the sums are over Ï€s and Ï‡s with Iwahori fixed vectors, and Ï† is the G (AÎ£ ) Ã— âˆ xâˆˆÎ£ Iwx fixed vector. Now transfer to J (A):
K f Î£ ( g0 , g3 ) =
J

âˆ‘

Î»Ï€ ( f ) Â·

Ï€

Ï†( g0 )Ï†3 ( g3 )
hÏ†, Ï†i

+âˆ‘

Î»Ï‡ ( f ) Â· Â·Ï‡(det( g0 )) Â· Ï‡(det(Ï â—¦ g3 Â· hâˆ’1 â—¦ Ï))

=âˆ‘

Î»Ï€ ( f ) Â·

+âˆ‘

Î»Ï‡ ( f ) Â· Â·Ï‡(det( g0 )) Â· Ï‡(det(Ïâˆ’1 â—¦ g3 â—¦ Ï â—¦ Ïâˆ’1 Â· hâˆ’1 â—¦ Ï))

Ï‡

Ï€

Ï†( g0 )Ï†3 ( g3 )
hÏ†, Ï†i

Ï‡

Let det3 : G3,F âˆ’â†’ Gm,F be the character defined by det3 ( g3 ) := det(Ïâˆ’1 â—¦ g3 â—¦ Ï). It is a
generator of X âˆ— ( G3,F ). The last term above becomes:
Ï‡(det(Ïâˆ’1 â—¦ g3 â—¦ Ï â—¦ Ïâˆ’1 Â· hâˆ’1 â—¦ Ï)) = Ï‡(det3 ( g3 )) Â· Ï‡(det3 (hâˆ’1 ))
in which Ï‡(det3 (hâˆ’1 )) is a nonzero number.
Now one only has to show that either one of the following is 0:
Z

Z

2s

[ A]n

Ï‡(det(t0 ))|t0 | dt0 ,

[ T3 ]

Ï‡(det3 (t3 ))Î· (t3 )dt3

If Ï‡ is non trivial on A1 = A0âˆ— , take a t00 such that Ï‡(det(t00 )) , 1. Then one has:
Z
[ A]n

Ï‡(det(t0 ))|t0 |2s dt0 =

=

Z
[ A]n

Z
[ A]n

Ï‡(det(t00 t0 ))|t00 t0 |2s d(t00 t0 )
Ï‡(det(t00 ))Ï‡(det(t0 ))|t0 |2s dt0

From this one gets:

(1 âˆ’ Ï‡(det(t00 ))) Â·

Z
[ A]n

Ï‡(det(t0 ))|t0 |2s dt0 = 0

(5.42)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

35

This implies the second factor is 0.
If Ï‡ is trivial on A1 , then the integral on [ T3 ] becomes:

(a non zero constant) Â·

Z
[ T3 ]

Î· (t3 )dt3

(5.43)

The constant is something in q. Now since Î· is the quadratic character defining K over K3 , it
is non trivial on A13 . Applying the same trick above to Î· and A13 proves the vanishing of this
integral. 
We want to study the r-th derivative of q Ns J( f JÎ£ , s), hence define.:
Jr ( f JÎ£ , s) =

dr
|s=0 (q Ns J( f JÎ£ , s))
dsr

(5.44)

dr
|s=0 (q Ns J( a, f JÎ£ , s))
dsr

(5.45)

Similarly define:
Jr ( a, f JÎ£ , s) =

The q Ns is to make it match the geometric side later.
Then one has:
Jr ( f JÎ£ , s) =

âˆ‘

Jr ( a, f JÎ£ , s)

(5.46)

aâˆˆK3 ,TrK3 /F ( a)=1

Actually one needs f J â€™s spherical part to be in the Eisenstein ideal, but that is not directly related
to the moduli spaces. Rather, one first consider those h D âˆˆ H Î£ , then use the linear combination
of these elements indexed by the effective divisors on X âˆ’ Î£ to approximate the elements in the
Eisenstein ideal (in some representation of the Hecke algebra). With the assit of (5.5), we have:
Proposition 5.11. Let h D âˆˆ H Î£ be the element indexed by D âˆˆ Div+ ( X âˆ’ Î£), then h D âŠ— ( xâˆˆÎ£ 1 Iwx )
N
matches h D,J âŠ— ( xâˆˆÎ£ 1 Iw J,x ) where h D,J is the element in Ccâˆ ( G (OÎ£ )\ G (AÎ£ )/G3 (OÎ£ )) indexed by
D.
N

From now on, I use hÎ£D to denote h D,J âŠ— (

N

x âˆˆÎ£ 1 Iw J,x ).

5.4. The orbit integral and the moduli space. The general spirit of Yun-Zhangâ€™s theory is to
â€œupgradeâ€ the equality of two numbers to an â€œequalityâ€ between two complexes of sheaves on
the Hitchin base Ad first. After proving the equality of complexes of sheaves, one decategorify
it via Grothendieckâ€™s faisceaux-fonctions correspondence to get the expected equality between
two numbers. Now we have to express the numbers Jr ( a, hÎ£D , s) as the Frobenius traces of some
complexes of sheaves on Ad .
What that complex of sheaf is? First Y is a double cover of Y3 , the pushforward of the constant sheaf Ï€3,âˆ— Ql decomposes as Ql âŠ• LY/Y3 , in which LY/Y3 is the local system on Y3 defined
by the representation:
Ï€1et (Y3 ) âˆ’â†’ hÏ„3 i âˆ’â†’ {Â±1}

(5.47)

in which the second arrow is non trivial.
From the geometric class field theory for Y3 , there is a corresponding local system on PicY3 ,
therefore a local system on PicYd 3 for each d. Pull it back along the cover:
YÌ‚3,d âˆ’â†’ PicY3

(5.48)

one gets a local system on YÌ‚3,d for every d. Denote it by Ld .
Recall that we have the morphism:
j(d1 ,d2 ) : N(d1 ,d2 ) âˆ’â†’ YÌ‚3,d1 Ã—k YÌ‚d2 âˆ’ N
Let L(d1 ,d2 ) = j(âˆ—d ,d ) ( Ld1  Ql )
1 2
Recall that we defined A D before (3.7):

(5.49)

36

HAO LI

Definition 5.12.

/ Ad

AD

Speck

Tr

(O X ( D ),1)


/ XÌ‚d

Then we have the proposition parallel to the one in Howard-Shnidman:
Proposition 5.13. There is a canonical bijection:
ï£±
ï£²
âˆ¼
a âˆˆ K3
invD : A D (k) âˆ’
â†’
ï£³

TrK3 /F ( a) = 1

ï£¼
ï£½

div( a) + Î½3âˆ— D âˆ’ D30 â‰¥ 0

ï£¾

From the definition of A D , a point of it consists of a line bundle âˆ† âˆˆ Picd ( X ), a global section
âˆ¼
a of Î½3âˆ— âˆ†, vanishing at D30 and an isomorphism: (âˆ†, TrY3 /X ( a)) âˆ’
â†’ (O X ( D ), 1). The identification
âˆ¼
âˆ¼
here âˆ† âˆ’
â†’ O X ( D ) induces an identification Î½3âˆ— âˆ† âˆ’
â†’ OY3 (Î½3âˆ— D ). Via this latter isomorphism, a is
âˆ—
identified with a global section of OY3 (Î½3 D ) vanishing at D30 . This is nothing but a a âˆˆ K3 such
that div( a) + Î½3âˆ— D âˆ’ D30 â‰¥ 0. 
One call the set on the right hand side the invariants for A D (k ).
Now it is the time to state what we want:
Proposition 5.14. Let a âˆˆ K3 such that TrK3 /F ( a) = 1. Identify Ad (k) as a subset of K3 via invD as
above. Then one has the following:
(1) If a < A D (k), then J( a, hÎ£D , s) = 0;
(2) If a âˆˆ A D (k), then one has:
J( a, hÎ£D , s) =

âˆ‘

(d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N )

q(d1 âˆ’d2 )Â·s Tr( Fr a , (Rg! L(d1 ,d2 ) ) a )

(5.50)

where a is the geometric point sitting over the k-point a : Speck âˆ’â†’ A D .
First let e
h D âˆˆ H ( GL2 (OÎ£ )\ GL2 (AÎ£ )/GL2 (OÎ£ )) be the characteristic function of those double cosets whose determinants have divisor D on X âˆ’ Î£. Let:
O
e
hD âŠ—
1f
hÎ£ := e
(5.51)
D

x âˆˆÎ£

Iw J,x

e be a preimage of Î³ in GL2 ( F ), then one has:
Let Î³ be an element with invariant Î¾, and Î³
J(Î³, hÎ£D , s) =

Z
e(A)Ã— T
e3 (A)
Z (A)\ A

e
et3 )|t0 |2s Î· (t3 )dt0 dt3
hÎ£D (t0âˆ’1 Î³

(5.52)

One rewrite it as:
Z
e(A)Ã— T
e(O)Ã— T
e3 (A)/ A
e3 (O)
Z (A)\ A

(

Z
e(O)Ã— T
e3 (O)
A

e
hÎ£D (t0âˆ’1 x âˆ’1 Î³yt3 )| xt0 |2s Î· (yt3 )dxdy)dt0 dt3

Since | x | = 1 and Î· is trivial on O3 , one can simply it:
Z
e(A)Ã— T
e(O)Ã— T
e3 (O)
e3 (A)/ A
Z (A)\ A

=

e
hÎ£D (t0âˆ’1 Î³t3 )|t0 |2s Î· (t3 ) Â· (

Z
e(A)Ã— T
e(O)Ã— T
e3 (A)/ A
e3 (O)
Z (A)\ A

Z
e(O)Ã— T
e3 (O)
A

dxdy)dt0 dt3

e
hÎ£D (t0âˆ’1 Î³t3 )|t0 |2s Î· (t3 )dt0 dt3

e D,eÎ³ whose
To furthur simply this integral and relate it to geometry, we introduce the set X
points consist of the tuples ( E, E1 , E2 ) âˆˆ Div(Y3 ) Ã— Div( X ) Ã— Div( X ) who satisfy the following:
e : Î½3,âˆ— OY3 d O X âŠ• O X :
â€¢ The map induced by Î³
Ï†Î³e : Î½3,âˆ— (OY3 (âˆ’ E)) âˆ’â†’ O X (âˆ’ E1 ) âŠ• O X (âˆ’ E2 )
is everywhere defined.
â€¢ div(det(Ï†)) is D.

â€¢ it sends Î½3,âˆ— (OY3 (âˆ’ E)(âˆ’w0x )) into O X (âˆ’ E1 ) âŠ• O X (âˆ’ E2 )(âˆ’ x ) for every x âˆˆ Î£.

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

37

e D,eÎ³ /Div( X ). The integral furthur simplies to:
Let XD,eÎ³ = X
Z
e(A)Ã— T
e(O)Ã— T
e3 (A)/ A
e3 (O)
Z (A)\ A

e
hÎ£D (t0âˆ’1 Î³t3 )|t0 |2s Î· (t3 )dt0 dt3

âˆ‘

=

qâˆ’deg(E1 âˆ’E2 )Â·2s Î· ( E)

(5.53)
(5.54)

( E,E1 ,E2 )âˆˆXD,eÎ³

e, letâ€™s denote XD,eÎ³(Î¾ ) .
We have the invariant Ï‡ attached to Î³
The set XD,eÎ³(a) is closedly related to the moduli space Nd for d = degD. For a k-rational
point of A D , a, furthur define Nd,a to be the fiber product:

Nd,a

/ Nd


Speck


/ Ad

(5.55)

g
a

e. If a is not in the image of the invariants of A D (k), then
Proposition 5.15. Let a be the invariant of Î³
XD,eÎ³ = âˆ…; If a is an invariant of A D (k ), then there exists a bijection:
âˆ¼

Î» : XD,eÎ³(a) âˆ’
â†’ Nd,a (k)

(5.56)

Letâ€™s first define a map:
âˆ¼

Î» : XD,eÎ³(a) âˆ’
â†’ Nd (k )

(5.57)

by sending ( E, E1 , E2 ) to (OY3 (âˆ’ E), O X (âˆ’ E1 ), O X (âˆ’ E2 ), Ï†Î³e ). Since the induced map Ï†Î³e has
devisor D degree d, the image really lies in Nd (k), and its image in Ad (k ) lies in A D (k). From
e and of Ï†Î³e , one can see they are the same. So a is in the image
the definition of the invariant of Î³
of A D (k ). Therefore if a is not an invariant of A D (k), XD,eÎ³(a) must be empty.
Now one has to show that any element of Nd,a arise as a image of some point of XD,eÎ³(a) .
This basically follows from Howard-Shnidman. Given a tuple (L, L1 , L2 , Ï†) âˆˆ Nd,a (k), fix
isomorphisms of the generic fiber of Î½3âˆ— L with K3 , L1 , L2 with F respectively:
âˆ¼

g3 : Î½3,âˆ— L|Î·X âˆ’
â†’ K3 ,

âˆ¼

g1 : L 1 | Î· X âˆ’
â†’ F,

âˆ¼

g2 : L 2 | Î· X : âˆ’
â†’F

(5.58)

Then Ï† transfer to a map of F-vector spaces Î³ : K3 âˆ’â†’ F âŠ• F. The inverse images of 1 under
g3 and g1 , g2 defines rational sections of Î½3,âˆ— L and L1 , L2 , say s1 , s2 , s3 . Then ( E, E1 , E2 ) can be
selected as (âˆ’div(s3 ), âˆ’div(s1 ), âˆ’div(s2 )). The requirement at Î£ is automatic from the same
requirement for (L, L1 , L2 , Ï†). 
One can furthur decompose Nd,a into N(d1 ,d2 ),a , getting:

Ã¤

Nd,a =

d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N

N(d1 ,d2 ,a)

(5.59)

The point counding formula (5.53) on XÎ³e,D (k) can be reinterpreted as counting points on Nd,a (k):

âˆ‘

qâˆ’deg(L1 âˆ’L2 )Â·2s Â· Î· (L)

(5.60)

(L,L1 ,L2 ,Ï†)âˆˆNd,a (k)

âˆ‘

=

q(d1 âˆ’d2 )Â·s

(d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N )

âˆ‘

(L,L1 ,L2 ,Ï†)âˆˆN(d

Î· (L)

(5.61)

(k)
1 ,d2 ),a

Apply the Grothendieck-Lefschetz trace formula to the diagram (5.55) and the complex of vector spaces (Rg! L(d1 ,d2 ) ) a , one get the desired equation:
J( a, hÎ£D , s) =

âˆ‘

(d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N )

This finish the proof of (5.14).

q(d1 âˆ’d2 )Â·s Tr( Fr a , (Rg! L(d1 ,d2 ) ) a )

38

HAO LI

6. C ONCLUSIONS
6.1. Comparision of sheaves. Now both the intersection number and the orbital integral are
translated into Frobenius traces on some complexes of sheaves, one has to compare these
sheaves.
First let me review some combinatorial facts proved by Howard-Shnidman. Let d20 = d2 âˆ’ N
and d0 = 2d âˆ’ N. Consider the group:
0

Î“d0 = {Â±1}d o Sd0

(6.1)

Let 1 be the trivial representation of the group Sd0 , and:
Î“ 0

IndSd0 1 = {Î¦ : Sd0 \Î“d0 âˆ’â†’ Ql }

(6.2)

d

0

0

Sd0 is embedded into Î“d0 as the subgroup {1}d o Sd0 . For each x âˆˆ {Â±1}d , let Î¦ x be characteristic function of the coset x Â· Sd0 . When x runs through all of these tuples formed by 1 and âˆ’1,
one get a basis of the induced representation above. Let:
ei = (1, ..., 1, âˆ’1, 1, ..., 1) âˆˆ {Â±1}d

0

Î“ 0

in which âˆ’1 appears at the i-th spot. Let H be the operator on IndSd0 1 defined by:
d

H Â· Î¦x =

d0

âˆ‘ Î¦ ei x

i =1
0

i.e. H is the element âˆ‘id=1 ei âˆˆ Z[Î“d0 ] acting on the induced representation.
Similarly, for a pair of numbers d1 , d20 such that d1 + d20 = d0 , define:
Î“d1 = {Â±1}d1 o Sd1

0

Î“d0 = {Â±1}d2 o Sd0

2

2

and characters:
Î·d1 : {Â±1}d1 âˆ’â†’ {Â±1}

0

Î·d2 : {Â±1}d2 âˆ’â†’ {Â±1}

Then one has the following proposition of Î“d0 -module:
Proposition 6.1. There is a decomposition:
Î“ 0

M

IndSd0 1 =
d

d1 ,d20 â‰¥0,d1 +d20 =d0

V(d1 ,d0 )

such that:
â€¢ Each V(d1 ,d0 ) is an irreducible representation of Î“d0 ;
2
â€¢ H acts on V(d1 ,d0 ) by the scalar (d1 âˆ’ d20 );
2
â€¢ V(d1 ,d0 ) is isomorphic V(d0 ,d1 ) ;
2

2

Î“ 0

â€¢ V(d1 ,d0 ) is isomorphic to IndÎ“dd
2

Ã—Î“d0
1

2

(6.3)

2

Î“ 0

(Î·d1  1) and IndÎ“dd

1

Ã—Î“d0

2

(1  Î·d1 ).

Now we can state the basic fact about sheaves comparison. Recall one has the following
diagram:

Hd

(6.4)

Î³0

Md

Î³1

}

!

fd

!

Ad

}

Md

fd

Proposition 6.2. Assume d â‰¥ 2g3 âˆ’ 1 + N. One has the following isomorphism:
âˆ¼

â†’
R f d,! Ql âˆ’

M
d1 â‰¥0,d2 â‰¥ N,d1 +d2 =2d

Rg(d1 ,d2 ),! L(d1 ,d2 )

(6.5)

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

39

in the category Dcb (Ad , Ql ). Each summand on the right is stable under the Hecke correspondence Hd , which acts on Rg(d1 ,d2 ),! L(d1 ,d2 ) by d1 âˆ’ d2 + N.
The prove is the same as Yun-Zhang and Howard-Shnidman. The idea is first compare them
â—¦ âŠ‚ YÌ‚ 0 be the open dense subscheme classifying divisors
on an open dense part of Ad . Let YÌ‚3,d
0
3,d
0
on Y3 of degree d without multiplicity. Similarly define YÌ‚dâ—¦0 âŠ‚ YÌ‚d0 . Then one has the everywhere
unramified finite cover of schemes:
Nm : YÌ‚d0 âˆ’â†’ YÌ‚3,d0

(6.6)

with deck transformation group Î“d0 . Then Nmâˆ— Ql is the local system determined by the repreÎ“ 0

sentation IndSd0 1. Using the decomposition (6.1), one gets:
d

âˆ¼

Nmâˆ— Ql âˆ’
â†’

M
d1 ,d20 â‰¥0,d1 +d20 =d0

V(d1 ,d0 )
2

(6.7)

Here right hand side means the local systems determined by the representations V(d1 ,d0 ) . Define
2
Aâ—¦d to be the open dense part of Ad such that Ã·Î¾ âˆ’ D30 is multiplicity free, i.e.:

Aâ—¦d

/ Ad


â—¦
YÌ‚3,d
0


/ YÌ‚3,d0

(6.8)

By the proper base change theorem of eÌtale cohomology, one has:
âˆ¼

R f d,! Ql |Aâ—¦d âˆ’
â†’ Nm! Ql |Aâ—¦d
âˆ¼

â†’ V(d1 ,d2 ) |Aâ—¦d
Rg(d1 ,d2 ),! L(d1 ,d2 ) |Aâ—¦d âˆ’

(6.9)
(6.10)

Now by the finiteness of of f d and gd , one knows that R f d,! Ql [d0 âˆ’ g + 1] is the middle extension of R f d,! Ql [d0 âˆ’ g + 1]|Aâ—¦d and Rg(d1 ,d2 ),! L(d1 ,d2 ) [d0 âˆ’ g + 1] is the middle extension of
Rg(d1 ,d2 ),! L(d1 ,d2 ) [d0 âˆ’ g + 1]|Aâ—¦d . Therefore the isomorphism above extends to the entire Ad .
For the Hecke correspondence part, it is easy to check combinatorially that when restricted to
â—¦
Ad , the action [Hd ] on V(d1 ,d0 ) |Ad coincide with H in (6.1), hence a scalar d1 âˆ’ d20 = d1 âˆ’ d2 + N.
2
Again by the theory of middle extension, this extends to all the Rg(d1 ,d2 ),! L(d1 ,d2 ) over the entire
Ad .
6.2. Comparison of the intersection number and the orbital integral. First letâ€™s review some
theorems about the Hecke algebra H Î£ in Yun-Zhang.
fÎ£ as the image of the following map:
Define H
l
HGÎ£ âŠ— Ql âˆ’â†’ EndQl (V ) Ã— EndQl (A(K ) âŠ— Ql ) Ã— Ql [ Pic X (k )]Î¹ P ic
It is a finitely generated algebra over Ql . Then they proved:
Proposition 6.3. Let H Î£,â€  âŠ‚ HGÎ£ . be the linear span of h D for effective divisors D of degree greater
then a fixed positive number, say M. Then the map:
H

Î£,â€ 

âŠ— Ql âˆ’â†’ HGÎ£ âŠ— Ql âˆ’â†’ Hfl Î£

is surjective.
This lead to:
Proposition 6.4. For any f âˆˆ HGÎ£ , one has:
IÂµ ( f ) = (logq)âˆ’r Jr ( f )
First one check the equation for f = h D for degD â‰¥ 2g3 âˆ’ 1 + N. The left hand side:

âˆ‘

Î¾ âˆˆA D (k )

Tr( f d,! [Hd ] â—¦ FrÎ¾ , (R f d,! Ql )Î¾ )
Âµ

(6.11)

40

HAO LI

âˆ¼

From the last part, we have seen R f d,! Ql âˆ’
â†’
one can rewrite the above formula as:

âˆ‘

âˆ‘

L

d1 â‰¥0,d2 â‰¥ N,d1 +d2 =2d Rg(d1 ,d2 ),! L(d1 ,d2 ) .
Âµ

Î¾ âˆˆA D (k ) d1 â‰¥0,d2 â‰¥ N,d1 +d2 =2d

Tr( f d,! [Hd ] â—¦ FrÎ¾ , (Rg(d1 ,d2 ),! L(d1 ,d2 ) )Î¾ )

Therefore
(6.12)

Âµ

Since Hd acts on Rg(d1 ,d2 ),! L(d1 ,d2 ) by the scalar, one has:

âˆ‘

âˆ‘

Î¾ âˆˆA D (k ) d1 â‰¥0,d2 â‰¥ N,d1 +d2 =2d

(d1 âˆ’ d2 + N )r Tr( FrÎ¾ , (Rg(d1 ,d2 ),! L(d1 ,d2 ) )Î¾ )

The right hand side:

âˆ‘

âˆ‘

Î¾ âˆˆA D (k ) (d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N )

q(d1 âˆ’d2 + N )Â·s Tr( FrÎ¾ , (Rg! L(d1 ,d2 ) )Î¾ )

Taking the rth derivative and evaluate it at s = 0, one gets:

âˆ‘

âˆ‘

Î¾ âˆˆA D (k ) (d1 +d2 =2d,d1 â‰¥0,d2 â‰¥ N )

(d1 âˆ’ d2 + N )r Tr( FrÎ¾ , (Rg! L(d1 ,d2 ) )Î¾ )

It is the same as the left hand side.
Now for any f âˆˆ HGÎ£ , Yun and Zhang proved that IÂµ ( f ) and (logq)âˆ’r Jr ( f ) only depend on
fÎ£ . From the last proposition, one can get the conclusion.
f â€™s image in H
l
6.3. Final conclusion. A larger part of Yun-Zhangâ€™s papers was devoted to proving a â€œcoarseâ€
spectral expansion of the cohomology of the moduli of shtukas (integral model, not just the
generic fiber). Iâ€™m going to restate it and use it.
fÎ£ and V (Î¾ ) be Hcr (ShtÂµ (Î£; Î¾ ) for a Î¾ : Sâˆ âˆ’â†’ S
e âˆ . They proved the followLet Y = SpecH
G
l
ing:
(1) There is a decomposition of the scheme Y red :

Theorem 6.5.

Y red = ZEis,Ql Ã¤ Y0
where Y0 is a finite set of closed points. Also there is a corresponding decomposition:
fÎ£ = H
fÎ£ Ã— H
fÎ£
H
l
l,Eis
l,0
fÎ£ = Y0 .
fÎ£ = ZEis,Q and SpecH
such that SpecH
l,0
l,Eis
l
(2) There is a unique decomposition:
V (Î¾ ) = V0 (Î¾ ) âŠ• VEis (Î¾ )
such that SuppVEis (Î¾ ) âŠ‚ Zl,Eis and SuppV0 (Î¾ ) âŠ‚ Y0 . V0 is of finite dimension over Ql .
(3) Base change the scheme and the module over it to Ql . Then the above decomposition of module
becomes:
V (Î¾ ) âŠ— Ql = VEis (Î¾ ) âŠ— Ql âŠ• (âŠ•mâˆˆY0 (Q ) Vm (Î¾ ))
l

fÎ£ .
where Vm (Î¾ ) is the eigenspace of the character m of H
l
Âµ

Âµ

Âµ

Let Zi be the image cohomology class in V (Î¾ ) of Zi (Î¾ ) for i = 1, 2. Further let Zi,m to be the
Âµ
fÎ£ as (0, h) in H
fÎ£ . By the self-adjointness of the H Î£
projection of Z to Vm (Î¾ ). Identify h âˆˆ H
l,0

i

G

l

action with respect to the cup product, one has:
IÂµ ( h ) =

âˆ‘

mâˆˆY0 (Ql )

Âµ

Âµ

( Z1,m , h âˆ— Z2,m )

(6.13)

On the analytic side, looking at the spectral expansion side:
Jr ( h ) =

âˆ‘

Ï€ âˆˆ Î  Î£ (Ql )

Î»Ï€ (h)(

d r
) |s=0 (q Ns JÏ€ (hÎ£J , s))
ds

(6.14)

where Î Î£ (Ql ) is the set of automorphic representations of level G (OÎ£ ) Ã— âˆ xâˆˆÎ£ Iwx . This set
can be viewed as a subset of Y0 (Ql ): For any Ï€, take its G (OÎ£ ) Ã— âˆ xâˆˆÎ£ Iwx fixed line, then
fÎ£ âŠ— Ql âˆ’â†’ Ql .
fÎ£ âŠ— Ql acts on this fixed line by the character Î»Ï€ : H
H
l,0
l,0

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

41

Now take the test function to be the idempotent eÏ€ corresponding to the point Ï€ âˆˆ Y0 (Qi ),
then one has:
IÂµ (eÏ€ ) = ( Z1,Ï€ , Z2,Ï€ )
Âµ

Jr ( e Ï€ ) = (

Âµ

d r
) |s=0 (q Ns JÏ€ ( f , s))
ds

Applying (6.11), one gets:

( Z1,Ï€ , Z2,Ï€ ) = (logq)âˆ’r (
Âµ

Âµ

d r
) |s=0 (q Ns JÏ€ ( f , s))
ds

In conclusion:
Âµ

Âµ

Âµ

Âµ

Theorem 6.6. Let Z1 and Z2 be the Heegner-Drinfeld cycles attached to Y1 , Y2 and Âµ and Z1 , Z2 be
their cohomology class in Hcr (ShtrG (Î£)0 ). Then one has:

( Z1,Ï€ , Z2,Ï€ ) = (logq)âˆ’r (
Âµ

Âµ

P0 (Ï†, s)P3,Î· (Ï†3 )
d r
) |s=0 (q Ns
)
ds
hÏ†, Ï†i

6.4. Some more conlusions. In the Yun-Zhang case, the analytic side is just the base change
L-function times some additional terms related to the genus of the base curve and the level Î£.
Here the period integral is not an L-function of any standard form. It is just a period integral.
However, using the classical result due to Waldspurger (the function field version was proved
by Chuang and Wei, look at their paper [1]), we still have the following:
Theorem 6.7. Let Ï€ be antomorphic representation who has spherical level away from Î£ and is a nonramified twist of Steinberg at each point in Î£. In the notations as above, one has:
Âµ

Âµ

( Z1,Ï€ , Z1,Ï€ ) = 0
is equivalent to:
L (r) (Ï€, 1/2) Â· L(Ï€ âŠ— Ï‡1 , 1/2) Â· L(Ï€ âŠ— Ï‡2 , 1/2) = 0
in which L (Ï€, s + 1/2) = q(2gâˆ’2+ N )s Â· L(Ï€, s + 1/2)
To see this, first, according to Yun-Zhangâ€™s papers, one has:
P0 (Ï†, s) = q(2gâˆ’2)s Â· L(Ï€, s + 1/2)
For Ï† a G (OÎ£ ) Ã— âˆ xâˆˆÎ£ Iwx fixed vector in Ï€.
The other part, P3,Î· (Ï†3 ), one consider the T3 (A) Ã— T3 (A)-invariant linear functional:
P3Ï€ : Ï€ Ã— Ï€ âˆ’â†’ C
Ï†1 âŠ— Ï†2 7âˆ’â†’ P3 (Ï†1 , Î· )P3 (Ï†2 , Î· )
One has the local T3 ( Fx ) Ã— T3 ( Fx )-bilinear form:
Î± x (Ï†1 âŠ— Ï†2 ) =

L(Ï‡3,x , 1) L(Ï€ x , ad, 1)
Î¶ Fx (2) L(Ï€ x , Î·x , 1/2)

Z
Ã—
K3,x
/FxÃ—

(Ï€ x (t)Ï†1 , Ï†2 ) x Î·x (t)dt

and the global-local relation:
P3Ï€ =

Î¶ F (2) L(Ï€, Î·, 1/2)
8L(Ï‡3 , 1)2 L(Ï€, ad, 1)

âˆ

Î±x

x âˆˆ| X |

Now take Ï† as above, and its corresponding form Ï†3 on G (A3 ) is a G3 (OÎ£ ) Ã— âˆ xÎ£ Iwwx fixed
vector. One has T3 (Ox ) âŠ‚ G3 (Ox ) for x < Î£ and T3 (Ox ) âŠ‚ Iwwx . Therefore one can apply the
proposition by Gross-Prasad[3] to conclude that:

âˆ

Î± x ( Ï†x âŠ— Ï† x ) , 0

x âˆˆ| X |

Î¶ F (2)
is a nonvansihing constant, whether P3Ï€ (Ï† âŠ— Ï†) vanishes or
8L(Ï‡3 , 1)2 L(Ï€, ad, 1)
not depends on whether L(Ï€, Î·, 1/2) vanishes or not, but because one has:

Since the term

L(Ï€, Î·, s) = L(Ï€ âŠ— Ï‡1 , s) Â· L(Ï€ âŠ— Ï‡2 , s)

42

HAO LI

Therefore P3 (Ï†3 ) = 0 is equivalent to L(Ï€ âŠ— Ï‡1 , s) Â· L(Ï€ âŠ— Ï‡2 , s) = 0. 
Âµ
Âµ
Howard and Shnidman also computed the intersection number of the entire Z1 and Z2 by
computing the orbital integral side. Here one can apply their method directly to get a similar
but slightly different result:
Theorem 6.8. No matter how many points of modification you have i.e. for any r â‰¥ 0, youâ€™ll always
get:
Âµ
Âµ
( Z1 , Z2 ) = 0
Take the test function f to be the characteristic function of G0 (A), one gets:
d r
) |s=0 (q Ns J( f JÎ£ , s))
ds
The point is that J( f JÎ£ , s)) is always 0. To get this, let me first cite a lemma proved by Howard
and Shnidman:

( Z1 , Z2 ) = (logq)âˆ’r (
Âµ

Âµ

Lemma 6.9. Fix Î³ âˆˆ J ( F ), let a âˆˆ K3 be its invariant. If there exist t0 âˆˆ T0 (A) and t3 âˆˆ T3 (A) such
that f JÎ£ (t0âˆ’1 Î³t3 ) , 0, then a âˆˆ k and 2a = 1.
Notice that in their paper f is the characteristic function of the image of e
J (O) in J (A), but
here one changes the local components at Î£ to 1 Iw J,x , but the hypothesis in the lemma still forces
the existence of Ï† âˆˆ e
J (A) lifting t0âˆ’1 Î³t3 and send O3 to O âŠ• O. This is because to be in Iw J,x is
more restrictive than to be in Iso (OK3 ,x , Ox âŠ• Ox ). Therefore all of their arguments still apply
here.
Now the orbital integral simplies to just one term J(Î³, f JÎ£ , s), and from their lemma, one can
even write down the element Î³: First take an element of K3 : e such that K3 = F (e) and e
satisfies an equation of the form x2 âˆ’ a = 0 for a âˆˆ F. Then as an F-vector space, K3 = F + Fe,
and there is an F-linear isomorphism: K3 âˆ’â†’ F âŠ• F : x + ye 7âˆ’â†’ ( x, y). Then this Ï† is a
representative of Î³ with invariant 1/2: base change it K3 , one gets:
K3 âŠ• K3 âˆ’â†’ K3 âŠ• K3
a+b aâˆ’b
,
)
2
2e
âˆ’1 âˆ’1
1
Then invairant, as we have seen, is given by:
/
= .
4e 2e
2
Factorize the test function and the character Î·: f JÎ£ = âˆ xâˆˆ| X âˆ’Î£| f x âŠ— âˆ xâˆˆÎ£ 1 Iwwx and Î· =
âˆ xâˆˆ| X | Î·x . The points away from Î£ is exactly the same as in Howard-Shnidmanâ€™s paper. So one
only has to care about x âˆˆ Î£. According to our set up, any x âˆˆ Î£ splits in K3 . As they pointed
out, here one can choose c âˆˆ Fx such that (cex )2 = 1, and define the idempodents:
1 + cex
1 âˆ’ cex
e=
, f =
2
2
These two idempotents actually split K3,x into K3,wx âŠ• K3,w0x , though one doesnâ€™t know the order
the two over points. The integral over T3 ( Fx ) is just summing over the set of lattices:

( a, b) 7âˆ’â†’ (

Ã—
FxÃ— \K3,x
/OKÃ—3 ,x = {e + v l f : l âˆˆ Z}

Moding out OKÃ—3 ,x is because OKÃ—3 ,x is contained in Iww0x or Iwwx . Similarly, the integration over
Ã—
the split torus T0 ( Fx ) is just summing over FxÃ— \ Fx Ã— Fx /OÃ—
F,x Ã— O F,x .
For 1 Iwx ((1, v âˆ’k ) Â· Î³ Â· (e + v l f )) to be not 0, one must first have Ï†(OKÃ—3 ,x Â· (e + v l f ) = (OÃ—
F,x Ã—

âˆ’k
Ã—
k
OÃ—
F,x ) Â· (1, v ) up to rescaling by Fx . From Howard-Shnidman, this is equal to saying: | v | =
|c| and l = 0. This is because of the following: by the definition of Ï†, one has:

1 c
1
c
e 7âˆ’â†’ ( , ) v l f 7âˆ’â†’ ( v l , âˆ’ v l )
2 2
2
2
they should span the same lattice as (1, v k ) up to some rescaling by FxÃ— . So there exists a matrix:


a11 a12
âˆˆ GL2 (Ox )
a21 a22

A GROSS-KOHNEN-ZAGIER TYPE FORMULA FOR MODULI OF SHTUKAS WITH IWAHORI LEVEL STRUCTURES

43

and a power of the uniformizer v Î± , such that:
1 Î± l
v v = a12
2
c Î±
c
v = a21 v k âˆ’ v Î± v l = a22 v k
2
2
Since the matrix is in GL2 (Ox ), we must have the following: If ord x ( a12 a21 ) > 0, then one
must have ord x ( a11 ) = ord x ( a22 ) = 0. Then from the first equation above, one gets Î± = 0.
Then from the last equation, one gets ord x (c) = k âˆ’ l, plugging in the third equation, one
gets ord x ( a21 ) = âˆ’l â‰¥ 0. From the second equation, one gets ord x ( a12 ) = l â‰¥ 0. These two
inequalities forces l = 0. This in turn tells us ord x (c) = k. Their claim is correct;
If ord x ( a11 a22 ) > 0, then ord x ( a12 ) = ord x ( a21 ), one plays a similar game: By the second
equation, one gets Î± = âˆ’l. Then plug it into the third equation, one sees ord x (c) = k + l.
Now by the last equation one gets ord x ( a22 ) = l â‰¥ 0 and from the first equation one gets
ord x ( a11 ) = âˆ’l. Again, both l and âˆ’l should be non-negative, therefore l = 0 and ord x (c) = k.
In case all four coefficients has valuation 0, either of the two arguments above works. This is
the proof of their claim.
In their case this is enough, but now there is one more condition, i.e. Ï† should send the
sublattice OK3 ,x Â· (e + v l +1 ) or OK3 ,x Â· (e + v l âˆ’1 ) to OF,x Â· (1, v k+1 ), up to rescaling by v Î± . The
same argument as above shows that one must have l = 1 or l = âˆ’1 and ord x (c) = k + 1, this
contradicts what we got above. This implies that for all t0 and t3 , 1 Iww0 (t0âˆ’1 Î³t3 ) = 0. The local
x
factors at the level are all 0, therefore the global integrand is always 0, the integral just vanish.

1 Î±
v = a11
2

R EFERENCES
[1] Chih-Yun Chuang and Fu-Tsun Wei. Waldspurger formula over function fields. Trans. Amer. Math. Soc., 371(1):173â€“
198, 2019.
[2] B. Gross, W. Kohnen, and D. Zagier. Heegner points and derivatives of L-series. II. Math. Ann., 278(1-4):497â€“562,
1987.
[3] Benedict H. Gross and Dipendra Prasad. Test vectors for linear forms. Math. Ann., 291(2):343â€“355, 1991.
[4] Benjamin Howard and Ari Shnidman. A Gross-Kohnen-Zagier formula for Heegner-Drinfeld cycles. arXiv e-prints,
page arXiv:1707.00213, Jul 2017.
[5] Zhiwei Yun. Hitchin type moduli stacks in automorphic representation theory. arXiv e-prints, page arXiv:1809.01811,
Sep 2018.
[6] Zhiwei Yun and Wei Zhang. Shtukas and the Taylor expansion of L-functions. Ann. of Math. (2), 186(3):767â€“911,
2017.
[7] Zhiwei Yun and Wei Zhang. Shtukas and the Taylor expansion of L-functions (II). Ann. of Math. (2), 189(2):393â€“526,
2019.


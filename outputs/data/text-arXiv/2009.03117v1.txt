Anomaly Detection in Stationary Settings: A
Permutation-Based Higher Criticism Approach
arXiv:2009.03117v1 [stat.ME] 7 Sep 2020

Ivo V. Stoepker1 , Rui M. Castro1 , Ery Arias-Castro2 , and Edwin van den
Heuvel1
1
2

Technische Universiteit Eindhoven
University of California, San Diego

Abstract
Anomaly detection when observing a large number of data streams is essential in a
variety of applications, ranging from epidemiological studies to monitoring of complex
systems. High-dimensional scenarios are usually tackled with scan-statistics and related
methods, requiring stringent modeling assumptions for proper calibration. In this
work we take a non-parametric stance, and propose a permutation-based variant of the
higher criticism statistic not requiring knowledge of the null distribution. This results
in an exact test in finite samples which is asymptotically optimal in the wide class of
exponential models. We demonstrate the power loss in finite samples is minimal with
respect to the oracle test. Furthermore, since the proposed statistic does not rely on
asymptotic approximations it typically performs better than popular variants of higher
criticism that rely on such approximations. We include recommendations such that the
test can be readily applied in practice, and demonstrate its applicability in monitoring
the daily number of COVID-19 cases in the Netherlands.
Keywords: permutation test; anomaly detection; higher criticism; minimax hypothesis testing

1

Introduction

We study the problem of anomaly detection when a large number of data streams is observed.
The streams themselves are not structured in any special way. In particular, there is no
spatial or other proximity measure between streams, unlike in some areas like syndromic
surveillance (Kulldorff et al., 2005). We work under the following assumptions:
‚Ä¢ Entirety. An anomalous stream is affected in its entirety. This assumption focuses
the discussion on the unstructured nature of the setting. Although simplistic, this
assumption is common in the literature (Aldosari and Moura, 2004; Lexa et al., 2004;
Mei, 2008; Patwari and Hero, 2003; Thomopoulos et al., 1989; Yu et al., 2006).

2
‚Ä¢ Sparsity. An anomaly affects only a small fraction of the streams. This assumption
focuses the discussion on the most compelling regimes.
Formally we consider n streams indexed by [n] ‚â° {1, . . . , n}, that are observed over a time
period [t] ‚â° {1, . . . , t}. Specifically we observe X ‚â° (Xij : i ‚àà [n], j ‚àà [t]), where Xij is the
value from stream i ‚àà [n] collected at time j ‚àà [t]. Stream i ‚àà [n] corresponds to a vector
denoted by Xi ‚â° (Xij : j ‚àà [t]).
Following standard practice, we place ourselves in a statistical decision theory framework
and cast detection as a hypothesis testing problem. For simplicity, we assume the variables
to be real valued and independent.
In this paper, we consider a stationary setting where the distribution of the observations
remain unchanged over time. In detail, under the null hypothesis all Xij are independent
and identically distributed (i.i.d.) with common distribution function denoted by F0 . The
alternative hypothesis is similar, but there is a subset of anomalous streams S ‚äÇ [n] such that
for each i ‚àà S the distribution of Xij , denoted by Fi , stochastically dominates F0 . In words,
larger-than-usual values are observed in the streams indexed by S. The subset S is unknown
and has no particular structure. Note that we are still assuming all the random variables Xij
are independent. The sparsity assumption means the number of affected streams is believed
to be small in comparison with the total number of streams, i.e. |S|  n. Succinctly, our
hypothesis testing problem is therefore:
i.i.d.

H0 :

‚àÄi‚àà[n] Xij ‚àº F0

H1 :

‚àÉS‚äÇ[n] : ‚àÄi‚ààS Xij ‚àº Fi and ‚àÄi‚ààS
/ Xij ‚àº F0 ,

(1)
i.i.d.

i.i.d.

where for all i ‚àà S, distribution Fi stochastically dominates F0 .
Despite its apparent simplicity, the above formulation and ensuing hypothesis test is quite
suitable in a number of scenarios. For instance, in industrial settings the stream observations
Xi , i ‚àà [n] might correspond to a failure metric measured from n machines. Under nominal
conditions we expect these to be i.i.d. samples from some distribution, while under the
anomalous conditions some of these machines will occasionally display higher-than-normal
values for the failure metric. In more complex settings the observations might correspond to
residual values, obtained by fitting a model to the streams in order to ensure these are in a
common referential. For instance, in gene expression studies the streams might correspond
to the normalized gene expression level of a number of replicates, so that under nominal
conditions the expression levels are ‚Äúequalized‚Äù, and one is trying to determine if genes are
differentially expressed under a specific environmental change. Obviously in this and similar
settings some pre-processing of the data is needed to ensure all the streams are comparable.
In Section 5.6 we consider yet a different application, where the proposed methodology can be
applied directly to the daily counts of diagnosed COVID-19 cases in different municipalities
in the Netherlands.
Contributions: Although a thorough characterization of the above testing scenario is far
from trivial, it has been addressed quite extensively when the distribution F0 is assumed

3
known, and in particular when this is a normal distribution (Donoho and Jin, 2004; Ingster, 1997). Knowledge of that distribution is required to calibrate the proposed tests (e.g.,
by Monte-Carlo simulation) and ensure the resulting p-value computation is done properly.
When F0 is unknown there are various ways one can proceed. A natural nonparametric
approach is calibration by permutation. This approach is, in fact, quite standard in syndromic surveillance (Huang et al., 2007; Kulldorff et al., 2005, 2009). It is also common
in neuroimaging (Nichols and Holmes, 2002) and other contexts (Flenner and Hewer, 2011;
Walther, 2010).
In this work we propose a variant of the higher criticism statistic that relies on permutations
in both its definition and its calibration, leading to an exact test. Furthermore, we show that,
in the context of a one-parameter exponential family this test is asymptotically optimal, in
the sense that it has essentially the same asymptotic performance as the best possible test
with oracle knowledge of the model parameters. We provide practical recommendations so
that the test is readily applicable in practice and demonstrate it has good performance in
finite sample scenarios. In terms of testing power our procedure compares quite favorably
with other proposed variants of higher criticism, particularly when streams are short (i.e.,
small t), since in its definition in does not rely on asymptotic approximations.
Related work: Early work on distribution-agnostic applications of the higher criticism
can be found in Delaigle and Hall (2009). The setting is different from ours, as the authors
consider testing if a vector of observations, with unknown distribution, has the same mean
as that of auxiliary data. Different approximation methods are discussed for the null distribution based on proximity measures or normal approximations, as well as the possibility of
relaxing independence assumptions. Furthermore, a classification problem is discussed, in
which (vector) samples from two populations are used to classify unlabeled vector samples
to one of the corresponding classes. In a setting closer to ours, Delaigle et al. (2011) use the
higher criticism test with studentized stream means and obtain a p-value by bootstrapping.
Asymptotic results for the statistic are obtained, but controlling the type I error in finite
samples is not discussed. The guarantees obtained are under a significantly different regime
than the one we consider here, namely, the authors only assume that the null distribution
has enough finite moments, but in turn require the stream length t to scale polynomially
with the number of streams n, while our results hold for much shorter streams whose length
scale poly-logarithmically.
The standard higher criticism statistic requires itself knowledge of the null distribution. In
the absence of such knowledge several authors proposed the use of asymptotic approximations. In contrast, we use permutation-based estimates to construct the statistic itself, which
seems to yield higher power in finite sample scenarios in comparison with approximationbased approaches, in addition to the strong theoretical guarantees we provide. Furthermore,
computing the statistic using permutations comes at virtually no extra cost in comparison
to the use of asymptotic approximations, when the statistic itself is already calibrated by
permutation. Wu et al. (2014) consider a different setting than our, but with some important
points-of-contact: in an association setting in genomics the authors aim to use the higher
criticism to test if some covariates (gene SNP‚Äôs) have non-null association to the outcome

4
variables (traits), where a rare-weak assumption on the number and strength of the association is made. Calibration by permutation of the statistic is not the author‚Äôs main interest,
but is mentioned in the numerical section. The higher criticism statistic itself is computed
based on asymptotic approximations. This type of methodology has been previously used
in applied settings, for example in Sabatti et al. (2009). In Donoho and Jin (2015) other
works in this domain are reviewed, and the possibility of calibration by permutation is also
mentioned, but their power properties are not established.
In Arias-Castro and Wang (2017) the authors consider the problem of detecting sparse
heterogeneous mixtures from a nonparametric perspective, when the null distribution is
assumed to be symmetric and the anomalous observations have a shift in mean. In Zou
et al. (2017) the setting is similar to ours, but instead of hypothesis testing, their goal
is to identify the set of anomalous streams. The authors then bound the probability of
misidentifying the set of anomalous sequences. In Arias-Castro et al. (2018), a permutationbased scan statistic is proposed for the detection of structured anomalies (e.g., an interval)
in a single stream, and shown to match to first order the performance of the scan statistic
calibrated with (oracle) knowledge of the null distribution. Recently, Kurt et al. (2020)
focuses on nonparametric change-point detection in a real-time setting and assumes there is
a period of time guaranteed without anomalies. The authors show their decision statistics
are asymptotically bounded under the null. Power properties are only shown empirically.
Organization: Section 1 introduces and motivates the problem. Section 2 briefly reviews
known results for the normal model and motivates the use of a simple quantized variant of
the higher criticism statistic. In Section 3 we introduce the class of distributional models
we use as a benchmark for our theoretical power analysis and provide lower bounds on
the anomalous signal strength for any test to be asymptotically powerful in the context
of any one-parameter exponential family. Section 4 proposes a novel permutation higher
criticism test, and we show that it is essentially asymptotically optimal in the context of the
one-parameter exponential family. We also propose a permutation max test and establish its
power properties. In Section 5 we examine the finite-sample performance of our methodology
on simulated data, and also apply that methodology to a real data example. All the proofs
are deferred to Section 7. Some supporting results are provided in the Appendix to ensure
the manuscript is self-contained.
Notation: Throughout the paper we use standard asymptotic notation. Let n ‚Üí ‚àû, then
an = O(bn ) when |an /bn | is bounded, an = o(bn ) when an /bn ‚Üí 0, and an = œâ(bn ) when
bn = o(an ). We also use probabilistic versions: an = OP (bn ) when |an /bn | is stochastically
bounded1 and an = oP (bn ) when an /bn converges to 0 in probability. Unless otherwise stated,
we consider asymptotic behavior with respect to n ‚Üí ‚àû.
1

That is, for any Œµ > 0 there is a CŒµ and nŒµ such that ‚àÄn > nŒµ P (|an /bn | > CŒµ ) < Œµ.

5

2

An important case: the normal location model

This section considers a specific location model, which serves both as a benchmark and
provides important insights needed for generalizations. These are well known results, but
serve as a stepping stone to propose our methodology in the coming sections. Consider the
setting where F0 is the standard normal distribution with zero mean and unit variance. Under
the alternative, there is a set S ‚äÇ [n] indexing the anomalous streams, and the corresponding
observations have an elevated mean ¬µ > 0 corresponding to the signal strength. Specifically,
consider the following hypothesis test:
i.i.d.

H0 :

‚àÄi‚àà[n]

Xij ‚àº N (0, 1) .

H1 :

‚àÉS‚äÇ[n] : ‚àÄi‚ààS

(2)

i.i.d.

Xij ‚àº N (¬µ, 1), and ‚àÄi‚ààS
/

i.i.d.

Xij ‚àº N (0, 1) .

A natural question to ask is how large does ¬µ need to be to ensure one can distinguish the
two hypotheses. In this model it is obvious that the collection of stream means
1X
Xij
(3)
Yi (X) ‚â°
t
j‚àà[t]

are jointly sufficient. The setting then reduces to that of the normal means model (Donoho
and Jin, 2004; Ingster, 1997). Note that in those works the alternative hypothesis is a bit
different, and often Xij are assumed to be i.i.d. samples from a sparse normal mixture.
Nevertheless the asymptotic characterization of the optimal tests can be easily translated to
the setting we are considering.
We take an asymptotic point of view. Let œàn (X) : Rnt ‚Üí {0, 1} be a sequence of tests,
where the outcome 1 indicates rejection of the null hypothesis. The risk of a test is simply
the sum of type I and worst-case type II error, namely
R(œàn ) = P‚àÖ (œàn (X) 6= 0) + max PS (œàn (X) 6= 1) ,
S:|S|=s

where we denote PS the probability under the alternative, with anomalous set S having
signal strength ¬µ. A sequence of tests is said to be asymptotically powerful if R(œàn ) ‚Üí 0 as
n ‚Üí ‚àû, and it is said to be asymptotically powerless if R(œàn ) ‚Üí 1.
To present an asymptotic characterization of the above hypothesis testing problem it is
convenient to introduce the following parameterization. Let Œ≤ ‚àà [0, 1] be arbitrary (but
fixed) and suppose S has size
|S| = dn1‚àíŒ≤ e ,
(4)
where dze denotes the smallest integer larger than z. With this parametrization, we can
identify two main regimes:
P
‚Ä¢ The dense regime: 0 ‚â§ Œ≤ ‚â§ 1/2. In this scenario a simple test based on i‚àà[n] Yi (X)
is optimal. As stated in the beginning our interest lies in settings where the anomaly
affects only a reduced number of streams, and so we do not focus much on this regime.
Whenever appropriate we make comments on how our results and methods extend to
the dense regime.

6
P
‚Ä¢ The sparse regime: 1/2 < Œ≤ < 1. In this case a test based on i‚àà[n] Yi (X) will be
asymptotically powerless. Let r > 0 be fixed and parameterize ¬µ as
r
2r
log(n) .
(5)
¬µ=
t
Define the detection boundary
(
Œ≤ ‚àí 1/2 ,
1/2 < Œ≤ ‚â§ 3/4 ,
œÅ‚àó (Œ≤) ‚â°
‚àö
2
(1 ‚àí 1 ‚àí Œ≤) , 3/4 < Œ≤ < 1 .
It can be shown that, if r < œÅ‚àó (Œ≤) all tests are asymptotically powerless (see Ingster
(1997) and Theorem 1). Furthermore, if r > œÅ‚àó (Œ≤) there are tests (introduced below)
that are asymptotically powerful. Note that there are actually two sub-regimes within
the sparse regime, namely:
 The moderately sparse regime: 1/2 < Œ≤ ‚â§ 3/4. Here Donoho and Jin (2004) show
that the higher criticism test, based on the maximum of a normalized empirical
process of the (Yi (X), i ‚àà [n]) is asymptotically optimal. In fact, this is so in all
regimes. Define the stream p-values as

‚àö
t Yi (X) ,
(6)
pi = 1 ‚àí Œ¶
where Œ¶ denotes the cumulative distribution function of a standard normal random variable. Note that, under the null hypothesis these are i.i.d. samples from a
uniform distribution in [0, 1]. One variant of the higher criticism rejects the null
hypothesis for large values of
max
i‚àà[bŒ±0 nc]

‚àö

i
‚àí p(i)
np n
,
p(i) (1 ‚àí p(i) )

(7)

where Œ±0 ‚àà (0, 1) and p(1) ‚â§ ¬∑ ¬∑ ¬∑ ‚â§ p(n) are the ordered p-values.
 The very sparse regime: 3/4 < Œ≤ < 1. Here Donoho and Jin (2004) show that the
test that rejects for large values of maxi‚àà[n] Yi (X) achieves the detection boundary.
This is not the case in the moderately sparse regime, as shown in (Arias-Castro
et al., 2011). Expressed in terms of p-values, the max test is entirely equivalent
to multiple testing with Bonferroni correction, rejecting the null hypothesis for
small values of p(1) = mini‚àà[n] pi .
Remark 1. Note that the parameterizations in Equations (4) and (5) can be presented in
a more general way using asymptotic notation. In particular, we can simply assume |S| =
n1‚àíŒ≤+o(1) as n ‚Üí ‚àû. For the sparse regime, it suffices to assume
r
2(r + o(1))
¬µ=
log(n) .
t

7

2.1

A quantized higher criticism statistic

In this section we show that a quantized higher criticism statistic is also optimal in the
normal location model. Quantizing the higher criticism statistic has been done before in
different ways - for example, in Arias-Castro et al. (2011), Wu et al. (2014) and others. We
discuss a quantization because the adaption and analysis of the higher criticism statistic,
when using calibration by permutation, is easier for the quantized form introduced here.
In contrast, adaptation to the permutation setting of the original higher criticism statistic
in (7) is not straightforward as the computation of the test statistic itself requires knowledge
of the null distribution - through the computation of the p-values in Equation (6).
We quantize a different variant of higher criticism. This variant was already introduced for
analytical purposes in Donoho and Jin (2004). Let q ‚â• 0 and define
)
(
r
X
2q
log(n) ,
Nq (X) ‚â°
1 Yi (X) ‚â•
t
i‚àà[n]

p
This is simply the number of streams whose average is larger or equal to 2(q/t) log(n).
We refer to the latter value as the q-threshold. Define also pq , the probability that a stream
mean from the null exceeds that same threshold:

p
2q log(n) .
(8)
pq ‚â° 1 ‚àí Œ¶
Clearly, under the null hypothesis Nq (X) is binomial with parameters n and pq , therefore we
can standardize Nq (X) and define the statistic
Nq (X) ‚àí npq
Vq (X) = p
.
npq (1 ‚àí pq )

(9)

The Vq (X) statistic, when maximized over q ‚àà [0, ‚àû), is closely related to the higher criticism
statistic (see Remark 4 below).
The following result summarizes several analytical steps in Donoho and Jin (2004).
Proposition 1 (Donoho and Jin (2004)). Let q ‚àà [0, ‚àû) be fixed but arbitrary, and
hn ‚Üí ‚àû. Then P‚àÖ (Vq (X) ‚â• hn ) ‚â§ h12 ‚Üí 0. Furthermore, for S as in (4), when 1/2 < Œ≤ < 1
np
(sparse regime), hn = no(1) , and ¬µ = 2(r/t) log(n) we have:
‚Ä¢ If r > (1 ‚àí

‚àö

1 ‚àí Œ≤)2 then PS (V1 (X) ‚â• hn ) ‚Üí 1.

‚Ä¢ If r < 1/4 and r > Œ≤ ‚àí 1/2 then PS (V4r (X) ‚â• hn ) ‚Üí 1.
The proof of Theorem 3, our main result, hinges crucially in showing that important quantities inside the proof of Proposition 1 have the same asymptotic characterization when
considering calibration by permutation. The heart of the proof of Proposition 1 is the realization that, under the alternative, Nq (X) is the sum of two independent binomial random

8
variables; Nq (X) ‚àº Bin(n ‚àí s, pq ) + Bin(s, vq ), where
Ô£± ‚àö ‚àö 2
‚àí( q‚àí r) +o(1)
Ô£¥
Ô£≤n
pq = n‚àíq+o(1)
and
vq = 21
‚àö ‚àö 2
Ô£¥
Ô£≥
1 ‚àí n‚àí( r‚àí q) +o(1)

if r < q
if r = q .
if r > q

We will show a similar result in our setting, implying the result in this proposition can be
used to complete the proof of Theorem 3. For completeness, a proof of Proposition 1 is also
provided in Appendix A.1.
Remark 2. In the dense regime, it is also possible to show that, when ¬µ = ‚àö1t nr‚àí1/2 with
r > Œ≤, we have PS (V0 (X) ‚â• hn ) ‚Üí 1. This implies the higher criticism statistic is also
optimal in that regime under the normal model.
Proposition 1 shows that, depending on the combination of sparsity |S| and signal strength
¬µ we might want to consider a test based on Vq (X) for different values of q. Interestingly,
the value q = 1 suffices for the very sparse regime. For the moderately sparse regime the
situation is more intricate, and it turns out the choice q = 4r is essentially optimal (unless
r ‚â• 1/4, as then q = 1 suffices). Obviously we do not know r, so the only way we can
capitalize on this knowledge is to scan over a suitable selection of values for q, that hopefully
include (or approximate) the optimal value. To keep the analysis simple and avoid the use
of advanced tools in empirical processes we scan only over a coarse subset of values for q.
The following result is an almost immediate consequence of Proposition 1.
Proposition 2 (Quantized HC). Let Q ‚äÜ [0, 1] be the set


1 2
Q = 0, , , . . . , 1 ,
kn kn
where kn ‚Üí ‚àû and kn = no(1) . Define the test statistic
T (X) = max Vq (X) .
q‚ààQ

‚àö
Finally, let hn = œâ( kn ) and hn = no(1) , and consider the test that rejects the null hypothesis
p when T (X) ‚â• hn . This test has vanishing type I error. ‚àóWhen Œ≤ > 1/2 and
¬µ = 2(r/t) log(n) this test is asymptotically powerful provided r > œÅ (Œ≤).
The proof follows almost immediately by using a union of events bound over the grid elements. Under the alternative, the only intricate case is the moderately sparse regime.
However, since the grid is becoming denser as n grows it will contain a value q that is close
enough to the optimal value 4r. A proof is provided in Appendix A.2 for completeness.
Remark 3. For the dense regime, one can prove that, if ¬µ = ‚àö1t nr‚àí1/2 this test is asymptotically powerful provided r > Œ≤. This follows immediately using the results from Proposition 1,
since the optimal value 0 is guaranteed to be in the grid.
Remark 4. The Vq (X) statistic is closely related to the more familiar higher criticism statistic
as in (7) as
(
)
i
‚àö
‚àí
p
(i)
sup {Vq (X)} = max
np n
,
i‚àà[i
]
+
p(i) (1 ‚àí p(i) )
q‚àà[0,‚àû)
where i+ is the largest value of i for which p(i) < 1/2. See Appendix A.3 and Lemma 7.

9

3

Generalization to exponential families

The results of the previous section were specific for the normal location model. Nevertheless
one can envision somewhat natural extensions of the approach and test statistics to the
more general context of the exponential family. When studying distribution-free tests, it
is customary to compare them with parametric tests (Hettmansperger, 1984). As in AriasCastro et al. (2011) and Arias-Castro et al. (2018), we consider one-parameter exponential
models (in natural form) as parametric models, as these play an important role in the related
literature (Donoho and Jin, 2004).
One-parameter exponential models in natural form: Let F0 be a probability distribution on the real line, such that all moments are finite. Let ¬µ0 and œÉ02 denote respectively
the mean and variance of F0 . The distribution might be continuous, discrete or a combination of the two. In the exponential model there is a parameter Œ∏i associated with each
i ‚àà [n], and the distribution Fi ‚â° FŒ∏i is defined through its density fŒ∏i Rwith respect to
F0 : for Œ∏ ‚àà [0, Œ∏? ), define fŒ∏ (x) = exp (Œ∏x ‚àí log œï0 (Œ∏)), where œï0 (Œ∏) = eŒ∏x dF0 (x) and
Œ∏? = sup{Œ∏ > 0 : œï0 (Œ∏) < ‚àû}, assumed to be strictly positive (and possibly infinite). In
other words, fŒ∏i denotes the Radon-Nykodym derivative of FŒ∏i with respect to F0 . Since a
natural exponential family has the monotone likelihood ratio property it follows that FŒ∏ is
stochastically increasing in Œ∏ (Lehmann and Romano, 2005, Lem 3.4.2). Particular cases of
this model are used in a variety of settings. For example, in many signal and image processing applications, a model with FŒ∏ corresponding to normal distribution with mean Œ∏ and a
fixed variance is common. In syndromic surveillance (Kulldorff et al., 2005), a model with
FŒ∏ corresponding to a Poisson distribution is popular. Bernoulli models (Walther, 2010) are
also a particular case of this class, with FŒ∏ corresponding to a Bernoulli distribution.
Let Xij be independent observations, where all observations within stream i are i.i.d. with
distribution function FŒ∏i , as defined above. Under the null hypothesis we have Œ∏i = 0 for
all i. Under the alternative, there is a subset of streams for which Œ∏i > 0. Our hypothesis
testing problem is therefore given by:
‚àÄi‚àà[n] Œ∏i = 0 ,
‚àÉS‚äÇ[n] : ‚àÄi‚ààS Œ∏i > 0 and ‚àÄi‚ààS
/

H0 :
H1 :

(10)
Œ∏i = 0 .

Keeping the same minimax stance as before, in the remainder our analysis assumes the
anomalous observations have the same distribution so Œ∏i = Œ∏ > 0 for i ‚àà S. We keep the
parametrization of the anomalous
set as in (4), namely |S| = bn1‚àíŒ≤ c for Œ≤ ‚àà (0, 1], and use
q
the parameterization Œ∏ = œÉ2r2 t log n.
0

Like it was the case for the normal model, a detection boundary defines the region in the
(r, Œ≤) plane where any test will be asymptotically powerless. In fact, when the stream length
t is large enough the detection boundary for the exponential family is identical to œÅ‚àó (Œ≤)
defined earlier, as the following result shows.
Theorem 1. Refer to the hypothesis testing problem in (10) and the parameterization |S| =

10
n1‚àíŒ≤ with Œ≤ ‚àà (1/2, 1) and Œ∏ =

q

2r
œÉ02 t

log n with r > 0. Provided t = œâ(log3 (n)) any test will

be asymptotically powerless when r < œÅ‚àó (Œ≤).
In the next section, we develop a permutation-based test that is able to attain optimal
asymptotic performance, giving a converse to the statement of Theorem 1.

4

Calibration by permutation

The quantized higher criticism statistic proposed in Section 2 is asymptotically optimal in
the normal location model, but to compute it and calibrate it (i.e. compute a test p-value)
one needs to assume knowledge of the null distribution. With that knowledge, a simple
way to proceed would be to calibrate the test by Monte-Carlo simulation. The goal in
this section is to construct a test (and test statistic) that can be computed and properly
calibrated without the knowledge of the null distribution. A natural and appealing idea is
to calibrate these tests by permutation. The idea of using permutations is not new in the
context of comparing multiple groups (e.g, consider the classical Kruskal‚ÄìWallis test or any
test based on runs). However, such approaches cannot deal with sparse alternatives, as in
the setting we are considering (particularly when Œ≤ > 1/2).

4.1

Permutation-based max test

As can be expected, using calibration by permutation to calibrate a test based on the value
of the maximum stream-mean yields a test that cannot be optimal for all values of Œ≤.
Nevertheless it is insightful to consider this option for its simplicity.
The max test rejects the null hypothesis for large values of
max Yi (X) , where Yi (X) =
i‚àà[n]

1X
Xij .
t
j‚àà[t]

Let Œ† denote the set of permutations of {(i, j) : i ‚àà [n], j ‚àà [t]}. Note that there are
(nt)! distinct permutations. Let œÄ ‚àà Œ† and XœÄ ‚â° (XœÄ(i,j) , i ‚àà [n], j ‚àà [t]). In words, XœÄ
corresponds to the permuted data over both streams and time. Calibration by permutation
amounts to computing a p-value as
o
1 n
œÄ
œÄ ‚àà Œ† : max {Yi (X )} ‚â• max {Yi (X)} .
(11)
Pmax-perm (X) =
i
i
(nt)!
In words, this is just the proportion of times the value of the test statistic computed with
permuted data is at least as large as the value of the test statistic computed on the original
data. Although the computation of the p-value might seem computationally prohibitive, we
can approximate it very accurately by considering instead a uniform sample from the set
of permutations. We have the following characterization of the statistical properties of this
test:

11
Theorem 2 (Permutation max test).
q Let Œ± ‚àà (0, 1) be arbitrary and refer to the hypothesis testing problem in (10). Let Œ∏ = œÉ2r2 t log(n) with r > 0. Consider the test that rejects
0

3
H0 if Pmax-perm (X) ‚â§ Œ±. This test has level at most Œ±. Furthermore
‚àö let 2t = œâ(log (n)) and
Œ≤ > 0. This test has power converging to one provided r > (1 ‚àí 1 ‚àí Œ≤) .

This theorem shows the max test calibrated by permutation is only guaranteed to be optimal
when Œ≤ ‚â• 3/4, as expected. It is important to note the stream length t starts playing a
more prominent role when considering calibration by permutation. Clearly, if t = 1 it is
impossible to calibrate such a test by permutation, as the test statistic is actually invariant
under permutations in that case. One expects that, for very small values of t there might
therefore be a loss of power in comparison to an oracle test calibrated with knowledge of
the null distribution. The requirement for t in the above theorem is needed to ensure the
stream means have approximately Gaussian tails. For exponential tails this scaling seems
necessary. We conjecture that if the tail of F0 is sub-Gaussian the requirement can be relaxed
to t = œâ(log2 (n)) and if it has bounded support t = œâ(log n) will suffice. It might seem the
above proposition should follow directly from the results in Arias-Castro et al. (2018) as one
can interpret the max test as a scan test over intervals of length t within nt observations, but
a more careful analysis is needed to get a sharp characterization of the detection boundary.

4.2

Permutation-based higher criticism test

Although the simplicity of the max test is appealing, the test is far from optimal in the
moderately sparse regime (or the dense regime for that matter). Therefore we turn our
attention to the possibility of calibrating the higher criticism statistic by permutation. Note
that the statistic in Theorem 2 critically depends on the specification of the parameters in
our normal setting. Now, since the mean and variance of the null distribution are unknown
this needs to be taken into account. Define
)
(
r
2
X
2œÉX
q
log(n) ,
NÃÇq (X) ‚â°
1 Yi (X) ‚àí X ‚â•
t
i‚àà[n]

where Yi (X) is as before, while
1 X
X‚â°
nt

i‚àà[n],j‚àà[t]

Xij ,

2
‚â°
œÉX

1
nt

X

(Xij ‚àí XÃÑ)2 .

(12)

i‚àà[n],j‚àà[t]

We must also adapt the normalizing term pq accordingly. In principle, the computation of
this probability requires knowledge of F0 . Instead, we obtain a p-value by permutation as
follows
(
)
r
2
1
2œÉ
q
X
PÃÇq (X) ‚â°
œÄ ‚àà Œ† : Y1 (XœÄ ) ‚àí X ‚â•
log(n)
.
(13)
(nt)!
t
Alternatively one might consider an asymptotic normal approximation to compute PÃÇq instead, as used in Sabatti et al. (2009) and Wu et al. (2014). However, our numerical experiments indicate the permutation-based approach in (13) leads to tests with higher power.

12
Finally, define the counterpart of Vq (X):
NÃÇq (X) ‚àí nPÃÇq (X)
,
VÃÇq (X) ‚â° q
nPÃÇq (X)(1 ‚àí PÃÇq (X))

(14)

where we convention that 0/0 = 0. We are now ready to state the main result.
Theorem 3 (Permutation-based higher criticism test). Let Q ‚äÜ [0, 1] be the set


1 2
Q = 0, , , . . . , 1 ,
(15)
kn kn
with kn ‚Üí ‚àû and |Q| = kn = no(1) . Define the test statistic:
TÃÇ (X) ‚â° max VÃÇq (X) .
q‚ààQ

(16)

Finally, define the higher criticism permutation p-value as
o
1 n
œÄ ‚àà Œ† : TÃÇ (XœÄ ) ‚â• TÃÇ (X)
.
Pperm-hc (X) =
(nt)!
Let Œ± ‚àà (0, 1) be arbitrary and refer to the hypothesis testing problem in (10). Consider
the test that rejects
q H0 if Pperm-hc (X) ‚â§ Œ±. This test has level at most Œ±. Furthermore, let
Œ≤ > 1/2 and Œ∏ = œÉ2r2 t log(n) with r > 0 and t = œâ(log3 (n)). This test has power converging
0

to one provided r > œÅ‚àó (Œ≤).
This result shows that, provided the stream length t is large enough this higher criticism
test calibrated without knowledge of the null distribution is asymptotically as powerful as
any oracle test with that knowledge. This comes at a higher computational cost, but it is
not prohibitive; see Section 5.1. Just as with the permutation max test, the requirement on
t is driven by the tail behavior of the null distribution.
œÉ0 r‚àí1/2
n
with r > 0
Remark 5. For the dense case (i.e. Œ≤ ‚â§ 1/2) one can show that, if Œ∏ = ‚àö
t
and t/n = ‚Ñ¶(1), then the permutation higher criticism test has power converging to one
provided r > Œ≤.

5

Experimental results

This section thoroughly explores the potential of the proposed procedure. We begin by
making some important computational remarks, followed by results on simulated data, and
concluding with the application of the methodology to a real dataset.

13

5.1

Computational complexity

The p-value of the permutation test in Theorem 3 is calculated by considering all possible
data permutations. Naturally, this becomes prohibitive even for moderately large datasets,
and instead a sample of the permutation distribution can be used to estimate Pperm-hc (X).
At first glance computation and calibration of this test statistic might still seem prohibitive:
for each permutation œÄ taken from Œ†, one computes T (XœÄ ), which requires us to compute
Pq (XœÄ ). Naturally, we can estimate this quantity in a similar fashion using a random set of
permutations. However, this would mean that every permutation sample œÄ used to compute
T (XœÄ ) requires us to take a new set of permutation samples, which is disastrous computationally. However, note that Pq (X) is invariant under permutations, namely Pq (X) = Pq (XœÄ ).
Thus we can estimate Pq (X) using a random sample of permutations, and then use these
estimates to compute T (XœÄ ). Moreover, numerical experiments indicate we can use the same
set of permutations to both estimate Pq (X) and compute T (X), without loss of performance
or raising the type I error. This approach has therefore been used in the ensuing numerical
experiments.

5.2

Simulation setting

For our experimental results, we consider two different models: the normal location model,
discussed in Section 2 and a very standard benchmark, and a model where the underlying
distributions are exponential. In the second model, the null distribution F0 is exponential
with mean 1/Œª0 (where we chose Œª0 = 1.5). Following the parametrization set up in Section 3
the observations in the anomalous streams are exponentially distributed with mean 1/(Œª0 ‚àíŒ∏),
where Œ∏ ‚àà [0, Œ∏‚àó ) where Œ∏‚àó = Œª0 . This second setting allows us to explore the influence
of heavier tails. In fact, the exponential tails are the heaviest tails for which we provide
asymptotic guarantees.
In all simulations considered we assume the observations in the anomalous streams have
distribution FŒ∏ , where
s
2œÅ‚àó (Œ≤)
log(n) ,
(17)
Œ∏œÑ = œÑ
œÉ02 t
with œÑ ‚â• 0. In words, we consider a signal strength that is a multiple of the asymptotically
minimal signal strength œÅ‚àó (Œ≤) needed for detection. Asymptotically we know that when
œÑ < 1 all tests are powerless, and when œÑ > 1 the permutation higher criticism test is
powerful. In all simulations, test are calibrated at a significance level of 5%.

5.3

Grid choice

Although the grid Q proposed in Theorem 3 is valid asymptotically, it can leave out valuable
information in finite samples, where the global maximum of Vq (X) can be attained for q > 1.
To safeguard the approach against this issue one can instead use a data-dependent grid, such

14
that the grid contains a sufficiently large point q ‚àó for which NÃÇq‚àó (X) = 0. A specific choice is


M 2t
2M 2 t
M 2t
maxi,j {Xij } ‚àí X
Q = 0,
,
,...,
, with M ‚â°
.
(18)
2kn log(n) 2kn log(n)
2 log(n)
œÉX
(Recall the definitions given in (12).) The statement in Theorem 3 still holds for this grid,
as long as the number of elements in the grid kn is not larger than no(1) , and the grid
Q approximates the range [0, 1] with increasing accuracy as n increases. To satisfy both
requirements, a suitable choice for the number of elements kn is given by:
M 2t
kn =
dn ,
2 log(n)

(19)

where dn is a slowly diverging function. Note that 1/dn is the spacing between consecutive
grid points. We show in this section that dn = log n is a suitable default choice. Nevertheless,
provided dn ‚Üí ‚àû and dn = no(1) , Lemma 4 ensures that kn = no(1) with high probability.
It is then possible to adapt the proof of Theorem 3 to get the same guarantees for this grid
choice as explained, but this clutters the proof with undesirable technicalities.
It has been suggested in related works (Arias-Castro et al., 2011; Wu et al., 2014) that scanning over a discrete grid for this type of statistic is merely a proof artifact, and the results are
also valid when q in (16) is optimized over the continuous interval [0, ‚àû). We have conducted
extensive numerical experiments regarding the choice of grid and observed no deteriorating
performance for extremely fine grid choices. However, since we use permutation-based estimates PÃÇq (XœÄ ) the number of specific values of q we need to consider to optimize Vq over
[0, ‚àû) becomes significantly larger than n, in principle as large as nB where B is the number of permutations considered. So, from a practical standpoint it is still rather useful to
consider the proposed quantization.
We thus focus on the finite choice as in (18) in all experiments. To recommend the reader
a choice of dn , we simulate data from both models outlined in Section 5.2 and compare the
performance of the tests for different choices of dn as in (19). We use n = 103 streams
of length t = d(log n)2 e = 48. For the experiments shown we took |S| = 12, (i.e. Œ≤ ‚âà
0.64, moderately sparse regime), but through extensive experimentation we observed our
conclusions are not sensitive to the sparsity. The results are given in Figure 1. We observe
that a spacing of 1/dn = 1/ log(n) is a reasonable choice. In all remaining experiments, we
therefore extend the grid as in (18) and (19) with dn = log(n).

5.4

Comparison with an oracle test

We now compare our methodology with the oracle test making full use of the null distribution.
The oracle test statistic is defined in (9) for the normal model. For the exponential model the
stream averages are Gamma-distributed, and so one uses the quantiles of that distribution
to compute pq instead. The oracle-test is then calibrated by Monte-Carlo simulation. For
this calibration, 104 simulations were used. In the presentation we use HC-permutation and
HC-oracle to refer to the two tests.
We compare the oracle test with our methodology with respect to two aspects:

15

1

1
d n = log(n) 1.5

0.8

d n = log(n)

d n = log(n)

0.8

0.5

0.6

Power

Power

d n = log(n) 1.5

d n = log(n)

0.6

0.4

0.4

0.2

0.2

0

d n = log(n) 0.5

0
0

0.5

1

1.5

(a) Normal setting.

2

2.5

0

0.5

1

1.5

2

2.5

(b) Exponential setting.

Figure 1: Comparison of power of our permutation-based higher criticism test under different
choices of dn as in (19). The power of the test is depicted as a function of a œÑ in the
parameterization in (17). We took n = 103 streams with length t = 48 and set |S| = 12. For
each test 103 permutations were used. Each level was repeated 103 times, resulting in the
95% confidence bars depicted.
‚Ä¢ Stream lengths. Given that calibration by permutation is meaningless for t = 1 we
expect the performance gap between an oracle and the proposed test to be large for
small streams. However, we observe the finite-sample performance is already quite
comparable to the oracle test even for very small streams.
‚Ä¢ Performance loss. Our test makes no use of knowledge of the null distribution. While
asymptotically equivalent to first order, we expect a performance loss in finite samples
compared to the oracle.
We use n = 103 streams in our simulations. To study the influence of stream length we
considered |S| = 12 (i.e. Œ≤ ‚âà 0.65, moderately sparse regime) but the results are qualitatively identical for other choices of sparsity. The signal strength was chosen slightly above
the asymptotic detectability threshold, but ensuring the difference in performance was highlighted. For the exponential model very short streams would lead to a value Œ∏ ‚â• Œª0 in the
parameterization in (17), so the shortest stream considered is t = 4. Figure 2 show that
the performance is comparable with respect to the oracle tests even at very short lengths,
suggesting that finite-sample performance is much more forgiving than what our theoretical
characterization might suggest, as there is only a very small loss of power in comparison
to an oracle. Naturally, the permutation test has no power for streams of length t = 1.
Note that the strength of the anomalous signal is decreasing in t, such that in the normal
model the oracle test performs identically for any value of t. In contrast, for the exponential
model, the difference in null and alternative means is Œ∏/(Œª0 (Œª0 ‚àí Œ∏)) and is larger for smaller
streams, so all tests perform worse at larger values of t.
We now turn our attention to the power characteristics of the proposed tests. We fix n = 103

16

0.6

1
HC-permutation
HC-oracle

0.9

0.5

0.8
0.7

Power

Power

0.4
0.3

0.6
0.5

0.2

0.4
0.1
HC-permutation
HC-oracle

0
100

101

102

0.3
0.2

101

t

(a) Normal setting: œÑ = 1.5.

102

103

t

(b) Exponential setting: œÑ = 1.25.

Figure 2: Comparison of power of our permutation-based higher criticism test and the oracle
test, as a function of a stream length t. We used the parameterization in (17) with a fixed
level for œÑ . Note that the strength of the anomalous signal is decreasing in t as discussed
in the text. For the exponential model, the parametrization of the alternative is undefined
for t ‚â§ 3, so the t-axis starts at t = 4. We took n = 103 streams and set |S| = 12. For
the permutation tests, 103 permutations were used. For the oracle test, the Monte-Carlo
calibration is based on 104 samples. Each level was repeated 103 times, resulting in the 95%
confidence bars depicted.
and t = d(log n)2 e = 48 and consider |S| = 12 (i.e. Œ≤ ‚âà 0.64, moderately sparse regime),
and |S| = 3 (i.e. Œ≤ ‚âà 0.84, very sparse regime). The results are plotted in Figure 3, and we
see that the proposed permutation higher criticism test has only minute loss of power when
compared to the oracle test.

5.5

Comparison with approximation methods

As mentioned earlier, several authors have considered practical variants of higher criticism
where the permutation stream means are assumed to be approximately normal, and therefore
the test statistic is computed based on a normal approximation (e.g., see Sabatti et al.
(2009); Wu et al. (2014) and references therein). In essence, instead of computing (or, more
appropriately, estimating) PÃÇq (X) as we do in Equation (13), one could instead compute:
p
pŒ¶
q = 1 ‚àí Œ¶( 2q log(n)) ,
which arises from the assumption that the standardized permutation stream means Yi (XœÄ )
are approximately standard normal. The statistic can then be computed like before, and
calibrated by permutation. We refer to this methodology as HC-approximation in what
follows. We also present results of the max test.
To compare the two approaches, we consider the exponential setting outlined in Section 5.2
with n = 100 streams and t = 4 and t = 6 as stream length. The reason to take a smaller

17

1

1
HC-permutation
HC-oracle

0.8

0.8

0.6

0.6

Power

Power

HC-permutation
HC-oracle

0.4

0.4

0.2

0.2

0

0
0

0.5

1

1.5

2

2.5

0

(a) Normal setting: |S| = 12.

1

1.5

2

2.5

(b) Exponential setting: |S| = 12.

1

1
HC-permutation
HC-oracle

HC-permutation
HC-oracle

0.8

0.8

0.6

0.6

Power

Power

0.5

0.4

0.4

0.2

0.2

0

0
0

0.5

1

1.5

2

(c) Normal setting: |S| = 3.

2.5

0

0.5

1

1.5

2

2.5

(d) Exponential setting: |S| = 3.

Figure 3: Comparison of power of our permutation-based higher criticism test and the
oracle test, as a function of a multiplicative factor œÑ in the parameterization in (17). We
took n = 103 streams with length t = 48. For the permutation tests, 103 permutations were
used. For the oracle test, the Monte-Carlo calibration is based on 104 samples. Each level
was repeated 103 times, resulting in the 95% confidence bars depicted.

18

1

1
HC-permutation
HC-approximation
Max test

0.8

0.6

Power

Power

0.8

HC-permutation
HC-approximation
Max test

0.6

0.4

0.4

0.2

0.2

0

0
0

0.5

1

(a) Exponential setting: t = 4.

1.5

0

0.5

1

1.5

2

(b) Exponential setting: t = 6.

Figure 4: Comparison of power of our permutation-based higher criticism test and a variant
using asymptotic approximations. The power of the test is depicted as a function of a œÑ in
the parameterization in (17). We took n = 102 streams and set |S| = 12. For each test 103
permutations were used. Each level was repeated 103 times, giving rise to the 95% confidence
bars depicted.
number of streams than before is to clearly emphasize the differences between the normal
approximation and permutation approaches. We set |S| = 12 (i.e. Œ≤ ‚âà 0.64), but similar
results can be obtained in the other regimes. Figure 4 depicts the results.
We see that there is a clear improvement in finite-sample performance when computing PÃÇq (X)
by permutation, as opposed to the normal approximation. As expected, the difference in
power decreases as the streams get longer, since the normal approximation becomes more
accurate. In any case, the approximation pŒ¶
q underestimates the true value of pq when
q is large, as the tail of a Gamma distribution is much heavier than that of a normal
distribution. Since PÃÇq (X) does not rely on asymptotic approximations it is able to more
accurately estimate pq , resulting on a more powerful test. Extensive experimentation showed
that the permutation-based approach appears to be always superior when the underlying
model is not normal.

5.6

An analysis of daily COVID-19 diagnoses across municipalities
in the Netherlands

After an initial explosive spread of COVID-19 several countries are entering a more stable
regime. When in such a regime, it is of high importance to policy makers to detect signs of
a new impending outbreak: for instance, when a few municipalities of the country reporting
higher-than-usual number of cases.
When the virus is circulating in a reasonably controlled fashion, the dynamics of the disease
transmission are homogeneous across different municipalities and a relatively short time-

19
frame is considered, it is not unreasonable to model the daily diagnoses per capita of each
municipality as originating i.i.d. from some unknown distribution. However, when the virus
is spreading fast in a few municipalities those will display a slightly higher-than-usual number
of daily-cases. As such, the framework we have introduced in this paper can be useful here
to detect signs of local outbreaks, as these would lead to rejection of our null hypothesis (1).
We consider data from the Netherlands. In this country, it is not unreasonable to assume
municipalities are sufficiently comparable: the country is very small and population density
is not too different among municipalities. We consider a timeframe of 5 days. Note that the
incubation period of COVID-19 is believed to be between two and fourteen days ‚Äì see, for
example Lauer et al. (2020).
We use data on new COVID-19 cases per 100.000 inhabitants from 13th of March up until
10th of August 2020, for each of the 355 municipalities of the Netherlands. This data was
processed from two sources; the data on the number of diagnoses (uncorrected for municipality population) was retrieved from the Dutch national institute for public health and the
environment (RIVM) at https://data.rivm.nl2 , and the data on municipality population was
retrieved from the Dutch central agency for statistics (CBS) at https://opendata.cbs.nl3 .
These were combined to obtain the number of COVID-19 cases per 100.000 inhabitants.
When tests are done on the raw data we often reject the null hypothesis due to one or a few
very large observations. While these cases are important in the context of the application,
one needs no powerful test to mark them as anomalous as their abnormality is so clear.
Especially in the context of COVID-19, these ‚Äúclear‚Äù outliers will be investigated regardless.
A more interesting question is then if, after removing ‚Äúclear‚Äù outliers, the other municipalities
still contain anomalous signals or not.
To remove ‚Äúclear‚Äù outliers in a rigorous way, we use the max test as described in Theorem 2.
We obtain the 95% quantile of the permutation maximum stream mean distribution, and
mark all observations exceeding this threshold as ‚Äúclear‚Äù anomalies. Then, we apply our
permutation higher criticism test as in Theorem 3, as well as the higher criticism test using
a normal approximation as in Section 5.5 on the remaining data to detect possible signals.
We apply our test sequentially over a sliding window of five days across the time domain,
and obtain results for each window. The sequential p-values obtained in this fashion are
plotted in Figure 5, along with the virus‚Äô nationwide progression. Obviously, the obtained
p-values are dependent and care must be taken when interpreting them - the figure is given
merely to aid the presentation.
As can be seen in Figure 5, our test results in much smaller p-values than the approximation
method at each window. There are cases where our test indicates anomalies in seemingly
stable periods. In these periods, while hard to see in aggregated data, we thus have some
evidence that some municipalities have larger-than-usual values. This does not necessarily
lead to a nationwide outbreak, since local measures, such as a restricting access to specific
2

The specific hyperlink to this data is https://data.rivm.nl/geonetwork/srv/dut/catalog.search#
/metadata/1c0fcd57-1102-4620-9cfa-441e93ea5604
3
The specific hyperlink to this data is https://opendata.cbs.nl/statline/?dl=2096B#/CBS/nl/dataset/
70072NED/table

20

3000
HC-permutation
HC-approximation
Number of daily diagnoses

0.9
0.8

p-value

0.7

2500

2000

0.6
0.5

1500

0.4
1000

0.3
0.2

Number of daily diagnoses

1

500

0.1
0
0

20

40

60

80

100

120

140

0
160

Time in days since 13th of March

Figure 5: The p-values of our permutation higher criticism test and the higher criticms test
using normal approximations for a sliding window of the previous five days, along with the
total number of daily diagnoses in the Netherlands. For each test 103 permutations were
used.
nursery homes, might have been taken to prevent further spread. As our data is aggregated
per municipality and local measures are very hard to identify, we are not able to take this
into account in our analysis.
Nonetheless, it would be interesting to identify the anomalous municipalities contributing to
the low p-value of our test. A natural, but perhaps naive approach here would be to compute
p-values of each stream by permutation, and apply suitable multiple-testing methods to
control the family-wise error rate or the false discovery rate. Note, however, that such
permutation p-values will be dependent, so standard methods as Benjamini and Hochberg
(1995) might lead to misleading results. Furthermore, note that the signal picked up by our
test may very well be too faint to be reliably estimated, but large enough to be detectable.
Donoho and Jin (2004) include a discussion on this in the normal model we consider. This
remains an interesting area for future research. Work related to this problem can be found,
for example, in Bartroff and Song (2016); Romano et al. (2008); Romano and Wolf (2007).

21

6

Discussion

This paper considered the problem of anomaly detection when one observes multiple streams
of data. This problem is closely related to the detection of sparse mixtures, where it is known
that a test based on a higher criticism statistics is asymptotically optimal. Computation
of this test statistics and calibration of the ensuing test requires the knowledge of the null
(nominal) distribution. In this work we propose a distribution-free version of the statistic
that is based on permutation ideas, and we show that it is also asymptotically optimal in
the context of one-parameter exponential families. The proposed test is exact, and appears
to be superior to alternative proposals that make use of asymptotic approximations. The
numerical results in Section 5.4 show that the calibration by permutation results in nearly
no loss of power in finite samples compared to an oracle test constructed and calibrated
with full distribution knowledge. Its usefulness on real statistical problem is demonstrated
in Section 5.6.
Our asymptotic results are proven for the class of exponential models. In Delaigle et al. (2011)
a less restrictive class of models is considered, for which the proposed testing methodology
attains a similar detection boundary when streams are of length t = n. We conjecture
that, when we consider a similar class of models (i.e., a location family where the base
distribution satisfies some tail-decaying condition) the detection boundary œÅ‚àó (Œ≤) is attained
as well, provided the streams are long enough. Specifically, when the tails of the base
distribution are decaying exponentially, a stream length t = œâ(log3 n) suffices, as shown in
our work. For Pareto tails, we conjecture that at least t = œâ(n) is needed to attain the œÅ‚àó (Œ≤)
detection boundary, using large and moderate deviations theory results from Mikosch and
Nagaev (1998). One should keep in mind, however, that in an arbitrary location family the
stream means are in general not a sufficient statistic for the location parameter, therefore the
optimal detection boundary might not be characterized in the same way as for the normal
model. For example, if FŒ∏ is the uniform distribution in [Œ∏, Œ∏ + 1] a test based on the stream
means will surely be suboptimal.
Further research could discuss the possibility of adapting the Berk-Jones statistic (Berk
and Jones, 1979) in a similar fashion. Alternatively, one could investigate the possibility of
replacing the observations by their ranks. This has numerical advantages and in some cases
leads only to a minor loss of power (Arias-Castro et al., 2018). A thorough analysis of this
proposal is challenging as one must carefully account for the dependencies induced by the
use of ranks, and remains an interesting avenue for future work.

Acknowledgments
Ivo Stoepker would like to thank Richard A.J. Post for interesting discussions on applications
of our methods. Rui Castro and Ery Arias-Castro would like to thank Ervin TaÃÅnczos and
Meng Wang for helpful discussions in the early stages of this project.

22

7

Proofs

In this section we provide the proofs of our main results. We begin with a simple technical
lemma that greatly facilitates the presentation. The proof is a trivial consequence of standard
tail-bounds for the normal approximation (Feller, 1968, Section 7.1, Lemma 2).
Lemma 1. Let Œ¶ be the cumulative distribution function of the standard normal distribution
and x ‚â• 0. Then

p
2(x + o(1)) log(n) = n‚àíx+o(1) as n ‚Üí ‚àû .
1‚àíŒ¶
Next, we argue that for the proofs of our main results, we can assume F0 has zero mean and
unit variance.

7.1

Simplifying assumption

To prove the results in this paper it suffices to consider the case where the nominal distribution F0 has zero mean and unit variance. To see this suppose F0 has arbitrary mean and
variance ¬µ0 and œÉ02 . Define FÃÉ0 (x) = F0 (¬µ0 + œÉ0 x). It is easy to see the distribution FÃÉ0 has
zero mean and unit variance. Using this we can easily re-parameterize the hypothesis test
in (10).
Let X be a random variable with distribution FŒ∏ for some Œ∏ ‚àà [0, Œ∏‚àó ) and define XÃÉ =
R
X‚àí¬µ0
. Define also œïÃÉ0 (Œ∏ÃÉ) = eŒ∏ÃÉx dFÃÉ0 (x), the moment generating function of FÃÉ0 . It is easy to
œÉ0


check that XÃÉ has density with respect to FÃÉ0 given by exp Œ∏ÃÉx ‚àí log(œïÃÉ(Œ∏ÃÉ)) where Œ∏ÃÉ = œÉ0 Œ∏
(equivalently Œ∏ = œÉ10 Œ∏ÃÉ). Therefore, statements in Œ∏ÃÉ pertaining a zero mean and unit variance
distribution can be translated to a general distribution by simple multiplication by a factor
1/œÉ0 .

7.2

Proof of Theorem 1

Proof. Without loss of generality and as explained in Section 7.1 we assume that F0 has
mean zero and variance one, as this makes the arguments easier and less cluttered.
Let œà(X) : Rnt ‚Üí {0, 1} denote an arbitrary test function. We begin by bounding the worst
case risk of this test by the average risk, namely
R(œà) = P‚àÖ (œà(X) 6= 0) + max PS (œà(X) 6= 1)
S:|S|=s

‚â• P‚àÖ (œà(X) 6= 0) +

1 X

PS (œà(X) 6= 1) .
n
s

S:|S|=s

The average risk can naturally be interpreted as the risk of testing the simple null hypothesis
against a simple alternative, where S is chosen uniformly at random over the class of all

23
subsets of [n] with cardinality s. Since we are doing a test between two simple hypotheses
the optimal test (i.e., the test minimizing the average risk) is given by the Neyman-Pearson
lemma, namely œà(X) = 1 {L ‚â• 1} where L is the likelihood ratio given by
L‚â°

X
1 X

exp
(Œ∏X
‚àí
ts
log(œï
(Œ∏)))
with
X
‚â°
Xij .
S
0
S
n
s

S:|S|=s

i‚ààS,j‚àà[t]

The risk of this test can be easily expressed as 1 ‚àí 21 E (|L ‚àí 1|), where the expectation is
with respect to the null hypothesis (so all Xij are i.i.d. with distribution F0 ). To proceed we
need to get an upper bound on E (|L ‚àí 1|). A simple, but often useful way to proceed is to
use Jensen‚Äôs inequality to get
p
p
E (|L ‚àí 1|) ‚â§ E ((L ‚àí 1)2 ) = E (L2 ) ‚àí 1 ,
where the equality above follows since E (L) = 1. This approach is generally referred to as
the second moment method. To show any test is asymptotically powerless it suffices therefore
to show that E (L2 ) converges to one as n ‚Üí ‚àû.
To simplify the presentation let S and S 0 denote two independent random variables, and both
independent from X. Both S and S 0 are sampled uniformly from the set {S ‚äÇ [n] : |S| = s}.
Then clearly L = E (exp (Œ∏XS ‚àí ts log(œï0 (Œ∏))) |X) and therefore

E L2 = E (exp (Œ∏XS ‚àí ts log(œï0 (Œ∏))) exp (Œ∏XS 0 ‚àí ts log(œï0 (Œ∏))))
= E (exp (Œ∏(XS + XS 0 ) ‚àí 2ts log(œï0 (Œ∏))))
= E (exp (t|S ‚à© S 0 |(log œï0 (2Œ∏) ‚àí 2 log œï0 (Œ∏)))) .
For the last equality we used the fact that for all S and S 0 we have XS +XS 0 = 2XS‚à©S 0 +XS4S 0
(in the previous expression 4 denotes the symmetric set difference).
The beauty of the above result is that is reduces quantification of the risk to a statement
about the moment generating function of the random variable K ‚â° |S ‚à© S 0 |. Given the distribution S and S 0 we conclude that K has an hypergeometric distribution with parameters
(n, s, s), and therefore K is stochastically bounded from above by the binomial distribus
). Using the well-know expression for the moment generating
tion with parameters (s, n‚àís
function of a binomial distribution we conclude that

s
s
s
E L2 ‚â§ 1 ‚àí n‚àís
+ n‚àís
Œ∫(Œ∏)t ,
where Œ∫(Œ∏) ‚â° œï0 (2Œ∏)/œï0 (Œ∏)2 . Therefore E (L2 ) ‚Üí 1 provided
s2
(Œ∫(Œ∏)t ‚àí 1) ‚Üí 0 .
n‚àís
Consider now the specific parameterizations of s and Œ∏ in the theorem statement. Note that
when t = œâ(log3 n) then necessarily Œ∏ ‚Üí 0, so we can conveniently use a Taylor expansion
of the moment generating function œï0 (Œ∏) around Œ∏ = 0:
œï0 (Œ∏) = œï0 (0) + Œ∏œï00 (0) +

Œ∏2 00
œï (0) + O(Œ∏3 ) ,
2 0

(20)

24
as Œ∏ ‚Üí 0. Using the fact that F0 has mean zero and unit variance we get œï0 (Œ∏) = 1 +
1 2
Œ∏ + O(Œ∏3 ) as Œ∏ ‚Üí 0. Simple asymptotic algebra yields that Œ∫(Œ∏) = 1 + Œ∏2 + O(Œ∏3 ). Since
2
1 + x ‚â§ ex we conclude that Œ∫(Œ∏) ‚â§ exp (Œ∏2 + O(Œ∏3 )).
When Œ≤ > 1/2 we conclude that
s2
(Œ∫(Œ∏)t ‚àí 1) = (1 + o(1))n1‚àí2Œ≤ (Œ∫(Œ∏)t ‚àí 1)
n‚àís


‚â§ (1 + o(1))n1‚àí2Œ≤ exp tŒ∏2 + O(tŒ∏3 ) ‚àí 1
= (1 + o(1))exp ((1 ‚àí 2Œ≤) log n) (exp (2r log n + o(1)) ‚àí 1) .
The last expression converges to 0 provided 1 ‚àí 2Œ≤ + 2r < 0 meaning that when r < Œ≤ ‚àí 1/2
any test is asymptotically powerless. This lower bound is tight when Œ≤ ‚àà (1/2, 3/4] (the
moderately sparse regime) but it is a bit loose for the very sparse regime. However, a
modification of the above argument allows us to get a tight lower bound when Œ≤ > 3/4.
The very sparse regime: the main limitation of the second moment method as presented
above has to do with the fact that the likelihood ratio statistic L might take rather large
values. Although this might be a rare occurrence, it can be enough to ensure the second
moment is much larger than the first moment. A way to mitigate this issue is to consider a
so-called truncated second moment method. Let ‚Ñ¶ denote an arbitrary event and define the
truncated likelihood ratio LÃÉ ‚â° L1 {‚Ñ¶}. Clearly LÃÉ ‚â§ L and therefore


E (|L ‚àí 1|) = E |L ‚àí LÃÉ + LÃÉ ‚àí 1|


 
‚â§ E |LÃÉ ‚àí 1| + 1 ‚àí E LÃÉ
r  
 
 
‚â§ E LÃÉ2 ‚àí 2E LÃÉ + 1 + 1 ‚àí E LÃÉ ,
where we used the triangle inequality and the fact that E (L) = 1, followed by Jensen‚Äôs

inequality. Therefore, to show a test is powerless it suffices to show that both E LÃÉ and
 
E LÃÉ2 converge to one as n ‚Üí ‚àû. The choice of event ‚Ñ¶ is therefore quite crucial. In the
present context we are going to consider the event
Ô£±
Ô£º
Ô£¥
Ô£¥
r
Ô£¥
Ô£¥
Ô£≤
2(1 + Œ∑) log n Ô£Ω
‚Ñ¶ = max Yi <
,
(21)
Ô£¥
Ô£¥
i‚àà[n]
t
Ô£¥
Ô£¥
|
{z
}
Ô£≥
Ô£æ
‚â°œÑ (Œ∑)

where Œ∑ > 0 must be carefully chosen.
 
Truncated first moment: Note first that E LÃÉ = E (L1 {‚Ñ¶}) is the probability of ‚Ñ¶
under the alternative hypothesis (where there is a set S of anomalous streams and S is chosen
uniformly at random over the subsets of [n] with cardinality s). Given the symmetry of the

25
 
definition of ‚Ñ¶ we see that E LÃÉ = PS (‚Ñ¶) where S is an arbitrary set with cardinality s.
Without loss of generality let S = [s]. Then
 
E LÃÉ = PS (‚Ñ¶)


= 1 ‚àí PS max Yi ‚â• œÑ (Œ∑)
i‚àà[n]

= 1 ‚àí sPS (Y1 ‚â• œÑ (Œ∑)) ‚àí (n ‚àí s)P‚àÖ (Y1 ‚â• œÑ (Œ∑)) .
using the union bound in the last line. Using Lemma 6 we conclude that
P‚àÖ (Y1 ‚â• œÑ (Œ∑)) = n‚àí1+Œ∑+o(1) ,
and provided r ‚â§ 1 + Œ∑

‚àö

PS (Y1 ‚â• œÑ (Œ∑)) = n‚àí(

‚àö
1+Œ∑‚àí r)2 +o(1)

.

Therefore, when r ‚â§ 1 + Œ∑
 
‚àö
‚àö 2
E LÃÉ = 1 ‚àí n1‚àíŒ≤ n‚àí( 1+Œ∑‚àí r) +o(1) ‚àí (n ‚àí s)n‚àí1+Œ∑+o(1)
‚àö

‚àö

2

= 1 ‚àí n1‚àíŒ≤‚àí( 1+Œ∑‚àí r) +o(1) ‚àí O(1) ‚Üí 1 ,
‚àö
‚àö
provided r < ( 1 + Œ∑ ‚àí 1 ‚àí Œ≤)2‚àö
. This means the first truncated moment converges to one
for any Œ∑ > 0, provided r < (1 ‚àí 1 ‚àí Œ≤)2 .
Truncated second moment: bounding this term requires significantly more work. Begin
by noting that
 
E LÃÉ2 = E (exp (2Œ∏XS‚à©S 0 + Œ∏XS4S 0 ‚àí ts log(œï0 (Œ∏))) 1 {‚Ñ¶})
Ô£´
Ô£∂
Y
1 {Yi < œÑ (Œ∑)}Ô£∏
= œï0 (Œ∏)‚àíst E Ô£≠exp (2Œ∏XS‚à©S 0 ) exp (Œ∏XS4S 0 )
i‚àà[n]

!

‚â§ œï0 (Œ∏)‚àíst E exp (2Œ∏XS‚à©S 0 ) exp (Œ∏XS4S 0 )

Y

1 {Yi < œÑ (Œ∑)}

i‚ààS‚à™S 0

‚â§ œï0 (Œ∏)‚àíst E (exp (t|S ‚à© S 0 |(log œïÃÉ0 (2Œ∏)) ‚àí t|S4S 0 |(log œïÃÉ0 (Œ∏))) ,
where œïÃÉ0 (Œ∏)t ‚â° E (exp (Œ∏tY1 ) 1 {Y1 < œÑ (Œ∑)}). The steps above mimic the derivation for the
regular second moment, and the main difference is that we now need to consider the moment
generating function of a truncated distribution, instead of the original distribution. Clearly
œïÃÉ0 (Œ∏) ‚â§ œï0 (Œ∏) and so we conclude that
 
E LÃÉ2 ‚â§ E (exp (t|S ‚à© S 0 |(log œïÃÉ0 (2Œ∏) ‚àí 2 log œï0 (Œ∏)))) .
Define Œ∫ÃÉ(Œ∏) ‚â° œïÃÉ0 (2Œ∏)/œï0 (Œ∏)2 . As before, to show the truncated moment converges to zero it
suffices to show that
s2
(Œ∫ÃÉ(Œ∏)t ‚àí 1) ‚Üí 0 .
n‚àís

26
Note that, the argument based on the untruncated second moment method indicates all tests
are powerless if r < Œ≤ ‚àí 1/4. Since we are considering the case Œ≤ ‚â• 3/4 this means that it
suffices to treat only the case where r ‚â• 3/4 ‚àí 1/2 = 1/4. To get an upper bound on œïÃÉ0 (2Œ∏)t
we make use of the following technical result.
Lemma 2. Let X be a real-valued random variable and let f : R ‚Üí [0, ‚àû) be one-to-one
increasing and differentiable. Then, for any œÑ ‚àà R,
Z œÑ
P(X > x)f 0 (x)dx .
(22)
E (f (X)1 {X ‚â§ œÑ }) =
‚àí‚àû

To use this lemma we must get a good upper bound on P‚àÖ (Y1 > x) for x ‚â§ œÑ (Œ∑). When
x ‚â§ 0 we trivially bound this probability by one, and for 0 ‚â§ x < Œ∏‚àó we make use of a simple
Chernoff bound. In a similar fashion to the proof of Lemma 6 we have
Ô£´
Ô£∂
X
P‚àÖ (Y1 > x) ‚â§ P‚àÖ Ô£≠
X1j ‚â• xtÔ£∏
j‚àà[t]

"

#!

‚â§ exp ‚àít

sup {Œªx ‚àí log(œï0 (Œª))}
Œª‚àà[0,Œ∏‚àó )

"

#!
sup {Œªx ‚àí log(1 + Œª2 /2 + O(Œª3 ))}

= exp ‚àít

Œª‚àà[0,Œ∏‚àó )


‚â§ exp ‚àít x2 ‚àí log(1 + x2 /2 + O(x3 ))}

‚â§ exp ‚àít(x2 /2 + O(x3 )) .


Let n be large enough so that œÑ (Œ∑) < Œ∏‚àó . Applying the above result and Lemma 2 we get
Z œÑ (Œ∑)
t
P (Y1 > x) 2Œ∏texp (2Œ∏tx) dx
œïÃÉ0 (2Œ∏) =
‚àí‚àû
0

Z
‚â§

Z
2Œ∏texp (2Œ∏tx) dx +

‚àí‚àû

œÑ (Œ∑)


exp ‚àít(x2 /2 + O(x3 )) 2Œ∏texp (2Œ∏tx) dx

0

Z

œÑ (Œ∑)


exp ‚àít(x2 /2 + O(x3 )) exp (2Œ∏tx) dx
0
Z

 œÑ (Œ∑)

2
3
= 1 + 2Œ∏texp 2Œ∏ t exp O(tœÑ (Œ∑))
exp ‚àít(x ‚àí 2Œ∏)2 /2) dx

‚â§ 1 + 2Œ∏t

0

‚àö

‚àö

‚àö

 (œÑ (Œ∑)‚àí2Œ∏) t 1
2
‚àö
= 1 + 8œÄ(1 + o(1))(Œ∏ t)exp 2Œ∏2 t
exp
‚àíy
/2
dy
‚àö
2œÄ
‚àí2Œ∏ t
‚àö
‚àö
‚àö

‚â§ 1 + 8œÄ(1 + o(1))(Œ∏ t)exp 2Œ∏2 t Œ¶((œÑ (Œ∑) ‚àí 2Œ∏) t) ,
Z

where in the second to last step we used the fact that t = œâ(log3 n). At this point note that
r 
2
p
‚àö
‚àö
(œÑ (Œ∑) ‚àí 2Œ∏) t = ‚àí 2
4r ‚àí 1 + Œ∑ log n < 0

27
when r ‚â• 1/4, provided we choose Œ∑ > 0 sufficiently small. Therefore using Lemma 1 we
conclude that
‚àö
p
‚àö
‚àö
2
œïÃÉ0 (2Œ∏)t ‚â§ 1 + 8œÄ(1 + o(1)) 2r log nn4r n‚àí( 4r‚àí 1+Œ∑) +o(1)
‚àö
p
‚àö
‚àö
2
= 1 + 8œÄ(1 + o(1)) 2r log n n4r‚àí( 4r‚àí 1+Œ∑) +o(1)
‚àö

= n4r‚àí(

‚àö
4r‚àí 1+Œ∑)2 +o(1)

.

With an analogous argument to the one used for œïÃÉ(2Œ∏)t one can show that (œï0 (Œ∏))2t =
n2r+o(1) . Therefore
‚àö
‚àö
s2
2
(Œ∫ÃÉ(Œ∏)t ‚àí 1) = o(1) + n1‚àí2Œ≤+2r‚àí( 4r‚àí 1+Œ∑) +o(1) .
n‚àís
‚àö
‚àö
2
The above converges to zero when
‚àö is the 2case Œ∑
‚àö 1 ‚àí22Œ≤ + 2r ‚àí ( 4r ‚àí 1 + Œ∑) < 0. This
is small enough and r < (1 ‚àí 1 ‚àí Œ≤) , since in that case 1 ‚àí 2Œ≤ + 2r ‚àí ( 4r ‚àí 1) < 0,
completing the proof.

7.3

Proof of Theorem 2

Proof. By the arguments in Section 7.1, the proof continues under the assumption that F0
has zero mean and unit variance.
Under the null and for a given (but arbitrary) permutation œÄ ‚àà Œ† it is clear that XœÄ and
X have exactly the same distribution. Therefore maxi {Yi (X)} is uniformly distributed on
the set {maxi {Yi (XœÄ }, œÄ ‚àà Œ†} (with multiplicities) conditionally on the order statistics of
X. So, for a given Œ± > 0


œÄ
P‚àÖ (Pmax-perm (X) ‚â§ Œ±) = P‚àÖ {œÄ ‚àà Œ† : max{Yi (X )} ‚â• max{Yi (X)}} ‚â§ Œ±(nt)!
i

‚â§

i

bŒ±(nt)!c
‚â§Œ±,
(nt)!

If there are no ties, the first inequality above is an equality, but with ties present the test
becomes slightly more conservative. This argument is completely standard and for more
details on permutation tests the reader is referred to (Lehmann and Romano, 2005).
What remains to be proven is the behavior of the test under the alternative. Namely we
must show that, provided r is large enough (as stated in the proposition) then for any Œ± > 0
P‚àÖ (Pmax-perm (X) > Œ±) ‚àí‚Üí 0 .
For convenience, let œÄ be a uniformly distributed permutation of Œ† and let this be independent from X. We can rewrite our permutation p-value as a conditional probability:


Pmax-perm (X) = P max YiœÄ ‚â• max Yi X .
i

i

To get a good upper-bound on the permutation p-value we use the following concentration
inequality (see Shorack and Wellner (1986) and Arias-Castro et al. (2018), for instance).

28
Lemma 3 (Bernstein bound for sampling without replacement). Let (Z1 , . . . , Zm )
beP
sampled withoutPreplacement from the
Pn set {z1 , . .2. , zn }. Define zmax = maxj {zj }, z =
n
n
1
1
1
2
j=1 zj , Z = m
j=1 Zj and œÉz = n
j=1 (zj ‚àí z) . Then, for all œÑ ‚â• 0:
n

P Z ‚â• z + œÑ ‚â§ exp ‚àí


mœÑ 2
2œÉz2 + 23 (zmax ‚àí z)œÑ


.

Using this lemma, we find that


œÄ
Pmax-perm (X) = P max Yi (X ) ‚â• max Yi (X) X
i
i

X 
œÄ
‚â§
P Yk (X ) ‚â• max Yi (X) X
i

k‚àà[n]

Ô£´
=

X
k‚àà[n]

‚â§

X

PÔ£≠

Ô£∂
1X
t



œÄ
Xk,j
‚â• X + max Yi (X) ‚àí X



i

XÔ£∏

j‚àà[t]

t maxi Yi (X) ‚àí X

exp ‚àí

2

!


2
2œÉX
+ 23 (maxi,j Xij ‚àí X) maxi Yi (X) ‚àí X
!
2
t maxi Yi (X) ‚àí X
 .
= n ¬∑ exp ‚àí 2
2œÉX + 23 (maxi,j Xij ‚àí X) maxi Yi (X) ‚àí X
k‚àà[n]

The first inequality is a consequence of a simple union bound, and we used Lemma 3 in the
second inequality.
At this point it is clear that, to control the p-value of our test we need to characterize
2
, maxi,j Xij and maxi Yi (X) under the alternative hypothesis. Since
the behavior of X, œÉX
|S| = o(n) most of the elements of X are samples from the null distribution. Therefore we
2
should be good estimators for the mean and variance of F0 .
intuitively expect that X and œÉX
The behavior of the term maxi,j Xij is a bit more delicate, but one can see that for the given
parameterization of the null the dominant contribution is still given by the null distribution.
In contrast, the term maxi Yi (X) ‚àí X really depends on the alternative - the largest stream
mean is surely driven by the anomalous observations. Formally, we can show the following
result.
p
Lemma 4. Let Œ≤ ‚àà ( 12 , 1), Œ∏ =
2r(log n)/t with r > 0 and consider the alternative
hypothesis in (10). Assume F0 has zero mean and variance one and t = œâ(log(n)). Then
(i) X = OP



‚àö1
nt



2
and œÉX
= 1 + OP



‚àö1
nt



(ii) Let c ‚àà (0, Œ∏‚àó ‚àí Œ∏). Then,


3
P max Xij ‚àí X ‚â§ log(nt) ‚Üí 1 as n ‚Üí ‚àû .
i,j
c

29
‚àö
‚àö
(iii) Assume further that t = œâ(log3 (n)) and let Œµ > 0. Provided r > ( 1 + Œµ ‚àí 1 ‚àí Œ≤)2
we have
!
r
2(1 + Œµ)
log(n) ‚Üí 1
P max Yi (X) ‚àí X ‚â•
i
t
as n ‚Üí ‚àû.
The first result of the lemma provides a rate at which the bound on our sample variance
can decrease. For the analysis of the max test a much simpler result (already proved in
Arias-Castro et al. (2018)) suffices: for any Œµ > 0 (i) implies that

2
‚â§ (1 + Œµ/2) ‚Üí 1 .
PS œÉ X
Note also that the bound in Lemma 3 is monotonically decreasing in œÑ . This ensures
‚àö that
for
Œµ
>
0
and
with
probability
tending
to
one
under
the
alternative,
provided
r
>
(
1 + Œµ‚àí
‚àö
2
1 ‚àí Œ≤) , the overall p-value of test satisfies
Ô£´
Ô£∂
2(1 + Œµ) log(n)
Ô£∏ .
q
Pmax-perm (X) ‚â§ n ¬∑ exp Ô£≠‚àí
2
1
2(1 + Œµ/2) + 2Œµ + c log(nt) 2(1 + Œµ) t log(n)
Written differently, with probability tending to 1 under the alternative:
Ô£∂
Ô£´
1+Œµ
Ô£∏ .
q
log Pmax-perm (X) ‚â§ log(n) Ô£≠1 ‚àí
log(n)
1
1 + Œµ/2 + c (log(n) + log(t)) 2(1 + Œµ) t
To ensure Pmax-perm (X) ‚Üí 0, or equivalently, log Pmax-perm (X) ‚Üí ‚àí‚àû it suffices to ensure
r
1
log(n)
(log(n) + log(t)) 2(1 + Œµ)
< Œµ/2 .
c
t
However, since we assume t = œâ(log3 (n)) this is immediately satisfied, since the l.h.s. converges to zero.
‚àö
‚àö
We have just proved that, for Œµ > 0 and r > ( 1 + Œµ ‚àí 1 ‚àí Œ≤)2 , Pmax-perm (X) ‚Üí 0 as
n ‚Üí ‚àû. Since Œµ > 0 is arbitrary this implies the result in the theorem, concluding the
proof.

7.4

Proof of Theorem 3

Proof. By the arguments in Section 7.1, the proof continues under the assumption that F0
has zero mean and unit variance. Furthermore the conservativeness of this test follows by
the standard argument already presented in the proof of Theorem 2.
For the rest of the proof consider alternative hypothesis. We must show that
PS (Pperm-hc (X) < Œ±) ‚Üí 1

30
as n ‚Üí ‚àû. Like before, we can write our permutation p-value as a conditional probability
as follows:


œÄ
Pperm-hc (X) = PS TÃÇ (X ) ‚â• TÃÇ (X) X ,
where œÄ is independent from X and uniformly distributed over Œ†. The first step is to
understand and simplify the role of œÄ in the above expression. This mirrors the analysis
under the null hypothesis in the proof of Theorem 2, as we need to show that the values
of the test statistic computed with permuted data are a good surrogate for the values of
the test statistic under the null. However, the argument becomes more complex due to the
dependencies introduced by the permutation. Like before, we will use the union bound for
the max-operator in the permuted statistic, inducing a multiplicity by the grid-size:

 X 

œÄ
œÄ
Pperm-hc (X) = PS max VÃÇq (X ) ‚â• TÃÇ (X) X ‚â§
PS VÃÇq (X ) ‚â• TÃÇ (X) X .
(23)
q‚ààQ

q‚ààQ

To proceed recall that quantifying VÃÇq (XœÄ ) requires the quantification of two terms: NÃÇq (XœÄ )
and PÃÇq (XœÄ ). Note, however, that PÃÇq (X) is invariant under permutations of X, and therefore
PÃÇq (XœÄ ) = PÃÇq (X), as explained before. As such the only random quantity
inside the proba

bility symbol above (conditionally on X) is NÃÇq (XœÄ ). Noting that E NÃÇq (XœÄ ) X = nPq (X)
we have

q


X 
œÄ
œÄ
PS NÃÇq (X ) ‚àí E NÃÇq (X ) ‚â• TÃÇ (X) nPÃÇq (X)(1 ‚àí PÃÇq (X)) X . (24)
Pperm-hc (X) ‚â§
q‚ààQ

To apply Chebyshev‚Äôs inequality we need the right-hand-side of the inequality inside the
probability to be positive, and TÃÇ (X) might be negative. In the latter case we simply bound
the probability by one. Therefore, using Chebyshev‚Äôs inequality we get
n
o


n
o 1 TÃÇ (X) > 0 X Var NÃÇq (XœÄ ) X
Pperm-hc (X) ‚â§ 1 TÃÇ (X) ‚â§ 0 +
,
(25)
TÃÇ (X)2
n
PÃÇ
(X)(1
‚àí
PÃÇ
(X))
q
q
q‚ààQ
where we convention that 0/0 = 0. To continue, we must quantify the conditional variance
of NÃÇq (XœÄ ). The permutation on X causes dependencies, but these are benign when realizing
the conditional permuted stream means are negatively associated conditional on the data.
Using Theorem 2.11 and the properties P6 and P4 in Joag-Dev and Proschan (1983), we find
that Yi (XœÄ )|X and Yj (XœÄ )|X are negatively associated if i 6= j. For ease of notation, define
r
2
2qœÉX
zq = X +
log(n) .
t
Then,

 X
œÄ
Var NÃÇ (q) X =
Var (1 {Yi (XœÄ ) ‚â• zq } | X)
i‚àà[n]

+

XX

Cov (1 {Yi (XœÄ ) ‚â• zq } , 1 {Yj (XœÄ ) ‚â• zq } | X)

i‚àà[n] j6=i

‚â§ nPÃÇq (X)(1 ‚àí PÃÇq (X)) ,

31
where we used the definition of negative association (Definition 2.1 from Joag-Dev and
Proschan (1983)). In conclusion we get the following simple bound for the p-value:
!
n
o
n
o
X
1
Pperm-hc (X) ‚â§
1 1 TÃÇ (X) > 0 + 1 TÃÇ (X) ‚â§ 0
TÃÇ (X)2 q‚ààQ
o
n
o
kn + 1 n
1
=
TÃÇ (X) > 0 + 1 TÃÇ (X) ‚â§ 0 .
(26)
TÃÇ (X)2
To continue the proof we must show that TÃÇ (X) is of order larger then kn = no(1) . This mimics
the approach in Proposition 1 and Theorem 2 under the alternative. Recall that TÃÇ (X) =
maxq‚ààQ VÃÇq (X), so it suffices to get a good lower bound for VÃÇq (X). This requires controlling
both PÃÇq (X) (which is random), and the counting term NÃÇq (X) that is more complicated than
before, as it involves estimates of the mean and variance of F0 . Furthermore, we are no longer
assuming normality. At this point we consider separately the cases Œ≤ > 1/2 and Œ≤ ‚â§ 1/2:
p
Let Œ∏ = 2r(log n)/t with r > 0. Provided t is large enough, the following lemma gives us
a high-probability upper bound for PÃÇq (X).
Lemma 5. Consider the setting of Lemma 4 and let q > 0 and t = œâ(log3 (n)). There exists
sequence gn ‚Üí 0 such that under both the null and alternative hypothesis


P PÃÇq (X) ‚â§ n‚àíq+gn ‚Üí 1 .
Let pÃÑq = n‚àíq+gn where gn is the sequence in the lemma above. Since VÃÇq (X) is decreasing in
PÃÇq (X) (see (14)) we find that, under the alternative, with probability converging to 1
NÃÇq (X) ‚àí npÃÑq
VÃÇq (X) ‚â• p
.
npÃÑq (1 ‚àí pÃÑq )
The next step is to get a high-probability lower-bound for the counting term. Our first aim
is to bound the effect of the sample statistics. For q > 0 define
Ô£º
Ô£±
v 

u
p
Ô£¥
Ô£¥
Ô£¥
Ô£¥
u 2 1 + log n/(nt) q
Ô£Ω
X Ô£≤
p
t
NÃÉq (X) ‚â°
1 Yi (X) ‚â• log n/(nt) +
log(n) .
Ô£¥
Ô£¥
t
Ô£¥
i‚àà[n] Ô£¥
Ô£æ
Ô£≥
p
‚àö 
2
By Lemma 4, we have X = OP 1/ nt and œÉX
= 1 + OP ( 1/nt). Note that we could
p
p
replace the terms log n/(nt) with g(n)/(nt), where g(n)/(nt) = o(1), but we chose this
for concreteness.
Therefore, we conclude that NÃÇq (X) ‚â• NÃÉq (X) with probability tending to 1. Thus, under the
alternative, we have the following high-probability lower bound for VÃÇq (X):
NÃÇq (X) ‚àí nPÃÇq (X)
NÃÉq (X) ‚àí npÃÑq
‚â•p
‚â° VÃÉq (X) ,
VÃÇq (X) = q
npÃÑq (1 ‚àí pÃÑq )
nPÃÇq (X)(1 ‚àí PÃÇq (X))

32
where the inequality holds with probability tending to 1.
All the remains to be show is that VÃÉq (X) is sufficiently large for an adequate value of q. It
is clear that NÃÉq (X) is a sum of two independent binomial random variables. Note that
Ô£∂
Ô£´
v 

u
p
u 2 1 + log n/(nt) q
p
Ô£¨
Ô£∑
t
Ô£¨
log(n)Ô£∑
wi,q ‚â° P Ô£≠Yi (X) ‚â• log n/(nt) +
Ô£∏
t
r

2q log n
t

r

2q(1 + o(1)) log n
t

= P Yi (X) ‚â•
= P Yi (X) ‚â•



1
‚àö +
qn

!
q
p
1 + log(n)/nt
!
.

Note that this probability is easily characterized by Lemma 6. Let pÃÉq ‚â° wi,q if i ‚àà
/ S and
vÃÉq ‚â° wi,q if i ‚àà S, so that under the alternative
NÃÉq (X) ‚àº Bin(n ‚àí s, pÃÉq ) + Bin(s, vÃÉq ),
Note that our probabilities pÃÉq and vÃÉq resemble the probabilities pq and vq considered in the
proof of Proposition 1. Using Lemma 6 we immediately conclude that pÃÉq = n‚àíq+o(1) and
 ‚àí(‚àöq‚àí‚àör)2 +o(1)
if r < q
n
.
vÃÉq =
o(1)
n
if r ‚â• q
Therefore pÃÑq , pÃÉq and vÃÉq all have the same asymptotic characterization as in the normal case,
so we can continue in an analogous fashion as in the proof of Proposition 1 and Theorem 2
and conclude that when r > œÅ‚àó (Œ≤)


PS max VÃÉq (X) ‚â• kn + 1 ‚Üí 1 ,
q‚ààQ

since kn = no(1) . We have now all the pieces needed to bound the p-value in (26). The
result just shown trivially implies that TÃÇ (X) ‚Üí 1 and (kn + 1)/TÃÇ 2 (X) ‚Üí 0 with probability
tending to one, and therefore
PS (Pperm-hc (X) ‚â§ Œ±) ‚Üí 1 ,
completing the proof.

33

7.5

Proof of Lemma 2

Proof. We have
E (f (X)1 {X ‚â§ œÑ }) =

Z

‚àû

P(f (X)1 {X ‚â§ œÑ } > t)dt

0

Z

f (œÑ )

P(f (X) > t)dt

=
0

Z

f (œÑ )

=
Z0 œÑ
=

P(X > f ‚àí1 (t))dt
P(X > x)f 0 (x)dx,

‚àí‚àû

where in the last line we changed the integration variable to x := f ‚àí1 (t).

7.6

Proof of Lemma 4

Proof. Let us start by characterizing the overall sample mean X. By Chebyshev‚Äôs inequality
we have



1
X = E X + OP ‚àö
,
nt
as n ‚Üí ‚àû. Now note that, under the alternative hypothesis
Z
 |S|
|S|
xexp (Œ∏x)
E (X) =
dF0 (x) ,
E X =
n
n
œï(Œ∏)
where X ‚àº FŒ∏ . A Taylor expansion of the function inside the integral around Œ∏ = 0 yields
Z
Z
xexp (Œ∏x)
dF0 (x) = x + x2 Œ∏ + O(Œ∏2 )dF0 (x)
œï(Œ∏)
= Œ∏ + O(Œ∏2 )
p

Finally Œ∏ = O
log(n)/t ‚Üí 0 since t = œâ(log(n)). Putting all this together yield the first
result stated in (i).
For the second result in (i) note that
1 X
1 X 2
2
(Xij ‚àí X)2 =
Xij ‚àí X
nt i,j
nt i,j
!
!
X


1 X
1
2
=
E Xij2
+
Xij2 ‚àí E Xij2
‚àíX
nt i,j
nt i,j

2
œÉX
=

34
For the first term we see that

1 X
1 X
1 X
E Xij2 =
Var (Xij ) +
Var (Xij ) + E (Xij )2
nt i,j
nt
nt
i‚ààS,j‚àà[t]
/

i‚ààS,j‚àà[t]

n ‚àí |S| |S|
+
(1 + O(Œ∏))
n
nr
!
log
n
,
= 1 + O n‚àíŒ≤
t

=

as n ‚Üí ‚àû. In the above the variance of the anomalous streams was characterized with a
Taylor expansion of Œ∏ around 0, similarly to what was done for the average term.
For the second term note first that all the moments of F0 are finite, in particular the fourth
moment. Therefore by Chebyshev‚Äôs inequality we have


1 X 2
1
X ‚àí E (Xij ) = OP ‚àö
.
nt i,j ij
nt
2

Finally, we know that X = OP (1/nt) when Œ≤ > 1/2. Putting everything together yields the
second result stated in (i).
The argument needed to prove (ii) is the same already used in Arias-Castro et al. (2018),
and presented here for completeness. Letting x > 0, a union bound gives






P max Xij > x ‚â§ P max Xij > x + P max Xij > x
i,j

i‚ààS,j‚àà[t]

i‚ààS,j‚àà[t]
/

‚â§ |S|t(1 ‚àí FŒ∏ (x)) + (n ‚àí |S|)t(1 ‚àí F0 (x)) .

(27)

Now, let c ‚àà (0, Œ∏‚àó ‚àí Œ∏). We have that:
Z ‚àû
1
1 ‚àí FŒ∏ (x) =
exp (Œ∏u) dF0 (u)
œï0 (Œ∏) x
Z ‚àû
1
=
exp ((Œ∏ + c)u) exp (‚àícu) dF0 (u)
œï0 (Œ∏) x
Z ‚àû
1
‚â§
exp (‚àícx)
exp ((Œ∏ + c)u) dF0 (u)
œï0 (Œ∏)
x
œï0 (Œ∏ + c)
‚â§
exp (‚àícx) .
œï0 (Œ∏)
Therefore, with considerable slack, we can take x = 2c log(nt) guarantee that both terms
in (27) converge to zero. Together with the characterization of X in (i) we conclude that


3
P max Xij ‚àí X ‚â§ log(nt) ‚Üí 1 .
i,j
c
To show part (iii) very different argument is needed as this is a lower-bound on the tail probability, rather than an upper bound. The following lemma gives a precise characterization
of the tail probability.

35
Lemma 6. Consider the setting of Lemma 4. Let i ‚àà S and let qn ‚Üí q > r as n ‚Üí ‚àû and
t = œâ(log3 n). Then
!
r
‚àö ‚àö 2
2qn log n
P Yi (X) ‚â•
= n‚àí( q‚àí r) +o(1) .
t

If q ‚â§ r we have P Yi (X) ‚â•

q

2qn log n
t



= no(1) .

To show (iii) begin by noting that
!
2(1 + Œµ)
P max Yi (X) ‚â•
log(n)
i‚àà[n]
t
!
r
2(1 + Œµ)
‚â• P max Yi (X) ‚â•
log(n)
i‚ààS
t
!!|S|
r
2(1 + Œµ)
log(n)
= 1 ‚àí 1 ‚àí P Yi (X) ‚â•
t
r

(28)

‚àö
‚àö
Consider the case where ( 1 + Œµ ‚àí 1 ‚àí Œ≤)2 < r < 1 + Œµ. Note that, in that case, we can
use Lemma 6 with (28) which gives:
!
r

|S|
2
‚àö
‚àö
2(1 + Œµ)œÉ0
‚àí( 1+Œµ‚àí r)2 +o(1)
log(n) = 1 ‚àí 1 ‚àí n
P max Yi (X) ‚â•
i‚àà[n]
t



‚àö
‚àö
1‚àíŒ≤
‚àí( 1+Œµ‚àí r)2 +o(1)
= 1 ‚àí exp n
log 1 ‚àí n


‚àö
‚àö 2
‚â• 1 ‚àí exp ‚àín1‚àíŒ≤ n‚àí( 1+Œµ‚àí r) +o(1) ,
where
in last
we simply used the fact that log(1 + ‚àö
x) ‚â• x. ‚àö
Finally, provided
‚àö
‚àö inequality
2
( 1 + Œµ ‚àí 1 ‚àí Œ≤) < r < 1 + Œµ we guarantee that 1 ‚àí Œ≤ ‚àí ( 1 + Œµ ‚àí r)2 + o(1) > 0.
The statement for r > 1 + Œµ follows immediately since this probability is monotonically
increasing in r. To get the statement in (iii) we just need to use this result together with
the characterization of X, concluding the proof.

36

7.7

Proof of Lemma 5

Proof. We begin by using Lemma 3 to obtain an upper-bound on PÃÇq (X)
!
r
2
2œÉX q
log(n) X
PÃÇq (X) = P Y1 (XœÄ ) ‚àí X ‚â•
t
Ô£´
Ô£∂
2
2œÉX q log(n)
Ô£∏
q
‚â§ exp Ô£≠‚àí
2 q
2œÉX
2
2
log(n)
2œÉX + 3 (maxi,j Xij ‚àí X)
t
Ô£´
Ô£∂
q log(n)
Ô£∏ .
q
= exp Ô£≠‚àí
2q
1
1 + 3 (maxi,j Xij ‚àí X) tœÉ2 log(n)
X

2
Now, part (i) of Lemma 4 implies that œÉX
‚â§ 1 + Œµ for Œµ > 0, with probability tending to 1.
Using part (ii) of the same lemma we get
Ô£∂
Ô£´
q log(n)
Ô£∏
q
PÃÇq (X) ‚â§ exp Ô£≠‚àí
2q
1
1 + c log(nt) t(1+Œµ) log(n)

with probability converging to 1. Therefore, provided t = œâ(log3 (n)) there is a function
gn ‚Üí 0 such that
PÃÇq (X) ‚â§ exp (‚àí(q + gn ) log(n)) .

7.8

Proof of Lemma 6

To streamline the presentation let W1 , . . . , Wt be i.i.d. with distribution
FŒ∏ and denote by
p
œïŒ∏ (x) the moment generating function of FŒ∏ . Define also œÑ = (2qn /t) log n. We start by
getting an upper bound for the said probability when r < q. A simple Chernoff bounding
argument yields
Ô£´
Ô£∂
"
#!
X
1
PÔ£≠
Wj ‚â• œÑ Ô£∏ ‚â§ exp ‚àít
sup {ŒªœÑ ‚àí log(œïŒ∏ (Œª))}
.
(29)
t
Œª‚àà[0,Œ∏‚àó ‚àíŒ∏)
j‚àà[t]

We must now characterize œïŒ∏ (Œª). First note that œïŒ∏ (Œª) = œï0 (Œª + Œ∏)/œï0 (Œ∏). Now, we develop
a Taylor expansion of œï0 (Œª) around Œª = 0, as we did in Equation (20). Note that F0 has
zero mean and unit variance. We obtain:
Œª2
œï0 (Œª) = 1 +
+ O(Œª3 ) ,
(30)
2
as Œª ‚Üí 0. A similar expansion can be developed for œï0 (Œª + Œ∏) around Œª + Œ∏ = 0. Combining
all this yields
œïŒ∏ (Œª) =

1 + 1/2(Œª + Œ∏)2 + O((Œª + Œ∏)3 )
Œª2
=
1
+
Œ∏Œª
+
+ O((Œª + Œ∏)3 ) ,
1 + Œ∏2 /2 + O(Œ∏3 )
2

37
as both Œª, Œ∏ ‚Üí 0, where we used a Taylor expansion for the fraction around Œ∏2 /2+O(Œ∏3 ) = 0.
This suggests the choice Œª‚àó = œÑ ‚àí Œ∏, which is positive provided n is large enough since r < q.
This choice yields the bound
{ŒªœÑ ‚àí log(œïŒ∏ (Œª))} ‚â• œÑ 2 ‚àí log(œïŒ∏ (Œª))

sup

Œª‚àà[0,Œ∏‚àó ‚àíŒ∏)


1
‚â• (œÑ ‚àí Œ∏)2 + O œÑ 3 ,
2
since œÑ > Œ∏ and we used the basic inequality log(1 + x) ‚â§ x. When t = œâ(log3 n) the first
term dominates, and therefore we conclude that
Ô£´
Ô£∂
X

‚àö
1
‚àö
PÔ£≠
Wj ‚â• œÑ Ô£∏ ‚â§ exp ‚àí( qn ‚àí r)2 (log n) + o(1)
t
j‚àà[t]

‚àö

= n‚àí(

‚àö
q‚àí r)2 +o(1)

.

To lower-bound the probability in (29) we use a tilting argument. Let Œ∏œÑ be such that FŒ∏œÑ
has mean œÑ . Such a choice exists for n large enough and necessarily Œ∏œÑ > Œ∏ for large n, since
r < q. Define WÃÉ1 , . . . , WÃÉt to be i.i.d. with distribution FŒ∏œÑ . Then
Ô£´
PÔ£≠

Ô£∂
1X
t

Z

Z
Wj ‚â• œÑ Ô£∏ =

j‚àà[t]

1

Ô£±
Ô£≤1 X

1

Ô£±
Ô£≤1 X
Ô£≥t

j‚àà[t]

wj ‚â• œÑ

Ô£º
Ô£Ω

dFŒ∏ (w1 ) ¬∑ ¬∑ ¬∑ dFŒ∏ (wt )

Ô£æ

Ô£º
t
Ô£ΩY

wj ‚â• œÑ
exp (Œ∏wj ‚àí log œï0 (Œ∏)) dF0 (w1 ) ¬∑ ¬∑ ¬∑ dF0 (wt )
Ô£≥t
Ô£æ
j=1
j‚àà[t]
Ô£º
Ô£±



Z Ô£≤ X
t
Ô£ΩY
œï0 (Œ∏)
1
wj ‚â• œÑ
exp (Œ∏ ‚àí Œ∏œÑ )wj ‚àí log
dFŒ∏œÑ (w1 ) ¬∑ ¬∑ ¬∑ dFŒ∏œÑ (wt )
= 1
Ô£æ
Ô£≥t
log œï0 (Œ∏œÑ )
j=1
j‚àà[t]
Ô£º
Ô£´ Ô£±
Ô£´
Ô£∂Ô£∂

t
Ô£≤
Ô£Ω
X
X
œï0 (Œ∏œÑ )
1
=
E Ô£≠1
WÃÉj ‚â• œÑ exp Ô£≠‚àí(Œ∏œÑ ‚àí Œ∏)
WÃÉj Ô£∏Ô£∏ .
Ô£≥t
Ô£æ
œï0 (Œ∏)
=

j‚àà[t]

j‚àà[t]

With this change of measure we can conveniently use the central limit theorem to get a
meaningful bound. Begin by noting that
Ô£∂
Ô£´
1X
PÔ£≠
Wj ‚â• œÑ Ô£∏
t
j‚àà[t]
Ô£º
Ô£´ Ô£±
Ô£´
Ô£∂Ô£∂

t
Ô£≤
Ô£Ω
X
X
œï0 (Œ∏œÑ )
1
WÃÉj ‚àí œÑ
‚â•
E Ô£≠1 0 ‚â§ ‚àö
‚â§ 1 exp Ô£≠‚àí(Œ∏œÑ ‚àí Œ∏)
WÃÉj Ô£∏Ô£∏
Ô£≥
Ô£æ
œï0 (Œ∏)
t j‚àà[t] œÉŒ∏œÑ
j‚àà[t]
Ô£´
Ô£∂

t


X
‚àö
œï0 (Œ∏œÑ )
1
WÃÉj ‚àí œÑ
‚â•
exp ‚àí(Œ∏œÑ ‚àí Œ∏)(tœÑ + tœÉŒ∏œÑ ) P Ô£≠0 ‚â§ ‚àö
‚â§ 1Ô£∏ ,
œï0 (Œ∏)
œÉŒ∏œÑ
t
j‚àà[t]

38
where œÉŒ∏2œÑ denotes the variance of FŒ∏œÑ . By the central limit theorem we know that
1 X WÃÉj ‚àí œÑ
‚àö
t j‚àà[t] œÉŒ∏œÑ
converges in distribution to a standard normal distribution and therefore the probability in
the expression above converges to Œ¶(1) ‚àí Œ¶(0) ‚âà 0.34 > 1/4. Therefore we conclude that,
for n large enough
Ô£´
Ô£∂

t


X
‚àö
1
1
œï
(Œ∏
)
0
œÑ
PÔ£≠
Wj ‚â• œÑ Ô£∏ ‚â•
exp ‚àí(Œ∏œÑ ‚àí Œ∏)(tœÑ + tœÉŒ∏œÑ ) .
t
4 œï0 (Œ∏)
j‚àà[t]

To control the remaining terms recall that œï0 (Œª) = 1 + Œª2 /2 + O(Œª3 ) as Œª ‚Üí 0 (see Equation (30)). Note also that œÑ = Œ∏œÑ + O(Œ∏œÑ2 ), which implies (after some manipulation) that
Œ∏œÑ = œÑ + O(œÑ 2 ). Finally, note that both œÑ and Œ∏ have the same order of magnitude. Putting
all this together we conclude that

t !

œï0 (Œ∏œÑ )
t 2
log
=
œÑ ‚àí Œ∏2 + O(Œ∏3 ) .
œï0 (Œ∏)
2
‚àö
For the other term note that œÉŒ∏œÑ = 1 + o(1), and therefore œÉŒ∏œÑ / t = o(Œ∏). This implies that
‚àö

‚àí(Œ∏œÑ ‚àí Œ∏)(tœÑ + tœÉŒ∏œÑ ) = ‚àít œÑ (œÑ ‚àí Œ∏) + O(Œ∏3 ) .
In conclusion

Ô£´
PÔ£≠

Ô£∂

1X
t

j‚àà[t]




t
1
2
3
Ô£∏
Wj ‚â• œÑ ‚â• exp ‚àí (œÑ ‚àí Œ∏) + O(Œ∏ )
.
4
2

When t = œâ(log3 n) the term (œÑ ‚àí Œ∏)2 term dominates, and we see we get the asymptotic
behavior as in the upper bound, concluding the proof.

 P
For the case r ‚â• q we see that necessarily P 1t j‚àà[t] Wj ‚â• œÑ ‚â• no(1) , so the tail probability
cannot be extremely small. In fact, when r > q this probability will be lower bounded by a
constant.

39

A
A.1

Appendix
Proof of Proposition 1

Proof. For convenience, define |S| = s. The first statement in the proposition is a simple
consequence of Chebyshev‚Äôs inequality. Under the null hypothesis Nq (X) ‚àº Binomial(n, pq ),
therefore
!
Nq (X) ‚àí npq
‚â• hn
P‚àÖ (Vq (X) ‚â• hn ) = P‚àÖ p
npq (1 ‚àí pq )


q
= P Nq (X) ‚àí npq ‚â• hn npq (1 ‚àí pq )


q
‚â§ P |Nq (X) ‚àí npq | ‚â• hn npq (1 ‚àí pq )
‚â§

1
.
h2n

Since hn ‚Üí ‚àû the statement of the proposition follows.
Consider first the sparse regime 1/2 < Œ≤ < 1. Under the alternative hypothesis Nq (X) is
a sum of two independent binomial random variables, that is, Nq (X) ‚àº Bin(n ‚àí s, pq ) +
Bin(s, vq ). Each of the variables corresponds respectively
to the counts of the null and
p
anomalous stream means exceeding the threshold 2q log(n), where
p
‚àö 
‚àö
2 log(n)( q ‚àí r) .
vq = 1 ‚àí Œ¶
In words, vq is the probability an anomalous stream mean exceeds the threshold
For convenience of presentation define also
q
an ‚â° s(vq ‚àí pq ) ‚àí hn npq (1 ‚àí pq ) .

p
2q log(n).

Using this definition we see that


q
PS (Vq (X) < hn ) = PS Nq (X) ‚â§ hn npq (1 ‚àí pq ) + npq


q
= PS Nq (X) ‚àí E (Nq (X)) ‚â§ hn npq (1 ‚àí pq ) + s(pq ‚àí vq )
= PS (Nq (X) ‚àí E (Nq (X)) ‚â§ ‚àían )
= PS (‚àí (Nq (X) ‚àí E (Nq (X))) ‚â• an )
‚â§ PS (|Nq (X) ‚àí E (Nq (X))| ‚â• an ) .

(31)

When an > 0 we can easily bound the above expression using Chebyshev‚Äôs inequality. To
make the presentation and derivations clear and simple we make use of asymptotic notation.

40
All the statements below are taken when n ‚Üí ‚àû. Using Lemma 1
Ô£± ‚àö ‚àö 2
‚àí( q‚àí r) +o(1)
Ô£¥
Ô£≤n
pq = n‚àíq+o(1)
and
vq = 21
‚àö ‚àö 2
Ô£¥
Ô£≥
1 ‚àí n‚àí( r‚àí q) +o(1)
Now, since hn = no(1) , we have that an is given by:
(
‚àö ‚àö 2
1‚àíq
n1‚àíŒ≤‚àí( q‚àí r) +o(1) ‚àí nmax{ 2 ,1‚àíŒ≤‚àíq}+o(1)
‚àö ‚àö 2
an =
1‚àíq
n1‚àíŒ≤+o(1) ‚àí nmax{ 2 ,1‚àíŒ≤‚àíq,1‚àíŒ≤‚àí( q‚àí r) }+o(1)

we see that
if r < q
if r = q .
if r > q

(32)

if r < q
.
if r ‚â• q

(33)

We can now easily retrieve the conditions under which an > 0 for large enough n, namely
the exponent of the positive terms must be larger than the exponent of the negative terms in
the right-hand-side of Equation (33). As an differs depending on whether r < q or r ‚â• q we
obtain a different set of conditions of each of these cases. However, many of such conditions
are satisfied trivially, and for each case we obtain only one single nontrivial condition:
‚àö
1‚àíq
‚àö
;
If r < q then an ‚Üí ‚àû provided 1 ‚àí Œ≤ ‚àí ( q ‚àí r)2 >
2
1‚àíq
.
If r ‚â• q then an ‚Üí ‚àû provided 1 ‚àí Œ≤ >
2

(34)
(35)

Under these conditions we can continue from (31) via Chebyshev‚Äôs inequality and obtain
PS (Vq (X) < hn ) ‚â§

Var (Nq (X))
.
a2n

To analyze the bound, first observe that
Var (Nq (X)) = (n ‚àí s)pq (1 ‚àí pq ) + svq (1 ‚àí vq ) ‚â§ npq + svq (1 ‚àí vq ).
Note that vq and 1 ‚àí vq are equal for r < q and r > q respectively, and thus vq (1 ‚àí vq ) is
equal for both cases asymptotically.
Moreover, the‚àöcase
r = q can be merged with r 6= q
‚àö 2
‚àö ‚àö 2
by observing that 41 n1‚àíŒ≤ = 14 n1‚àíŒ≤‚àí( q‚àí r) = n1‚àíŒ≤‚àí( q‚àí r) +o(1) . We therefore obtain for all
r > 0:
‚àö ‚àö 2
Var (Nq (X)) = nmax{1‚àíq,1‚àíŒ≤‚àí( q‚àí r) }+o(1) .
Consequently
(
‚àö ‚àö 2
‚àö ‚àö 2
nmax{1‚àíq,1‚àíŒ≤‚àí( q‚àí r) }‚àí2(1‚àíŒ≤‚àí( q‚àí r) )+o(1)
‚àö ‚àö 2
PS (Vq (X) < hn ) ‚â§
nmax{1‚àíq,1‚àíŒ≤‚àí( q‚àí r) }‚àí2(1‚àíŒ≤)+o(1)

if r < q,
if r ‚â• q.

All that needs to be done at this point is to identify under which conditions the above bound
converges to zero. Clearly, when r ‚â• q this is the case. If r ‚â§ q we require that:
‚àö
‚àö
1 ‚àí q ‚àí 2(1 ‚àí Œ≤ ‚àí ( q ‚àí r)2 ) < 0 and
(36)
‚àö 2
‚àö
1 ‚àí Œ≤ ‚àí ( q ‚àí r) > 0 .
(37)

41
Therefore, for the results in the proposition to hold we require that conditions (34), (35), (36)
and (37) are simultaneously satisfied. We can easily see that (34) and (36) are equivalent.
After rewriting condition (36) slightly, we are then left with the following three conditions:
1‚àíq
.
2
‚àö
1‚àíq
‚àö
if r < q, then 1 ‚àí Œ≤ ‚àí ( q ‚àí r)2 >
,
2
‚àö
‚àö
if r < q, then 1 ‚àí Œ≤ ‚àí ( q ‚àí r)2 > 0.

if r ‚â• q, then 1 ‚àí Œ≤ >

(38)
(39)
(40)

At this point it is a matter of algebra to check these conditions are satisfied for the statements
in the proposition. Note that we do not provide results for Œ≤ = 1, as this would require taking
q > 1.

A.2

Proof of Proposition 2

Proof. Consider first the analysis under the null hypothesis. A simple application of the
result in Proposition 1 and a union of events bound yields
X
P‚àÖ (T (X) ‚â• hn ) =
P‚àÖ (Vq (X) ‚â• hn )
q‚ààQ

‚â§

kn + 1
‚Üí0,
h2n

where the last statement follows from the assumptions on hn and kn .
Now we turn our attention to the alternative hypothesis, and must show that
PS (T (X) ‚â• hn ) ‚Üí 1 ,
as n ‚Üí ‚àû, under the conditions in the theorem for r and Œ≤. For the regimes where the
choices q = 0 or q = 1 are optimal it is straightforward to ensure that PS (Vq ‚â• hn ) ‚Üí 1, so
the theorem result is obviously true. For instance,


PS max Vq (X) ‚â• hn ‚â• PS (V1 ‚â• hn ) ‚Üí 1
q‚ààQ

p
‚àö
provided ¬µ = 2r log(n) and r > (1 ‚àí 1 ‚àí Œ≤)2 . Likewise a similar argument holds in the
dense case, where the choice q = 0 is the best one.
The only situation that is slightly more intricate is that when we must consider the choice
q = 4r, as in general that value is not in the grid Q. However, since kn ‚Üí
p ‚àû we will be able
to find a value in Q that is close enough to 4r. Consider the case ¬µ = 2r log(n), r < 1/4
and r > Œ≤ ‚àí1/2. Let q ‚àó = minq‚ààQ |4r ‚àíq|. Clearly |q ‚àó ‚àí4r| ‚â§ k1n so q ‚àó = 4r +o(1). Therefore
pq‚àó = n‚àí4r+o(1) and vq‚àó = n‚àír+o(1) and we can follow exactly the same steps as in the proof
of Proposition 1. Therefore


PS max Vq (X) ‚â• hn ‚â• PS (Vq‚àó ‚â• hn ) ‚Üí 1 ,
q‚ààQ

which is what we wanted to show.

42

A.3

Statement and proof regarding Remark 4

The following lemma formalized the equivalence between the traditional higher-criticism
statistic as in (7) and the Vq (X) statistic introduced in (9).
Lemma 7.

)
(
i
‚àö
‚àí
p
(i)
np n
,
sup {Vq (X)} = max
i‚àà[i+ ]
p(i) (1 ‚àí p(i) )
q‚àà[0,‚àû)

(41)

where i+ is the largest value of i for which p(i) < 1/2.
The proof follows by noting that the supremum of Vq (X) is attained at a finite number of
points. This result is essentially stated in Donoho and Jin (2004) but without a complete
proof. Note that the right-hand-side is not entirely equal to the higher criticism statistic, but
it is very similar (particularly when taking Œ±0 = 1/2, which is a common recommendation).
Taking Œ±0 means that essentially almost all streams that have p-values larger than 1/2 will
be ignored.
Proof. We show our assertion (41) in two steps. First, we will show that the supremum of
Vq (X) is attained at a finite number of points. We will then show that the maximum of these
points equals the HC statistic, if Œ±0 is chosen appropriately. For ease of notation, define:
hi (p) =

‚àö

i
‚àíp
np n
,
p(1 ‚àí p)

such that we can succinctly write our classical higher-criticism statistic as the maximum over
hi (p(i) ):
)
(
i

‚àö
‚àí
p
(i)
max
np n
= max hi (p(i) )
i‚àà[n]
i‚àà[n]
p(i) (1 ‚àí p(i) )
To start, define:
2

tX i
.
qi =
2 log(n)
for all Yi > 0. Denote X (i) the ordered stream means, with X (1) being the largest. Note that
qi is monotone in Yi > 0, and thus the ordering is preserved.
Note that Nq (X) is a stepwise, nonincreasing function in q, constant on intervals (q(i) , q(i+1) ].
Next, note that Vq (X) is decreasing in pq , and pq is decreasing in q. Therefore, as Nq (X) is
constant on (q(i) , q(i+1) ], Vq (X) is increasing on (q(i) , q(i+1) ].
Finally, as Nq (X) is nonincreasing, Vq(i) (X) ‚â• Vq(i) +Œ¥ (X). Therefore, the supremum of Vq (X)
must be attained at the points qi .
Now, note that Nq(i) (X) = i and pq(i) = p(i) , and thus Vq(i) = hi (p(i) ). However, we only have
these q(i) defined for Yi > 0, so:

sup {Vq (X)} = max{Vq(i) } = max hi (p(i) ) ,
q‚àà[0,‚àû)

where i+ = arg mini‚àà[n] {Yi : Yi > 0}.

i‚àà[i+ ]

i‚àà[i+ ]

43

References
Aldosari, S. A. and J. M. F. Moura (2004). Detection in decentralized sensor networks. In
2004 IEEE International Conference on Acoustics, Speech, and Signal Processing, Volume 2, pp. ii‚Äì277.
Arias-Castro, E., E. J. CandeÃÄs, and A. Durand (2011). Detection of an anomalous cluster
in a network. Annals of Statistics 39 (1), 278‚Äì304.
Arias-Castro, E., E. J. CandeÃÄs, and Y. Plan (2011). Global testing under sparse alternatives:
Anova, multiple comparisons and the higher criticism. Annals of Statistics 39 (5), 2533‚Äì
2556.
Arias-Castro, E., R. M. Castro, E. TaÃÅnczos, and M. Wang (2018). Distribution-free detection
of structured anomalies: Permutation and rank-based scans. Journal of the American
Statistical Association 113 (522), 789‚Äì801.
Arias-Castro, E. and M. Wang (2017). Distribution-free tests for sparse heterogeneous mixtures. TEST 26 (1), 71‚Äì94.
Bartroff, J. and J. Song (2016, mar). A rejection principle for sequential tests of multiple
hypotheses controlling familywise error rates. Scandinavian Journal of Statistics 43 (1),
3‚Äì19.
Benjamini, Y. and Y. Hochberg (1995). Controlling the false discovery rate: A practical and
powerful approach to multiple testing. Journal of the Royal Statistical Society. Series B
(Methodological) 57 (1), 289‚Äì300.
Berk, R. H. and D. H. Jones (1979, jan). Goodness-of-fit test statistics that dominate
the kolmogorov statistics. Zeitschrift fuÃàr Wahrscheinlichkeitstheorie und Verwandte Gebiete 47 (1), 47‚Äì59.
Delaigle, A. and P. Hall (2009). Higher criticism in the context of unknown distribution, nonindependence and classification. In Perspectives in mathematical sciences I: Probability and
statistics, pp. 109‚Äì138. World Scientific.
Delaigle, A., P. Hall, and J. Jin (2011). Robustness and accuracy of methods for high
dimensional data analysis based on student‚Äôs t-statistic. Journal of the Royal Statistical
Society. Series B: Statistical Methodology 73 (3), 283‚Äì301.
Donoho, D. and J. Jin (2004). Higher criticism for detecting sparse heterogeneous mixtures.
Annals of Statistics 32 (3), 962‚Äì994.
Donoho, D. and J. Jin (2015). Higher criticism for large-scale inference, especially for rare
and weak effects. Statistical Science 30 (1), 1‚Äì25.
Feller, W. (1968). An introduction to probability theory and its applications (3rd ed.), Volume 1. John Wiley & Sons.
Flenner, A. and G. Hewer (2011). A Helmholtz principle approach to parameter-free change
detection and coherent motion using exchangeable random variables. SIAM Journal on
Imaging Sciences 4 (1), 243‚Äì276.
Hettmansperger, T. P. (1984). Statistical inference based on ranks. Wiley Series in Probability
and Mathematical Statistics: Probability and Mathematical Statistics. New York: John
Wiley & Sons, Inc.
Huang, L., M. Kulldorff, and D. Gregorio (2007). A spatial scan statistic for survival data.
Biometrics 63 (1), 109‚Äì118.
Ingster, Y. I. (1997). Some problems of hypothesis testing leading to infinitely divisible

44
distributions. Mathematical Methods of Statistics 6 (1), 47‚Äì69.
Joag-Dev, K. and F. Proschan (1983). Negative association of random variables with applications. Annals of Statistics 11 (1), 286‚Äì295.
Kulldorff, M., R. Heffernan, J. Hartman, R. Assuncao, and F. Mostashari (2005). A spacetime permutation scan statistic for disease outbreak detection. PLOS Medicine 2 (3),
216.
Kulldorff, M., L. Huang, and K. Konty (2009). A scan statistic for continuous data based
on the normal probability model. International journal of health geographics 8 (1), 1‚Äì9.
Kurt, M. N., Y. Yilmaz, and X. Wang (2020, jan). Real-time nonparametric anomaly detection in high-dimensional settings. IEEE Transactions on Pattern Analysis and Machine
Intelligence, (online).
Lauer, S. A., K. H. Grantz, Q. Bi, F. K. Jones, Q. Zheng, H. R. Meredith, A. S. Azman,
N. G. Reich, and J. Lessler (2020, may). The incubation period of coronavirus disease
2019 (COVID-19) from publicly reported confirmed cases: Estimation and application.
Annals of Internal Medicine 172 (9), 577‚Äì582.
Lehmann, E. L. and J. P. Romano (2005). Testing statistical hypotheses (3rd ed.). Springer
Texts in Statistics. New York: Springer.
Lexa, M. A., C. J. Rozell, S. Sinanovic, and D. H. Johnson (2004, may). To cooperate or
not to cooperate: detection strategies in sensor networks. Acoustics, Speech, and Signal
Processing, 2004. Proceedings. (ICASSP ‚Äô04). IEEE International Conference on 3, 841‚Äì
844.
Mei, Y. (2008). Asymptotic optimality theory for decentralized sequential hypothesis testing
in sensor networks. IEEE Transactions on Information Theory 54 (5), 2072‚Äì2089.
Mikosch, T. and A. V. Nagaev (1998). Large deviations of heavy-tailed sums with applications in insurance. Extremes 1 (1), 81‚Äì110.
Nichols, T. E. and A. P. Holmes (2002). Nonparametric permutation tests for functional
neuroimaging: a primer with examples. Human Brain Mapping 15 (1), 1‚Äì25.
Patwari, N. and A. O. Hero (2003, apr). Hierarchical censoring for distributed detection
in wireless sensor networks. Acoustics, Speech, and Signal Processing, 2003. Proceedings.
(ICASSP ‚Äô03). 2003 IEEE International Conference on 4, 848‚Äì851.
Romano, J., A. Shaikh, and M. Wolf (2008, 12). Control of the false discovery rate under
dependence using the bootstrap and subsampling. TEST 17, 417‚Äì442.
Romano, J. P. and M. Wolf (2007, aug). Control of generalized error rates in multiple testing.
Annals of Statistics 35 (4), 1378‚Äì1408.
Sabatti, C., S. K. Service, A. L. Hartikainen, A. Pouta, S. Ripatti, J. Brodsky, C. G. Jones,
N. A. Zaitlen, T. Varilo, M. Kaakinen, U. Sovio, A. Ruokonen, J. Laitinen, E. Jakkula,
L. Coin, C. Hoggart, A. Collins, H. Turunen, S. Gabriel, P. Elliot, M. I. McCarthy, M. J.
Daly, M. R. JaÃàrvelin, N. B. Freimer, and L. Peltonen (2009, jan). Genome-wide association analysis of metabolic traits in a birth cohort from a founder population. Nature
Genetics 41 (1), 35‚Äì46.
Shorack, G. R. and J. A. Wellner (1986). Empirical processes with applications to statistics.
Wiley Series in Probability and Mathematical Statistics: Probability and Mathematical
Statistics. New York: John Wiley & Sons Inc.
Thomopoulos, S. C. A., R. Viswanathan, and D. K. Bougoulias (1989, sep). Optimal distributed decision fusion. Aerospace and Electronic Systems, IEEE Transactions on 25 (5),

45
761‚Äì765.
Walther, G. (2010). Optimal and fast detection of spatial clusters with scan statistics. Annals
of Statistics 38 (2), 1010‚Äì1033.
Wu, Z., Y. Sun, S. He, J. Cho, H. Zhao, and J. Jin (2014). Detection boundary and higher
criticism approach for rare and weak genetic effects. Annals of Applied Statistics 8 (2),
824‚Äì851.
Yu, L., L. Yuan, G. Qu, and A. Ephremides (2006, apr). Energy-driven detection scheme
with guaranteed accuracy. Information Processing in Sensor Networks, 2006. IPSN 2006.
The Fifth International Conference on, 284‚Äì291.
Zou, S., Y. Liang, H. V. Poor, and X. Shi (2017). Nonparametric detection of anomalous
data streams. IEEE Transactions on Signal Processing 65 (21), 5785‚Äì5797.

